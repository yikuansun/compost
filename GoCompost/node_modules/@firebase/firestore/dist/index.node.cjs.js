"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var firebase=_interopDefault(require("@firebase/app")),tslib=require("tslib"),logger=require("@firebase/logger"),util=require("@firebase/util"),component=require("@firebase/component"),__PRIVATE_util=require("util"),__PRIVATE_grpc=require("grpc"),__PRIVATE_protoLoader=require("@grpc/proto-loader"),path=require("path");require("protobufjs");var LogLevel,SDK_VERSION=firebase.SDK_VERSION,__PRIVATE_logClient=new logger.Logger("@firebase/firestore");function __PRIVATE_getLogLevel(){return __PRIVATE_logClient.logLevel===logger.LogLevel.DEBUG?LogLevel.DEBUG:__PRIVATE_logClient.logLevel===logger.LogLevel.SILENT?LogLevel.SILENT:LogLevel.ERROR}function setLogLevel(t){switch(t){case LogLevel.DEBUG:__PRIVATE_logClient.logLevel=logger.LogLevel.DEBUG;break;case LogLevel.ERROR:__PRIVATE_logClient.logLevel=logger.LogLevel.ERROR;break;case LogLevel.SILENT:__PRIVATE_logClient.logLevel=logger.LogLevel.SILENT;break;default:__PRIVATE_logClient.error("Firestore ("+SDK_VERSION+"): Invalid value passed to `setLogLevel`")}}function debug(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(__PRIVATE_logClient.logLevel<=logger.LogLevel.DEBUG){var i=n.map(__PRIVATE_argToString);__PRIVATE_logClient.debug.apply(__PRIVATE_logClient,tslib.__spreadArrays(["Firestore ("+SDK_VERSION+") ["+t+"]: "+e],i))}}function error(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(__PRIVATE_logClient.logLevel<=logger.LogLevel.ERROR){var r=e.map(__PRIVATE_argToString);__PRIVATE_logClient.error.apply(__PRIVATE_logClient,tslib.__spreadArrays(["Firestore ("+SDK_VERSION+"): "+t],r))}}function __PRIVATE_argToString(t){if("string"==typeof t)return t;var e=__PRIVATE_PlatformSupport.t();try{return e.i(t)}catch(e){return t}}function fail(t){var e="FIRESTORE ("+SDK_VERSION+") INTERNAL ASSERTION FAILED: "+t;throw error(e),new Error(e)}function assert(t,e){t||fail(e)}!function(t){t[t.DEBUG=0]="DEBUG",t[t.ERROR=1]="ERROR",t[t.SILENT=2]="SILENT"}(LogLevel||(LogLevel={}));var __PRIVATE_AutoId=function(){function t(){}return t.s=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return assert(20===e.length,"Invalid auto ID: "+e),e},t}();function __PRIVATE_primitiveComparator(t,e){return t<e?-1:t>e?1:0}function equals(t,e){return null!=t?!(!e||!t.isEqual(e)):t===e}function __PRIVATE_arrayEquals(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function __PRIVATE_immediateSuccessor(t){return t+"\0"}var __PRIVATE_OnlineState,__PRIVATE_OnlineStateSource,__PRIVATE_DatabaseInfo=function(t,e,n,r,i){this.o=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i},__PRIVATE_DEFAULT_DATABASE_NAME="(default)",__PRIVATE_DatabaseId=function(){function t(t,e){this.projectId=t,this.database=e||__PRIVATE_DEFAULT_DATABASE_NAME}return Object.defineProperty(t.prototype,"u",{get:function(){return this.database===__PRIVATE_DEFAULT_DATABASE_NAME},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return e instanceof t&&e.projectId===this.projectId&&e.database===this.database},t.prototype._=function(t){return __PRIVATE_primitiveComparator(this.projectId,t.projectId)||__PRIVATE_primitiveComparator(this.database,t.database)},t}();!function(t){t[t.h=0]="__PRIVATE_Unknown",t[t.l=1]="__PRIVATE_Online",t[t.T=2]="__PRIVATE_Offline"}(__PRIVATE_OnlineState||(__PRIVATE_OnlineState={})),function(t){t[t.P=0]="__PRIVATE_RemoteStore",t[t.A=1]="__PRIVATE_SharedClientState"}(__PRIVATE_OnlineStateSource||(__PRIVATE_OnlineStateSource={}));var User=function(){function t(t){this.uid=t}return t.prototype.R=function(){return null!=this.uid},t.prototype.I=function(){return this.R()?"uid:"+this.uid:"anonymous-user"},t.prototype.isEqual=function(t){return t.uid===this.uid},t.UNAUTHENTICATED=new t(null),t.V=new t("google-credentials-uid"),t.m=new t("first-party-uid"),t}(),Code={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},FirestoreError=function(t){function e(e,n){var r=t.call(this,n)||this;return r.code=e,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return tslib.__extends(e,t),e}(Error),__PRIVATE_OAuthToken=function(t,e){this.user=e,this.type="OAuth",this.v={},this.v.Authorization="Bearer "+t},__PRIVATE_EmptyCredentialsProvider=function(){function t(){this.p=null}return t.prototype.getToken=function(){return Promise.resolve(null)},t.prototype.g=function(){},t.prototype.S=function(t){assert(!this.p,"Can only call setChangeListener() once."),this.p=t,t(User.UNAUTHENTICATED)},t.prototype.D=function(){assert(null!==this.p,"removeChangeListener() when no listener registered"),this.p=null},t}(),__PRIVATE_FirebaseCredentialsProvider=function(){function t(t){var e=this;this.C=null,this.currentUser=User.UNAUTHENTICATED,this.O=!1,this.F=0,this.p=null,this.forceRefresh=!1,this.C=function(){e.F++,e.currentUser=e.N(),e.O=!0,e.p&&e.p(e.currentUser)},this.F=0,this.auth=t.getImmediate({optional:!0}),this.auth?this.auth.addAuthTokenListener(this.C):(this.C(null),t.get().then((function(t){e.auth=t,e.C&&e.auth.addAuthTokenListener(e.C)}),(function(){})))}return t.prototype.getToken=function(){var t=this;assert(null!=this.C,"getToken cannot be called after listener removed.");var e=this.F,n=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(n).then((function(n){if(t.F!==e)throw new FirestoreError(Code.ABORTED,"getToken aborted due to token change.");return n?(assert("string"==typeof n.accessToken,"Invalid tokenData returned from getToken():"+n),new __PRIVATE_OAuthToken(n.accessToken,t.currentUser)):null})):Promise.resolve(null)},t.prototype.g=function(){this.forceRefresh=!0},t.prototype.S=function(t){assert(!this.p,"Can only call setChangeListener() once."),this.p=t,this.O&&t(this.currentUser)},t.prototype.D=function(){assert(null!=this.C,"removeChangeListener() called twice"),assert(null!==this.p,"removeChangeListener() called when no listener registered"),this.auth&&this.auth.removeAuthTokenListener(this.C),this.C=null,this.p=null},t.prototype.N=function(){var t=this.auth&&this.auth.getUid();return assert(null===t||"string"==typeof t,"Received invalid UID: "+t),new User(t)},t}(),__PRIVATE_FirstPartyToken=function(){function t(t,e){this.M=t,this.L=e,this.type="FirstParty",this.user=User.m}return Object.defineProperty(t.prototype,"v",{get:function(){var t={"X-Goog-AuthUser":this.L},e=this.M.auth.G([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),t}(),__PRIVATE_FirstPartyCredentialsProvider=function(){function t(t,e){this.M=t,this.L=e}return t.prototype.getToken=function(){return Promise.resolve(new __PRIVATE_FirstPartyToken(this.M,this.L))},t.prototype.S=function(t){t(User.m)},t.prototype.D=function(){},t.prototype.g=function(){},t}();function __PRIVATE_makeCredentialsProvider(t){if(!t)return new __PRIVATE_EmptyCredentialsProvider;switch(t.type){case"gapi":var e=t.B;return assert(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new __PRIVATE_FirstPartyCredentialsProvider(e,t.L||"0");case"provider":return t.B;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}function contains(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function __PRIVATE_defaulted(t,e){return void 0!==t?t:e}function __PRIVATE_forEachNumber(t,e){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=Number(n);isNaN(r)||e(r,t[n])}}function values(t){var e=[];return forEach(t,(function(t,n){return e.push(n)})),e}function forEach(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function __PRIVATE_isEmpty(t){for(var e in assert(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function __PRIVATE_shallowCopy(t){assert(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}function __PRIVATE_validateNoArgs(t,e){if(0!==e.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+__PRIVATE_formatPlural(e.length,"argument")+".")}function __PRIVATE_validateExactNumberOfArgs(t,e,n){if(e.length!==n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires "+__PRIVATE_formatPlural(n,"argument")+", but was called with "+__PRIVATE_formatPlural(e.length,"argument")+".")}function __PRIVATE_validateAtLeastNumberOfArgs(t,e,n){if(e.length<n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires at least "+__PRIVATE_formatPlural(n,"argument")+", but was called with "+__PRIVATE_formatPlural(e.length,"argument")+".")}function __PRIVATE_validateBetweenNumberOfArgs(t,e,n,r){if(e.length<n||e.length>r)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+__PRIVATE_formatPlural(e.length,"argument")+".")}function __PRIVATE_validateNamedArrayAtLeastNumberOfElements(t,e,n,r){if(!(e instanceof Array)||e.length<r)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" argument to be an array with at least "+__PRIVATE_formatPlural(r,"element")+".")}function __PRIVATE_validateArgType(t,e,n,r){__PRIVATE_validateType(t,e,__PRIVATE_ordinal(n)+" argument",r)}function __PRIVATE_validateOptionalArgType(t,e,n,r){void 0!==r&&__PRIVATE_validateArgType(t,e,n,r)}function __PRIVATE_validateNamedType(t,e,n,r){__PRIVATE_validateType(t,e,n+" option",r)}function __PRIVATE_validateNamedOptionalType(t,e,n,r){void 0!==r&&__PRIVATE_validateNamedType(t,e,n,r)}function __PRIVATE_validateArrayElements(t,e,n,r,i){if(!(r instanceof Array))throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+__PRIVATE_valueDescription(r));for(var s=0;s<r.length;++s)if(!i(r[s]))throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+s+" was: "+__PRIVATE_valueDescription(r[s]))}function __PRIVATE_validateOptionalArrayElements(t,e,n,r,i){void 0!==r&&__PRIVATE_validateArrayElements(t,e,n,r,i)}function __PRIVATE_validateNamedPropertyEquals(t,e,n,r,i){for(var s=[],o=0,u=i;o<u.length;o++){var a=u[o];if(a===r)return;s.push(__PRIVATE_valueDescription(a))}var _=__PRIVATE_valueDescription(r);throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid value "+_+" provided to function "+t+'() for option "'+n+'". Acceptable values: '+s.join(", "))}function __PRIVATE_validateNamedOptionalPropertyEquals(t,e,n,r,i){void 0!==r&&__PRIVATE_validateNamedPropertyEquals(t,e,n,r,i)}function __PRIVATE_validateStringEnum(t,e,n,r){if(!e.some((function(t){return t===r})))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid value "+__PRIVATE_valueDescription(r)+" provided to function "+t+"() for its "+__PRIVATE_ordinal(n)+" argument. Acceptable values: "+e.join(", "))}function __PRIVATE_validateType(t,e,n,r){if(!("object"===e?__PRIVATE_isPlainObject(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){var i=__PRIVATE_valueDescription(r);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+i)}}function __PRIVATE_isPlainObject(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function __PRIVATE_valueDescription(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";var e=__PRIVATE_tryGetCustomObjectType(t);return e?"a custom "+e+" object":"an object"}return"function"==typeof t?"a function":fail("Unknown wrong type: "+typeof t)}function __PRIVATE_tryGetCustomObjectType(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&e.length>1)return e[1]}return null}function __PRIVATE_validateDefined(t,e,n){if(void 0===n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+__PRIVATE_ordinal(e)+" argument, but it was undefined.")}function __PRIVATE_validateOptionNames(t,e,n){forEach(e,(function(e,r){if(n.indexOf(e)<0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Unknown option '"+e+"' passed to function "+t+"(). Available options: "+n.join(", "))}))}function __PRIVATE_invalidClassError(t,e,n,r){var i=__PRIVATE_valueDescription(r);return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() requires its "+__PRIVATE_ordinal(n)+" argument to be a "+e+", but it was: "+i)}function __PRIVATE_validatePositiveNumber(t,e,n){if(n<=0)throw new FirestoreError(Code.INVALID_ARGUMENT,'Function "'+t+'()" requires its '+__PRIVATE_ordinal(e)+" argument to be a positive number, but it was: "+n+".")}function __PRIVATE_ordinal(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function __PRIVATE_formatPlural(t,e){return t+" "+e+(1===t?"":"s")}var GeoPoint=function(){function t(t,e){if(__PRIVATE_validateExactNumberOfArgs("GeoPoint",arguments,2),__PRIVATE_validateArgType("GeoPoint","number",1,t),__PRIVATE_validateArgType("GeoPoint","number",2,e),!isFinite(t)||t<-90||t>90)throw new FirestoreError(Code.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new FirestoreError(Code.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this.U=t,this.k=e}return Object.defineProperty(t.prototype,"latitude",{get:function(){return this.U},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"longitude",{get:function(){return this.k},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this.U===t.U&&this.k===t.k},t.prototype.K=function(t){return __PRIVATE_primitiveComparator(this.U,t.U)||__PRIVATE_primitiveComparator(this.k,t.k)},t}(),Timestamp=function(){function t(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return t.now=function(){return t.fromMillis(Date.now())},t.fromDate=function(e){return t.fromMillis(e.getTime())},t.fromMillis=function(e){var n=Math.floor(e/1e3);return new t(n,1e6*(e-1e3*n))},t.prototype.toDate=function(){return new Date(this.toMillis())},t.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},t.prototype.K=function(t){return this.seconds===t.seconds?__PRIVATE_primitiveComparator(this.nanoseconds,t.nanoseconds):__PRIVATE_primitiveComparator(this.seconds,t.seconds)},t.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},t.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},t}(),__PRIVATE_SnapshotVersion=function(){function t(t){this.timestamp=t}return t.q=function(e){var n=Math.floor(e/1e6);return new t(new Timestamp(n,e%1e6*1e3))},t.j=function(e){return new t(e)},t.W=function(){return t.MIN},t.prototype._=function(t){return this.timestamp.K(t.timestamp)},t.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},t.prototype.$=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},t.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},t.prototype.Y=function(){return this.timestamp},t.MIN=new t(new Timestamp(0,0)),t}(),__PRIVATE_DOCUMENT_KEY_NAME="__name__",__PRIVATE_BasePath=function(){function t(t,e,n){void 0===e?e=0:e>t.length&&fail("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&fail("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n}return Object.defineProperty(t.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return 0===t.H(this,e)},t.prototype.child=function(e){var n=this.segments.slice(this.offset,this.limit());return e instanceof t?e.forEach((function(t){n.push(t)})):n.push(e),this.X(n)},t.prototype.limit=function(){return this.offset+this.length},t.prototype.J=function(t){return t=void 0===t?1:t,assert(this.length>=t,"Can't call popFirst() with less segments"),this.X(this.segments,this.offset+t,this.length-t)},t.prototype.Z=function(){return assert(!this.tt(),"Can't call popLast() on empty path"),this.X(this.segments,this.offset,this.length-1)},t.prototype.et=function(){return assert(!this.tt(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},t.prototype.nt=function(){return this.get(this.length-1)},t.prototype.get=function(t){return assert(t<this.length,"Index out of range"),this.segments[this.offset+t]},t.prototype.tt=function(){return 0===this.length},t.prototype.rt=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.it=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},t.prototype.st=function(){return this.segments.slice(this.offset,this.limit())},t.H=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),s=e.get(r);if(i<s)return-1;if(i>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0},t}(),ResourcePath=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return tslib.__extends(e,t),e.prototype.X=function(t,n,r){return new e(t,n,r)},e.prototype.ot=function(){return this.st().join("/")},e.prototype.toString=function(){return this.ot()},e.ut=function(t){if(t.indexOf("//")>=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new e(t.split("/").filter((function(t){return t.length>0})))},e.at=new e([]),e}(__PRIVATE_BasePath),__PRIVATE_identifierRegExp=/^[_a-zA-Z][_a-zA-Z0-9]*$/,FieldPath=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return tslib.__extends(e,t),e.prototype.X=function(t,n,r){return new e(t,n,r)},e._t=function(t){return __PRIVATE_identifierRegExp.test(t)},e.prototype.ot=function(){return this.st().map((function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),e._t(t)||(t="`"+t+"`"),t})).join(".")},e.prototype.toString=function(){return this.ot()},e.prototype.ct=function(){return 1===this.length&&this.get(0)===__PRIVATE_DOCUMENT_KEY_NAME},e.ht=function(){return new e([__PRIVATE_DOCUMENT_KEY_NAME])},e.ft=function(t){for(var n=[],r="",i=0,s=function(){if(0===r.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");n.push(r),r=""},o=!1;i<t.length;){var u=t[i];if("\\"===u){if(i+1===t.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var a=t[i+1];if("\\"!==a&&"."!==a&&"`"!==a)throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);r+=a,i+=2}else"`"===u?(o=!o,i++):"."!==u||o?(r+=u,i++):(s(),i++)}if(s(),o)throw new FirestoreError(Code.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new e(n)},e.at=new e([]),e}(__PRIVATE_BasePath),__PRIVATE_DocumentKey=function(){function t(e){this.path=e,assert(t.lt(e),"Invalid DocumentKey with an odd number of segments: "+e.st().join("/"))}return t.prototype.Tt=function(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t},t.prototype.isEqual=function(t){return null!==t&&0===ResourcePath.H(this.path,t.path)},t.prototype.toString=function(){return this.path.toString()},t.H=function(t,e){return ResourcePath.H(t.path,e.path)},t.lt=function(t){return t.length%2==0},t.dt=function(e){return new t(new ResourcePath(e.slice()))},t.Et=function(e){return new t(ResourcePath.ut(e))},t.EMPTY=new t(new ResourcePath([])),t}(),__PRIVATE_SortedMap=function(){function t(t,e){this.H=t,this.root=e||__PRIVATE_LLRBNode.EMPTY}return t.prototype.Pt=function(e,n){return new t(this.H,this.root.Pt(e,n,this.H).copy(null,null,__PRIVATE_LLRBNode.At,null,null))},t.prototype.remove=function(e){return new t(this.H,this.root.remove(e,this.H).copy(null,null,__PRIVATE_LLRBNode.At,null,null))},t.prototype.get=function(t){for(var e=this.root;!e.tt();){var n=this.H(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null},t.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.tt();){var r=this.H(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1},t.prototype.tt=function(){return this.root.tt()},Object.defineProperty(t.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),t.prototype.Rt=function(){return this.root.Rt()},t.prototype.It=function(){return this.root.It()},t.prototype.Vt=function(t){return this.root.Vt(t)},t.prototype.forEach=function(t){this.Vt((function(e,n){return t(e,n),!1}))},t.prototype.toString=function(){var t=[];return this.Vt((function(e,n){return t.push(e+":"+n),!1})),"{"+t.join(", ")+"}"},t.prototype.vt=function(t){return this.root.vt(t)},t.prototype.pt=function(){return new __PRIVATE_SortedMapIterator(this.root,null,this.H,!1)},t.prototype.bt=function(t){return new __PRIVATE_SortedMapIterator(this.root,t,this.H,!1)},t.prototype.gt=function(){return new __PRIVATE_SortedMapIterator(this.root,null,this.H,!0)},t.prototype.wt=function(t){return new __PRIVATE_SortedMapIterator(this.root,t,this.H,!0)},t}(),__PRIVATE_SortedMapIterator=function(){function t(t,e,n,r){this.yt=r,this.St=[];for(var i=1;!t.tt();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.yt?t.left:t.right;else{if(0===i){this.St.push(t);break}this.St.push(t),t=this.yt?t.right:t.left}}return t.prototype.Dt=function(){assert(this.St.length>0,"getNext() called on iterator when hasNext() is false.");var t=this.St.pop(),e={key:t.key,value:t.value};if(this.yt)for(t=t.left;!t.tt();)this.St.push(t),t=t.right;else for(t=t.right;!t.tt();)this.St.push(t),t=t.left;return e},t.prototype.Ct=function(){return this.St.length>0},t.prototype.Ot=function(){if(0===this.St.length)return null;var t=this.St[this.St.length-1];return{key:t.key,value:t.value}},t}(),__PRIVATE_LLRBNode=function(){function t(e,n,r,i,s){this.key=e,this.value=n,this.color=null!=r?r:t.RED,this.left=null!=i?i:t.EMPTY,this.right=null!=s?s:t.EMPTY,this.size=this.left.size+1+this.right.size}return t.prototype.copy=function(e,n,r,i,s){return new t(null!=e?e:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=s?s:this.right)},t.prototype.tt=function(){return!1},t.prototype.Vt=function(t){return this.left.Vt(t)||t(this.key,this.value)||this.right.Vt(t)},t.prototype.vt=function(t){return this.right.vt(t)||t(this.key,this.value)||this.left.vt(t)},t.prototype.min=function(){return this.left.tt()?this:this.left.min()},t.prototype.Rt=function(){return this.min().key},t.prototype.It=function(){return this.right.tt()?this.key:this.right.It()},t.prototype.Pt=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.Pt(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.Pt(t,e,n))).Ft()},t.prototype.Nt=function(){if(this.left.tt())return t.EMPTY;var e=this;return e.left.Mt()||e.left.left.Mt()||(e=e.Lt()),(e=e.copy(null,null,null,e.left.Nt(),null)).Ft()},t.prototype.remove=function(e,n){var r,i=this;if(n(e,i.key)<0)i.left.tt()||i.left.Mt()||i.left.left.Mt()||(i=i.Lt()),i=i.copy(null,null,null,i.left.remove(e,n),null);else{if(i.left.Mt()&&(i=i.Gt()),i.right.tt()||i.right.Mt()||i.right.left.Mt()||(i=i.Bt()),0===n(e,i.key)){if(i.right.tt())return t.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.Nt())}i=i.copy(null,null,null,null,i.right.remove(e,n))}return i.Ft()},t.prototype.Mt=function(){return this.color},t.prototype.Ft=function(){var t=this;return t.right.Mt()&&!t.left.Mt()&&(t=t.Ut()),t.left.Mt()&&t.left.left.Mt()&&(t=t.Gt()),t.left.Mt()&&t.right.Mt()&&(t=t.kt()),t},t.prototype.Lt=function(){var t=this.kt();return t.right.left.Mt()&&(t=(t=(t=t.copy(null,null,null,null,t.right.Gt())).Ut()).kt()),t},t.prototype.Bt=function(){var t=this.kt();return t.left.left.Mt()&&(t=(t=t.Gt()).kt()),t},t.prototype.Ut=function(){var e=this.copy(null,null,t.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},t.prototype.Gt=function(){var e=this.copy(null,null,t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},t.prototype.kt=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},t.prototype.xt=function(){var t=this.Kt();return Math.pow(2,t)<=this.size+1},t.prototype.Kt=function(){if(this.Mt()&&this.left.Mt())throw fail("Red node has red child("+this.key+","+this.value+")");if(this.right.Mt())throw fail("Right child of ("+this.key+","+this.value+") is red");var t=this.left.Kt();if(t!==this.right.Kt())throw fail("Black depths differ");return t+(this.Mt()?0:1)},t.EMPTY=null,t.RED=!0,t.At=!1,t}(),__PRIVATE_LLRBEmptyNode=function(){function t(){this.size=0}return Object.defineProperty(t.prototype,"key",{get:function(){throw fail("LLRBEmptyNode has no key.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){throw fail("LLRBEmptyNode has no value.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){throw fail("LLRBEmptyNode has no color.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"left",{get:function(){throw fail("LLRBEmptyNode has no left child.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){throw fail("LLRBEmptyNode has no right child.")},enumerable:!0,configurable:!0}),t.prototype.copy=function(t,e,n,r,i){return this},t.prototype.Pt=function(t,e,n){return new __PRIVATE_LLRBNode(t,e)},t.prototype.remove=function(t,e){return this},t.prototype.tt=function(){return!0},t.prototype.Vt=function(t){return!1},t.prototype.vt=function(t){return!1},t.prototype.Rt=function(){return null},t.prototype.It=function(){return null},t.prototype.Mt=function(){return!1},t.prototype.xt=function(){return!0},t.prototype.Kt=function(){return 0},t}();__PRIVATE_LLRBNode.EMPTY=new __PRIVATE_LLRBEmptyNode;var __PRIVATE_SortedSet=function(){function t(t){this.H=t,this.data=new __PRIVATE_SortedMap(this.H)}return t.qt=function(e){var n=new t(e.H);return e.forEach((function(t){n=n.add(t)})),n},t.prototype.has=function(t){return null!==this.data.get(t)},t.prototype.first=function(){return this.data.Rt()},t.prototype.last=function(){return this.data.It()},Object.defineProperty(t.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),t.prototype.indexOf=function(t){return this.data.indexOf(t)},t.prototype.forEach=function(t){this.data.Vt((function(e,n){return t(e),!1}))},t.prototype.jt=function(t,e){for(var n=this.data.bt(t[0]);n.Ct();){var r=n.Dt();if(this.H(r.key,t[1])>=0)return;e(r.key)}},t.prototype.Qt=function(t,e){var n;for(n=void 0!==e?this.data.bt(e):this.data.pt();n.Ct();){if(!t(n.Dt().key))return}},t.prototype.Wt=function(t){var e=this.data.bt(t);return e.Ct()?e.Dt().key:null},t.prototype.pt=function(){return new __PRIVATE_SortedSetIterator(this.data.pt())},t.prototype.bt=function(t){return new __PRIVATE_SortedSetIterator(this.data.bt(t))},t.prototype.add=function(t){return this.copy(this.data.remove(t).Pt(t,!0))},t.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},t.prototype.tt=function(){return this.data.tt()},t.prototype.$t=function(t){var e=this;return e.size<t.size&&(e=t,t=this),t.forEach((function(t){e=e.add(t)})),e},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.data.pt(),r=e.data.pt();n.Ct();){var i=n.Dt().key,s=r.Dt().key;if(0!==this.H(i,s))return!1}return!0},t.prototype.st=function(){var t=[];return this.forEach((function(e){t.push(e)})),t},t.prototype.toString=function(){var t=[];return this.forEach((function(e){return t.push(e)})),"SortedSet("+t.toString()+")"},t.prototype.copy=function(e){var n=new t(this.H);return n.data=e,n},t}(),__PRIVATE_SortedSetIterator=function(){function t(t){this.Yt=t}return t.prototype.Dt=function(){return this.Yt.Dt().key},t.prototype.Ct=function(){return this.Yt.Ct()},t}(),__PRIVATE_ServerTimestampTransform=function(){function t(){}return t.prototype.Ht=function(t,e){return new __PRIVATE_ServerTimestampValue(e,t)},t.prototype.zt=function(t,e){return e},t.prototype.Xt=function(t){return null},t.prototype.isEqual=function(e){return e instanceof t},t.instance=new t,t}(),__PRIVATE_ArrayUnionTransformOperation=function(){function t(t){this.elements=t}return t.prototype.Ht=function(t,e){return this.apply(t)},t.prototype.zt=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=__PRIVATE_coercedFieldValuesArray(t),n=function(t){e.find((function(e){return e.isEqual(t)}))||e.push(t)},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new ArrayValue(e)},t.prototype.Xt=function(t){return null},t.prototype.isEqual=function(e){return e instanceof t&&__PRIVATE_arrayEquals(e.elements,this.elements)},t}(),__PRIVATE_ArrayRemoveTransformOperation=function(){function t(t){this.elements=t}return t.prototype.Ht=function(t,e){return this.apply(t)},t.prototype.zt=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=__PRIVATE_coercedFieldValuesArray(t),n=function(t){e=e.filter((function(e){return!e.isEqual(t)}))},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new ArrayValue(e)},t.prototype.Xt=function(t){return null},t.prototype.isEqual=function(e){return e instanceof t&&__PRIVATE_arrayEquals(e.elements,this.elements)},t}(),__PRIVATE_NumericIncrementTransformOperation=function(){function t(t){this.Jt=t}return t.prototype.Ht=function(t,e){var n=this.Xt(t);if(n instanceof __PRIVATE_IntegerValue&&this.Jt instanceof __PRIVATE_IntegerValue){var r=n.Zt+this.Jt.Zt;return new __PRIVATE_IntegerValue(r)}r=n.Zt+this.Jt.Zt;return new __PRIVATE_DoubleValue(r)},t.prototype.zt=function(t,e){return assert(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},t.prototype.Xt=function(t){return t instanceof __PRIVATE_NumberValue?t:new __PRIVATE_IntegerValue(0)},t.prototype.isEqual=function(e){return e instanceof t&&this.Jt.isEqual(e.Jt)},t}();function __PRIVATE_coercedFieldValuesArray(t){return t instanceof ArrayValue?t.Zt.slice():[]}var __PRIVATE_MutationType,__PRIVATE_FieldMask=function(){function t(t){this.fields=t}return t.te=function(e){return new t(e)},t.ee=function(e){var n=new __PRIVATE_SortedSet(FieldPath.H);return e.forEach((function(t){return n=n.add(t)})),new t(n)},t.prototype.ne=function(t){var e=!1;return this.fields.forEach((function(n){n.rt(t)&&(e=!0)})),e},t.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},t}(),FieldTransform=function(){function t(t,e){this.field=t,this.transform=e}return t.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},t}(),__PRIVATE_MutationResult=function(t,e){this.version=t,this.transformResults=e};!function(t){t[t.Set=0]="Set",t[t.re=1]="__PRIVATE_Patch",t[t.Transform=2]="Transform",t[t.ie=3]="__PRIVATE_Delete",t[t.Verify=4]="Verify"}(__PRIVATE_MutationType||(__PRIVATE_MutationType={}));var __PRIVATE_TypeOrder,__PRIVATE_ServerTimestampBehavior,Precondition=function(){function t(t,e){this.updateTime=t,this.exists=e,assert(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}return t.exists=function(e){return new t(void 0,e)},t.updateTime=function(e){return new t(e)},Object.defineProperty(t.prototype,"se",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),t.prototype.oe=function(t){return void 0!==this.updateTime?t instanceof Document&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof Document:(assert(this.se,"Precondition should be empty"),!0)},t.prototype.isEqual=function(t){return equals(this.updateTime,t.updateTime)&&this.exists===t.exists},t.NONE=new t,t}(),__PRIVATE_Mutation=function(){function t(){}return t.prototype.ue=function(t){null!=t&&assert(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},t.ae=function(t){return t instanceof Document?t.version:__PRIVATE_SnapshotVersion.MIN},t}(),__PRIVATE_SetMutation=function(t){function e(e,n,r){var i=t.call(this)||this;return i.key=e,i.value=n,i._e=r,i.type=__PRIVATE_MutationType.Set,i}return tslib.__extends(e,t),e.prototype.zt=function(t,e){this.ue(t),assert(null==e.transformResults,"Transform results received by SetMutation.");var n=e.version;return new Document(this.key,n,{hasCommittedMutations:!0},this.value)},e.prototype.Ht=function(t,e,n){if(this.ue(t),!this._e.oe(t))return t;var r=__PRIVATE_Mutation.ae(t);return new Document(this.key,r,{ce:!0},this.value)},e.prototype.he=function(t){return null},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this._e.isEqual(t._e)},e}(__PRIVATE_Mutation),__PRIVATE_PatchMutation=function(t){function e(e,n,r,i){var s=t.call(this)||this;return s.key=e,s.data=n,s.fe=r,s._e=i,s.type=__PRIVATE_MutationType.re,s}return tslib.__extends(e,t),e.prototype.zt=function(t,e){if(this.ue(t),assert(null==e.transformResults,"Transform results received by PatchMutation."),!this._e.oe(t))return new __PRIVATE_UnknownDocument(this.key,e.version);var n=this.le(t);return new Document(this.key,e.version,{hasCommittedMutations:!0},n)},e.prototype.Ht=function(t,e,n){if(this.ue(t),!this._e.oe(t))return t;var r=__PRIVATE_Mutation.ae(t),i=this.le(t);return new Document(this.key,r,{ce:!0},i)},e.prototype.he=function(t){return null},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.fe.isEqual(t.fe)&&this._e.isEqual(t._e)},e.prototype.le=function(t){var e;return e=t instanceof Document?t.data():__PRIVATE_ObjectValue.EMPTY,this.Te(e)},e.prototype.Te=function(t){var e=this;return this.fe.fields.forEach((function(n){if(!n.tt()){var r=e.data.field(n);t=null!==r?t.set(n,r):t.delete(n)}})),t},e}(__PRIVATE_Mutation),__PRIVATE_TransformMutation=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.fieldTransforms=n,r.type=__PRIVATE_MutationType.Transform,r._e=Precondition.exists(!0),r}return tslib.__extends(e,t),e.prototype.zt=function(t,e){if(this.ue(t),assert(null!=e.transformResults,"Transform results missing for TransformMutation."),!this._e.oe(t))return new __PRIVATE_UnknownDocument(this.key,e.version);var n=this.de(t),r=this.Ee(t,e.transformResults),i=e.version,s=this.Pe(n.data(),r);return new Document(this.key,i,{hasCommittedMutations:!0},s)},e.prototype.Ht=function(t,e,n){if(this.ue(t),!this._e.oe(t))return t;var r=this.de(t),i=this.Ae(n,t,e),s=this.Pe(r.data(),i);return new Document(this.key,r.version,{ce:!0},s)},e.prototype.he=function(t){for(var e=null,n=0,r=this.fieldTransforms;n<r.length;n++){var i=r[n],s=t instanceof Document?t.field(i.field):void 0,o=i.transform.Xt(s||null);null!=o&&(e=null==e?__PRIVATE_ObjectValue.EMPTY.set(i.field,o):e.set(i.field,o))}return e},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&__PRIVATE_arrayEquals(this.fieldTransforms,t.fieldTransforms)&&this._e.isEqual(t._e)},e.prototype.de=function(t){return assert(t instanceof Document,"Unknown MaybeDocument type "+t),assert(t.key.isEqual(this.key),"Can only transform a document with the same key"),t},e.prototype.Ee=function(t,e){var n=[];assert(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],s=i.transform,o=null;t instanceof Document&&(o=t.field(i.field)),n.push(s.zt(o,e[r]))}return n},e.prototype.Ae=function(t,e,n){for(var r=[],i=0,s=this.fieldTransforms;i<s.length;i++){var o=s[i],u=o.transform,a=null;e instanceof Document&&(a=e.field(o.field)),null===a&&n instanceof Document&&(a=n.field(o.field)),r.push(u.Ht(a,t))}return r},e.prototype.Pe=function(t,e){assert(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;t=t.set(r,e[n])}return t},e}(__PRIVATE_Mutation),__PRIVATE_DeleteMutation=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r._e=n,r.type=__PRIVATE_MutationType.ie,r}return tslib.__extends(e,t),e.prototype.zt=function(t,e){return this.ue(t),assert(null==e.transformResults,"Transform results received by DeleteMutation."),new __PRIVATE_NoDocument(this.key,e.version,{hasCommittedMutations:!0})},e.prototype.Ht=function(t,e,n){return this.ue(t),this._e.oe(t)?(t&&assert(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new __PRIVATE_NoDocument(this.key,__PRIVATE_SnapshotVersion.W())):t},e.prototype.he=function(t){return null},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this._e.isEqual(t._e)},e}(__PRIVATE_Mutation),__PRIVATE_VerifyMutation=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r._e=n,r.type=__PRIVATE_MutationType.Verify,r}return tslib.__extends(e,t),e.prototype.zt=function(t,e){fail("VerifyMutation should only be used in Transactions.")},e.prototype.Ht=function(t,e,n){fail("VerifyMutation should only be used in Transactions.")},e.prototype.he=function(t){fail("VerifyMutation should only be used in Transactions.")},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this._e.isEqual(t._e)},e}(__PRIVATE_Mutation);!function(t){t[t.Re=0]="__PRIVATE_NullValue",t[t.Ie=1]="__PRIVATE_BooleanValue",t[t.Ve=2]="__PRIVATE_NumberValue",t[t.me=3]="__PRIVATE_TimestampValue",t[t.ve=4]="__PRIVATE_StringValue",t[t.pe=5]="__PRIVATE_BlobValue",t[t.be=6]="__PRIVATE_RefValue",t[t.ge=7]="__PRIVATE_GeoPointValue",t[t.ArrayValue=8]="ArrayValue",t[t.we=9]="__PRIVATE_ObjectValue"}(__PRIVATE_TypeOrder||(__PRIVATE_TypeOrder={})),function(t){t[t.ye=0]="__PRIVATE_Default",t[t.Se=1]="__PRIVATE_Estimate",t[t.De=2]="__PRIVATE_Previous"}(__PRIVATE_ServerTimestampBehavior||(__PRIVATE_ServerTimestampBehavior={}));var __PRIVATE_FieldValueOptions=function(){function t(t,e){this.Ce=t,this.timestampsInSnapshots=e}return t.Oe=function(e,n){switch(e.serverTimestamps){case"estimate":return new t(__PRIVATE_ServerTimestampBehavior.Se,n);case"previous":return new t(__PRIVATE_ServerTimestampBehavior.De,n);case"none":case void 0:return new t(__PRIVATE_ServerTimestampBehavior.ye,n);default:return fail("fromSnapshotOptions() called with invalid options.")}},t}(),FieldValue=function(){function t(){}return t.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},t.prototype.Fe=function(t){return assert(this.Ne!==t.Ne,"Default compareTo should not be used for values of same type."),__PRIVATE_primitiveComparator(this.Ne,t.Ne)},t}(),__PRIVATE_NullValue=function(t){function e(){var e=t.call(this)||this;return e.Ne=__PRIVATE_TypeOrder.Re,e.Zt=null,e}return tslib.__extends(e,t),e.prototype.value=function(t){return null},e.prototype.isEqual=function(t){return t instanceof e},e.prototype._=function(t){return t instanceof e?0:this.Fe(t)},e.prototype.Me=function(){return 4},e.Le=new e,e}(FieldValue),__PRIVATE_BooleanValue=function(t){function e(e){var n=t.call(this)||this;return n.Zt=e,n.Ne=__PRIVATE_TypeOrder.Ie,n}return tslib.__extends(e,t),e.prototype.value=function(t){return this.Zt},e.prototype.isEqual=function(t){return t instanceof e&&this.Zt===t.Zt},e.prototype._=function(t){return t instanceof e?__PRIVATE_primitiveComparator(this,t):this.Fe(t)},e.prototype.Me=function(){return 4},e.of=function(t){return t?e.Ge:e.Be},e.Ge=new e(!0),e.Be=new e(!1),e}(FieldValue),__PRIVATE_NumberValue=function(t){function e(e){var n=t.call(this)||this;return n.Zt=e,n.Ne=__PRIVATE_TypeOrder.Ve,n}return tslib.__extends(e,t),e.prototype.value=function(t){return this.Zt},e.prototype._=function(t){return t instanceof e?__PRIVATE_numericComparator(this.Zt,t.Zt):this.Fe(t)},e.prototype.Me=function(){return 8},e}(FieldValue);function __PRIVATE_numericComparator(t,e){return t<e?-1:t>e?1:t===e?0:isNaN(t)?isNaN(e)?0:-1:1}function __PRIVATE_numericEquals(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var __PRIVATE_IntegerValue=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return tslib.__extends(e,t),e.prototype.isEqual=function(t){return t instanceof e&&__PRIVATE_numericEquals(this.Zt,t.Zt)},e}(__PRIVATE_NumberValue),__PRIVATE_DoubleValue=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return tslib.__extends(e,t),e.prototype.isEqual=function(t){return t instanceof e&&__PRIVATE_numericEquals(this.Zt,t.Zt)},e.Ue=new e(NaN),e.POSITIVE_INFINITY=new e(1/0),e.NEGATIVE_INFINITY=new e(-1/0),e}(__PRIVATE_NumberValue),__PRIVATE_StringValue=function(t){function e(e){var n=t.call(this)||this;return n.Zt=e,n.Ne=__PRIVATE_TypeOrder.ve,n}return tslib.__extends(e,t),e.prototype.value=function(t){return this.Zt},e.prototype.isEqual=function(t){return t instanceof e&&this.Zt===t.Zt},e.prototype._=function(t){return t instanceof e?__PRIVATE_primitiveComparator(this.Zt,t.Zt):this.Fe(t)},e.prototype.Me=function(){return 2*this.Zt.length},e}(FieldValue),__PRIVATE_TimestampValue=function(t){function e(e){var n=t.call(this)||this;return n.Zt=e,n.Ne=__PRIVATE_TypeOrder.me,n}return tslib.__extends(e,t),e.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.Zt:this.Zt.toDate()},e.prototype.isEqual=function(t){return t instanceof e&&this.Zt.isEqual(t.Zt)},e.prototype._=function(t){return t instanceof e?this.Zt.K(t.Zt):t instanceof __PRIVATE_ServerTimestampValue?-1:this.Fe(t)},e.prototype.Me=function(){return 16},e}(FieldValue),__PRIVATE_ServerTimestampValue=function(t){function e(e,n){var r=t.call(this)||this;return r.ke=e,r.previousValue=n,r.Ne=__PRIVATE_TypeOrder.me,r}return tslib.__extends(e,t),e.prototype.value=function(t){return t&&t.Ce===__PRIVATE_ServerTimestampBehavior.Se?new __PRIVATE_TimestampValue(this.ke).value(t):t&&t.Ce===__PRIVATE_ServerTimestampBehavior.De&&this.previousValue?this.previousValue.value(t):null},e.prototype.isEqual=function(t){return t instanceof e&&this.ke.isEqual(t.ke)},e.prototype._=function(t){return t instanceof e?this.ke.K(t.ke):t instanceof __PRIVATE_TimestampValue?1:this.Fe(t)},e.prototype.toString=function(){return"<ServerTimestamp localTime="+this.ke.toString()+">"},e.prototype.Me=function(){return 16+(this.previousValue?this.previousValue.Me():0)},e}(FieldValue),__PRIVATE_BlobValue=function(t){function e(e){var n=t.call(this)||this;return n.Zt=e,n.Ne=__PRIVATE_TypeOrder.pe,n}return tslib.__extends(e,t),e.prototype.value=function(t){return this.Zt},e.prototype.isEqual=function(t){return t instanceof e&&this.Zt.isEqual(t.Zt)},e.prototype._=function(t){return t instanceof e?this.Zt.K(t.Zt):this.Fe(t)},e.prototype.Me=function(){return this.Zt.xe()},e}(FieldValue),__PRIVATE_RefValue=function(t){function e(e,n){var r=t.call(this)||this;return r.o=e,r.key=n,r.Ne=__PRIVATE_TypeOrder.be,r}return tslib.__extends(e,t),e.prototype.value=function(t){return this.key},e.prototype.isEqual=function(t){return t instanceof e&&(this.key.isEqual(t.key)&&this.o.isEqual(t.o))},e.prototype._=function(t){if(t instanceof e){var n=this.o._(t.o);return 0!==n?n:__PRIVATE_DocumentKey.H(this.key,t.key)}return this.Fe(t)},e.prototype.Me=function(){return this.o.projectId.length+this.o.database.length+this.key.toString().length},e}(FieldValue),__PRIVATE_GeoPointValue=function(t){function e(e){var n=t.call(this)||this;return n.Zt=e,n.Ne=__PRIVATE_TypeOrder.ge,n}return tslib.__extends(e,t),e.prototype.value=function(t){return this.Zt},e.prototype.isEqual=function(t){return t instanceof e&&this.Zt.isEqual(t.Zt)},e.prototype._=function(t){return t instanceof e?this.Zt.K(t.Zt):this.Fe(t)},e.prototype.Me=function(){return 16},e}(FieldValue),__PRIVATE_ObjectValue=function(t){function e(e){var n=t.call(this)||this;return n.Zt=e,n.Ne=__PRIVATE_TypeOrder.we,n}return tslib.__extends(e,t),e.prototype.value=function(t){var e={};return this.Zt.Vt((function(n,r){e[n]=r.value(t)})),e},e.prototype.forEach=function(t){this.Zt.Vt(t)},e.prototype.isEqual=function(t){if(t instanceof e){for(var n=this.Zt.pt(),r=t.Zt.pt();n.Ct()&&r.Ct();){var i=n.Dt(),s=r.Dt();if(i.key!==s.key||!i.value.isEqual(s.value))return!1}return!n.Ct()&&!r.Ct()}return!1},e.prototype._=function(t){if(t instanceof e){for(var n=this.Zt.pt(),r=t.Zt.pt();n.Ct()&&r.Ct();){var i=n.Dt(),s=r.Dt(),o=__PRIVATE_primitiveComparator(i.key,s.key)||i.value._(s.value);if(o)return o}return __PRIVATE_primitiveComparator(n.Ct(),r.Ct())}return this.Fe(t)},e.prototype.set=function(t,n){if(assert(!t.tt(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.Ke(t.et(),n);var r=this.child(t.et());r instanceof e||(r=e.EMPTY);var i=r.set(t.J(),n);return this.Ke(t.et(),i)},e.prototype.delete=function(t){if(assert(!t.tt(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new e(this.Zt.remove(t.et()));var n=this.child(t.et());if(n instanceof e){var r=n.delete(t.J());return new e(this.Zt.Pt(t.et(),r))}return this},e.prototype.contains=function(t){return null!==this.field(t)},e.prototype.field=function(t){assert(!t.tt(),"Can't get field of empty path");var n=this;return t.forEach((function(t){n=n instanceof e?n.Zt.get(t):null})),n},e.prototype.fe=function(){var t=new __PRIVATE_SortedSet(FieldPath.H);return this.Zt.forEach((function(n,r){var i=new FieldPath([n]);if(r instanceof e){var s=r.fe().fields;s.tt()?t=t.add(i):s.forEach((function(e){t=t.add(i.child(e))}))}else t=t.add(i)})),__PRIVATE_FieldMask.te(t)},e.prototype.Me=function(){var t=0;return this.Zt.Vt((function(e,n){t+=e.length+n.Me()})),t},e.prototype.toString=function(){return this.Zt.toString()},e.prototype.child=function(t){return this.Zt.get(t)||void 0},e.prototype.Ke=function(t,n){return new e(this.Zt.Pt(t,n))},e.EMPTY=new e(new __PRIVATE_SortedMap(__PRIVATE_primitiveComparator)),e}(FieldValue),ArrayValue=function(t){function e(e){var n=t.call(this)||this;return n.Zt=e,n.Ne=__PRIVATE_TypeOrder.ArrayValue,n}return tslib.__extends(e,t),e.prototype.value=function(t){return this.Zt.map((function(e){return e.value(t)}))},e.prototype.contains=function(t){for(var e=0,n=this.Zt;e<n.length;e++){if(n[e].isEqual(t))return!0}return!1},e.prototype.forEach=function(t){this.Zt.forEach(t)},e.prototype.isEqual=function(t){if(t instanceof e){if(this.Zt.length!==t.Zt.length)return!1;for(var n=0;n<this.Zt.length;n++)if(!this.Zt[n].isEqual(t.Zt[n]))return!1;return!0}return!1},e.prototype._=function(t){if(t instanceof e){for(var n=Math.min(this.Zt.length,t.Zt.length),r=0;r<n;r++){var i=this.Zt[r]._(t.Zt[r]);if(i)return i}return __PRIVATE_primitiveComparator(this.Zt.length,t.Zt.length)}return this.Fe(t)},e.prototype.Me=function(){return this.Zt.reduce((function(t,e){return t+e.Me()}),0)},e.prototype.toString=function(){return"["+this.Zt.map((function(t){return t.toString()})).join(",")+"]"},e}(FieldValue),__PRIVATE_MaybeDocument=function(){function t(t,e){this.key=t,this.version=e}return t.qe=function(t,e){return __PRIVATE_DocumentKey.H(t.key,e.key)},t}(),Document=function(t){function e(e,n,r,i,s,o){var u=t.call(this,e,n)||this;return u.je=i,u.proto=s,u.converter=o,assert(void 0!==u.je||void 0!==u.proto&&void 0!==u.converter,"If objectValue is not defined, proto and converter need to be set."),u.ce=!!r.ce,u.hasCommittedMutations=!!r.hasCommittedMutations,u}return tslib.__extends(e,t),e.prototype.field=function(t){if(this.je)return this.je.field(t);this.Qe||(this.Qe=new Map);var e=t.ot(),n=this.Qe.get(e);if(void 0===n){var r=this.We(t);n=void 0===r?null:this.converter(r),this.Qe.set(e,n)}return n},e.prototype.data=function(){var t=this;if(!this.je){var e=__PRIVATE_ObjectValue.EMPTY;forEach(this.proto.fields||{},(function(n,r){e=e.set(new FieldPath([n]),t.converter(r))})),this.je=e,this.Qe=void 0}return this.je},e.prototype.value=function(){return this.data().value()},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.ce===t.ce&&this.hasCommittedMutations===t.hasCommittedMutations&&this.data().isEqual(t.data())},e.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data().toString()+", {hasLocalMutations: "+this.ce+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.ce||this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.prototype.We=function(t){assert(void 0!==this.proto,"Can only call getProtoField() when proto is defined");for(var e=this.proto.fields?this.proto.fields[t.et()]:void 0,n=1;n<t.length;++n){if(!e||!e.mapValue||!e.mapValue.fields)return;e=e.mapValue.fields[t.get(n)]}return e},e.$e=function(t,e,n){var r=e.field(t),i=n.field(t);return null!==r&&null!==i?r._(i):fail("Trying to compare documents on fields that don't exist")},e}(__PRIVATE_MaybeDocument),__PRIVATE_NoDocument=function(t){function e(e,n,r){var i=t.call(this,e,n)||this;return i.hasCommittedMutations=!(!r||!r.hasCommittedMutations),i}return tslib.__extends(e,t),e.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(__PRIVATE_MaybeDocument),__PRIVATE_UnknownDocument=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return tslib.__extends(e,t),e.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(__PRIVATE_MaybeDocument),__PRIVATE_NumberAsAny=Number,MIN_SAFE_INTEGER=__PRIVATE_NumberAsAny.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),MAX_SAFE_INTEGER=__PRIVATE_NumberAsAny.MAX_SAFE_INTEGER||Math.pow(2,53)-1,isInteger=__PRIVATE_NumberAsAny.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function isNullOrUndefined(t){return null==t}function isSafeInteger(t){return isInteger(t)&&t<=MAX_SAFE_INTEGER&&t>=MIN_SAFE_INTEGER}var __PRIVATE_LimitType,Target=function(){function t(t,e,n,r,i,s,o){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===s&&(s=null),void 0===o&&(o=null),this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=o,this.Ye=null}return t.prototype.canonicalId=function(){if(null===this.Ye){var t=this.path.ot();null!==this.collectionGroup&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++){t+=n[e].canonicalId(),t+=","}t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++){t+=i[r].canonicalId(),t+=","}isNullOrUndefined(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.Ye=t}return this.Ye},t.prototype.toString=function(){var t=this.path.ot();return null!==this.collectionGroup&&(t+=" collectionGroup="+this.collectionGroup),this.filters.length>0&&(t+=", filters: ["+this.filters.join(", ")+"]"),isNullOrUndefined(this.limit)||(t+=", limit: "+this.limit),this.orderBy.length>0&&(t+=", orderBy: ["+this.orderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),"Target("+t+")"},t.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&(!!this.path.isEqual(t.path)&&(!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)))},t.prototype.He=function(){return __PRIVATE_DocumentKey.lt(this.path)&&null===this.collectionGroup&&0===this.filters.length},t}();!function(t){t.ze="F",t.Xe="L"}(__PRIVATE_LimitType||(__PRIVATE_LimitType={}));var __PRIVATE_TargetPurpose,Query=function(){function t(t,e,n,r,i,s,o,u){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===s&&(s=__PRIVATE_LimitType.ze),void 0===o&&(o=null),void 0===u&&(u=null),this.path=t,this.collectionGroup=e,this.Je=n,this.filters=r,this.limit=i,this.Ze=s,this.startAt=o,this.endAt=u,this.tn=null,this.en=null,this.startAt&&this.nn(this.startAt),this.endAt&&this.nn(this.endAt)}return t.rn=function(e){return new t(e)},Object.defineProperty(t.prototype,"orderBy",{get:function(){if(null===this.tn){var t=this.in(),e=this.sn();if(null!==t&&null===e)t.ct()?this.tn=[__PRIVATE_KEY_ORDERING_ASC]:this.tn=[new __PRIVATE_OrderBy(t),__PRIVATE_KEY_ORDERING_ASC];else{assert(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field."),this.tn=[];for(var n=!1,r=0,i=this.Je;r<i.length;r++){var s=i[r];this.tn.push(s),s.field.ct()&&(n=!0)}if(!n){var o=this.Je.length>0?this.Je[this.Je.length-1].dir:__PRIVATE_Direction.ASCENDING;this.tn.push(o===__PRIVATE_Direction.ASCENDING?__PRIVATE_KEY_ORDERING_ASC:__PRIVATE_KEY_ORDERING_DESC)}}}return this.tn},enumerable:!0,configurable:!0}),t.prototype.un=function(e){assert(null==this.in()||!(e instanceof FieldFilter)||!e.an()||e.field.isEqual(this.in()),"Query must only have one inequality field."),assert(!this.He(),"No filtering allowed for document query");var n=this.filters.concat([e]);return new t(this.path,this.collectionGroup,this.Je.slice(),n,this.limit,this.Ze,this.startAt,this.endAt)},t.prototype._n=function(e){assert(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var n=this.Je.concat([e]);return new t(this.path,this.collectionGroup,n,this.filters.slice(),this.limit,this.Ze,this.startAt,this.endAt)},t.prototype.cn=function(e){return new t(this.path,this.collectionGroup,this.Je.slice(),this.filters.slice(),e,__PRIVATE_LimitType.ze,this.startAt,this.endAt)},t.prototype.hn=function(e){return new t(this.path,this.collectionGroup,this.Je.slice(),this.filters.slice(),e,__PRIVATE_LimitType.Xe,this.startAt,this.endAt)},t.prototype.fn=function(e){return new t(this.path,this.collectionGroup,this.Je.slice(),this.filters.slice(),this.limit,this.Ze,e,this.endAt)},t.prototype.ln=function(e){return new t(this.path,this.collectionGroup,this.Je.slice(),this.filters.slice(),this.limit,this.Ze,this.startAt,e)},t.prototype.Tn=function(e){return new t(e,null,this.Je.slice(),this.filters.slice(),this.limit,this.Ze,this.startAt,this.endAt)},t.prototype.dn=function(){return 0===this.filters.length&&null===this.limit&&null==this.startAt&&null==this.endAt&&(0===this.Je.length||1===this.Je.length&&this.Je[0].field.ct())},t.prototype.canonicalId=function(){return this.En().canonicalId()+"|lt:"+this.Ze},t.prototype.toString=function(){return"Query(target="+this.En().toString()+"; limitType="+this.Ze+")"},t.prototype.isEqual=function(t){return this.En().isEqual(t.En())&&this.Ze===t.Ze},t.prototype.Pn=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var s=i[r],o=s.compare(t,e);if(0!==o)return o;n=n||s.field.ct()}return assert(n,"orderBy used that doesn't compare on key field"),0},t.prototype.matches=function(t){return this.An(t)&&this.Rn(t)&&this.In(t)&&this.Vn(t)},t.prototype.mn=function(){return!isNullOrUndefined(this.limit)&&this.Ze===__PRIVATE_LimitType.ze},t.prototype.vn=function(){return!isNullOrUndefined(this.limit)&&this.Ze===__PRIVATE_LimitType.Xe},t.prototype.sn=function(){return this.Je.length>0?this.Je[0].field:null},t.prototype.in=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof FieldFilter&&n.an())return n.field}return null},t.prototype.pn=function(t){for(var e=0,n=this.filters;e<n.length;e++){var r=n[e];if(r instanceof FieldFilter&&t.indexOf(r.op)>=0)return r.op}return null},t.prototype.He=function(){return this.En().He()},t.prototype.bn=function(){return null!==this.collectionGroup},t.prototype.En=function(){if(!this.en)if(this.Ze===__PRIVATE_LimitType.ze)this.en=new Target(this.path,this.collectionGroup,this.orderBy,this.filters,this.limit,this.startAt,this.endAt);else{for(var t=[],e=0,n=this.orderBy;e<n.length;e++){var r=n[e],i=r.dir===__PRIVATE_Direction.DESCENDING?__PRIVATE_Direction.ASCENDING:__PRIVATE_Direction.DESCENDING;t.push(new __PRIVATE_OrderBy(r.field,i))}var s=this.endAt?new __PRIVATE_Bound(this.endAt.position,!this.endAt.before):null,o=this.startAt?new __PRIVATE_Bound(this.startAt.position,!this.startAt.before):null;this.en=new Target(this.path,this.collectionGroup,t,this.filters,this.limit,s,o)}return this.en},t.prototype.An=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.Tt(this.collectionGroup)&&this.path.rt(e):__PRIVATE_DocumentKey.lt(this.path)?this.path.isEqual(e):this.path.it(e)},t.prototype.Rn=function(t){for(var e=0,n=this.Je;e<n.length;e++){var r=n[e];if(!r.field.ct()&&null===t.field(r.field))return!1}return!0},t.prototype.In=function(t){for(var e=0,n=this.filters;e<n.length;e++){if(!n[e].matches(t))return!1}return!0},t.prototype.Vn=function(t){return!(this.startAt&&!this.startAt.gn(this.orderBy,t))&&(!this.endAt||!this.endAt.gn(this.orderBy,t))},t.prototype.nn=function(t){assert(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},t}(),Filter=function(){},__PRIVATE_Operator=function(){function t(t){this.name=t}return t.ut=function(e){switch(e){case"<":return t.LESS_THAN;case"<=":return t.LESS_THAN_OR_EQUAL;case"==":return t.EQUAL;case">=":return t.GREATER_THAN_OR_EQUAL;case">":return t.GREATER_THAN;case"array-contains":return t.ARRAY_CONTAINS;case"in":return t.IN;case"array-contains-any":return t.ARRAY_CONTAINS_ANY;default:return fail("Unknown FieldFilter operator: "+e)}},t.prototype.toString=function(){return this.name},t.prototype.isEqual=function(t){return this.name===t.name},t.LESS_THAN=new t("<"),t.LESS_THAN_OR_EQUAL=new t("<="),t.EQUAL=new t("=="),t.GREATER_THAN=new t(">"),t.GREATER_THAN_OR_EQUAL=new t(">="),t.ARRAY_CONTAINS=new t("array-contains"),t.IN=new t("in"),t.ARRAY_CONTAINS_ANY=new t("array-contains-any"),t}(),FieldFilter=function(t){function e(e,n,r){var i=t.call(this)||this;return i.field=e,i.op=n,i.value=r,i}return tslib.__extends(e,t),e.create=function(t,n,r){if(t.ct())return n===__PRIVATE_Operator.IN?(assert(r instanceof ArrayValue,"Comparing on key with IN, but filter value not an ArrayValue"),assert(r.Zt.every((function(t){return t instanceof __PRIVATE_RefValue})),"Comparing on key with IN, but an array value was not a RefValue"),new __PRIVATE_KeyFieldInFilter(t,r)):(assert(r instanceof __PRIVATE_RefValue,"Comparing on key, but filter value not a RefValue"),assert(n!==__PRIVATE_Operator.ARRAY_CONTAINS&&n!==__PRIVATE_Operator.ARRAY_CONTAINS_ANY,"'"+n.toString()+"' queries don't make sense on document keys."),new __PRIVATE_KeyFieldFilter(t,n,r));if(r.isEqual(__PRIVATE_NullValue.Le)){if(n!==__PRIVATE_Operator.EQUAL)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Null supports only equality comparisons.");return new e(t,n,r)}if(r.isEqual(__PRIVATE_DoubleValue.Ue)){if(n!==__PRIVATE_Operator.EQUAL)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. NaN supports only equality comparisons.");return new e(t,n,r)}return n===__PRIVATE_Operator.ARRAY_CONTAINS?new __PRIVATE_ArrayContainsFilter(t,r):n===__PRIVATE_Operator.IN?(assert(r instanceof ArrayValue,"IN filter has invalid value: "+r.toString()),new __PRIVATE_InFilter(t,r)):n===__PRIVATE_Operator.ARRAY_CONTAINS_ANY?(assert(r instanceof ArrayValue,"ARRAY_CONTAINS_ANY filter has invalid value: "+r.toString()),new __PRIVATE_ArrayContainsAnyFilter(t,r)):new e(t,n,r)},e.prototype.matches=function(t){var e=t.field(this.field);return null!==e&&this.value.Ne===e.Ne&&this.wn(e._(this.value))},e.prototype.wn=function(t){switch(this.op){case __PRIVATE_Operator.LESS_THAN:return t<0;case __PRIVATE_Operator.LESS_THAN_OR_EQUAL:return t<=0;case __PRIVATE_Operator.EQUAL:return 0===t;case __PRIVATE_Operator.GREATER_THAN:return t>0;case __PRIVATE_Operator.GREATER_THAN_OR_EQUAL:return t>=0;default:return fail("Unknown FieldFilter operator: "+this.op)}},e.prototype.an=function(){return[__PRIVATE_Operator.LESS_THAN,__PRIVATE_Operator.LESS_THAN_OR_EQUAL,__PRIVATE_Operator.GREATER_THAN,__PRIVATE_Operator.GREATER_THAN_OR_EQUAL].indexOf(this.op)>=0},e.prototype.canonicalId=function(){return this.field.ot()+this.op.toString()+this.value.toString()},e.prototype.isEqual=function(t){return t instanceof e&&(this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value))},e.prototype.toString=function(){return this.field.ot()+" "+this.op+" "+this.value.value()},e}(Filter),__PRIVATE_KeyFieldFilter=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return tslib.__extends(e,t),e.prototype.matches=function(t){var e=this.value,n=__PRIVATE_DocumentKey.H(t.key,e.key);return this.wn(n)},e}(FieldFilter),__PRIVATE_KeyFieldInFilter=function(t){function e(e,n){var r=t.call(this,e,__PRIVATE_Operator.IN,n)||this;return r.value=n,r}return tslib.__extends(e,t),e.prototype.matches=function(t){return this.value.Zt.some((function(e){return t.key.isEqual(e.key)}))},e}(FieldFilter),__PRIVATE_ArrayContainsFilter=function(t){function e(e,n){return t.call(this,e,__PRIVATE_Operator.ARRAY_CONTAINS,n)||this}return tslib.__extends(e,t),e.prototype.matches=function(t){var e=t.field(this.field);return e instanceof ArrayValue&&e.contains(this.value)},e}(FieldFilter),__PRIVATE_InFilter=function(t){function e(e,n){var r=t.call(this,e,__PRIVATE_Operator.IN,n)||this;return r.value=n,r}return tslib.__extends(e,t),e.prototype.matches=function(t){var e=this.value,n=t.field(this.field);return null!==n&&e.contains(n)},e}(FieldFilter),__PRIVATE_ArrayContainsAnyFilter=function(t){function e(e,n){var r=t.call(this,e,__PRIVATE_Operator.ARRAY_CONTAINS_ANY,n)||this;return r.value=n,r}return tslib.__extends(e,t),e.prototype.matches=function(t){var e=this,n=t.field(this.field);return n instanceof ArrayValue&&n.Zt.some((function(t){return e.value.contains(t)}))},e}(FieldFilter),__PRIVATE_Direction=function(){function t(t){this.name=t}return t.prototype.toString=function(){return this.name},t.ASCENDING=new t("asc"),t.DESCENDING=new t("desc"),t}(),__PRIVATE_Bound=function(){function t(t,e){this.position=t,this.before=e}return t.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++){t+=n[e].toString()}return t},t.prototype.gn=function(t,e){assert(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=t[r],s=this.position[r];if(i.field.ct())assert(s instanceof __PRIVATE_RefValue,"Bound has a non-key value where the key path is being used."),n=__PRIVATE_DocumentKey.H(s.key,e.key);else{var o=e.field(i.field);assert(null!==o,"Field should exist since document matched the orderBy already."),n=s._(o)}if(i.dir===__PRIVATE_Direction.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},t.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){var n=this.position[e],r=t.position[e];if(!n.isEqual(r))return!1}return!0},t}(),__PRIVATE_OrderBy=function(){function t(t,e){this.field=t,void 0===e&&(e=__PRIVATE_Direction.ASCENDING),this.dir=e,this.yn=t.ct()}return t.prototype.compare=function(t,e){var n=this.yn?Document.qe(t,e):Document.$e(this.field,t,e);switch(this.dir){case __PRIVATE_Direction.ASCENDING:return n;case __PRIVATE_Direction.DESCENDING:return-1*n;default:return fail("Unknown direction: "+this.dir)}},t.prototype.canonicalId=function(){return this.field.ot()+this.dir.toString()},t.prototype.toString=function(){return this.field.ot()+" ("+this.dir+")"},t.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},t}(),__PRIVATE_KEY_ORDERING_ASC=new __PRIVATE_OrderBy(FieldPath.ht(),__PRIVATE_Direction.ASCENDING),__PRIVATE_KEY_ORDERING_DESC=new __PRIVATE_OrderBy(FieldPath.ht(),__PRIVATE_Direction.DESCENDING);!function(t){t[t.Sn=0]="__PRIVATE_Listen",t[t.Dn=1]="__PRIVATE_ExistenceFilterMismatch",t[t.Cn=2]="__PRIVATE_LimboResolution"}(__PRIVATE_TargetPurpose||(__PRIVATE_TargetPurpose={}));var __PRIVATE_RpcCode,__PRIVATE_TargetData=function(){function t(t,e,n,r,i,s,o){void 0===i&&(i=__PRIVATE_SnapshotVersion.MIN),void 0===s&&(s=__PRIVATE_SnapshotVersion.MIN),void 0===o&&(o=__PRIVATE_emptyByteString()),this.target=t,this.targetId=e,this.On=n,this.sequenceNumber=r,this.Fn=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=o}return t.prototype.Nn=function(e){return new t(this.target,this.targetId,this.On,e,this.Fn,this.lastLimboFreeSnapshotVersion,this.resumeToken)},t.prototype.Mn=function(e,n){return new t(this.target,this.targetId,this.On,this.sequenceNumber,n,this.lastLimboFreeSnapshotVersion,e)},t.prototype.Ln=function(e){return new t(this.target,this.targetId,this.On,this.sequenceNumber,this.Fn,e,this.resumeToken)},t.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.On===t.On&&this.sequenceNumber===t.sequenceNumber&&this.Fn.isEqual(t.Fn)&&this.lastLimboFreeSnapshotVersion.isEqual(t.lastLimboFreeSnapshotVersion)&&this.resumeToken===t.resumeToken&&this.target.isEqual(t.target)},t}(),ExistenceFilter=function(){function t(t){this.count=t}return t.prototype.isEqual=function(t){return t&&t.count===this.count},t}();function __PRIVATE_isPermanentError(t){switch(t){case Code.OK:return fail("Treated status OK as error");case Code.CANCELLED:case Code.UNKNOWN:case Code.DEADLINE_EXCEEDED:case Code.RESOURCE_EXHAUSTED:case Code.INTERNAL:case Code.UNAVAILABLE:case Code.UNAUTHENTICATED:return!1;case Code.INVALID_ARGUMENT:case Code.NOT_FOUND:case Code.ALREADY_EXISTS:case Code.PERMISSION_DENIED:case Code.FAILED_PRECONDITION:case Code.ABORTED:case Code.OUT_OF_RANGE:case Code.UNIMPLEMENTED:case Code.DATA_LOSS:return!0;default:return fail("Unknown status code: "+t)}}function __PRIVATE_isPermanentWriteError(t){return __PRIVATE_isPermanentError(t)&&t!==Code.ABORTED}function __PRIVATE_mapCodeFromRpcCode(t){if(void 0===t)return error("GRPC error has no .code"),Code.UNKNOWN;switch(t){case __PRIVATE_RpcCode.OK:return Code.OK;case __PRIVATE_RpcCode.CANCELLED:return Code.CANCELLED;case __PRIVATE_RpcCode.UNKNOWN:return Code.UNKNOWN;case __PRIVATE_RpcCode.DEADLINE_EXCEEDED:return Code.DEADLINE_EXCEEDED;case __PRIVATE_RpcCode.RESOURCE_EXHAUSTED:return Code.RESOURCE_EXHAUSTED;case __PRIVATE_RpcCode.INTERNAL:return Code.INTERNAL;case __PRIVATE_RpcCode.UNAVAILABLE:return Code.UNAVAILABLE;case __PRIVATE_RpcCode.UNAUTHENTICATED:return Code.UNAUTHENTICATED;case __PRIVATE_RpcCode.INVALID_ARGUMENT:return Code.INVALID_ARGUMENT;case __PRIVATE_RpcCode.NOT_FOUND:return Code.NOT_FOUND;case __PRIVATE_RpcCode.ALREADY_EXISTS:return Code.ALREADY_EXISTS;case __PRIVATE_RpcCode.PERMISSION_DENIED:return Code.PERMISSION_DENIED;case __PRIVATE_RpcCode.FAILED_PRECONDITION:return Code.FAILED_PRECONDITION;case __PRIVATE_RpcCode.ABORTED:return Code.ABORTED;case __PRIVATE_RpcCode.OUT_OF_RANGE:return Code.OUT_OF_RANGE;case __PRIVATE_RpcCode.UNIMPLEMENTED:return Code.UNIMPLEMENTED;case __PRIVATE_RpcCode.DATA_LOSS:return Code.DATA_LOSS;default:return fail("Unknown status code: "+t)}}function __PRIVATE_mapRpcCodeFromCode(t){if(void 0===t)return __PRIVATE_RpcCode.OK;switch(t){case Code.OK:return __PRIVATE_RpcCode.OK;case Code.CANCELLED:return __PRIVATE_RpcCode.CANCELLED;case Code.UNKNOWN:return __PRIVATE_RpcCode.UNKNOWN;case Code.DEADLINE_EXCEEDED:return __PRIVATE_RpcCode.DEADLINE_EXCEEDED;case Code.RESOURCE_EXHAUSTED:return __PRIVATE_RpcCode.RESOURCE_EXHAUSTED;case Code.INTERNAL:return __PRIVATE_RpcCode.INTERNAL;case Code.UNAVAILABLE:return __PRIVATE_RpcCode.UNAVAILABLE;case Code.UNAUTHENTICATED:return __PRIVATE_RpcCode.UNAUTHENTICATED;case Code.INVALID_ARGUMENT:return __PRIVATE_RpcCode.INVALID_ARGUMENT;case Code.NOT_FOUND:return __PRIVATE_RpcCode.NOT_FOUND;case Code.ALREADY_EXISTS:return __PRIVATE_RpcCode.ALREADY_EXISTS;case Code.PERMISSION_DENIED:return __PRIVATE_RpcCode.PERMISSION_DENIED;case Code.FAILED_PRECONDITION:return __PRIVATE_RpcCode.FAILED_PRECONDITION;case Code.ABORTED:return __PRIVATE_RpcCode.ABORTED;case Code.OUT_OF_RANGE:return __PRIVATE_RpcCode.OUT_OF_RANGE;case Code.UNIMPLEMENTED:return __PRIVATE_RpcCode.UNIMPLEMENTED;case Code.DATA_LOSS:return __PRIVATE_RpcCode.DATA_LOSS;default:return fail("Unknown status code: "+t)}}!function(t){t[t.OK=0]="OK",t[t.CANCELLED=1]="CANCELLED",t[t.UNKNOWN=2]="UNKNOWN",t[t.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",t[t.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",t[t.NOT_FOUND=5]="NOT_FOUND",t[t.ALREADY_EXISTS=6]="ALREADY_EXISTS",t[t.PERMISSION_DENIED=7]="PERMISSION_DENIED",t[t.UNAUTHENTICATED=16]="UNAUTHENTICATED",t[t.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",t[t.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",t[t.ABORTED=10]="ABORTED",t[t.OUT_OF_RANGE=11]="OUT_OF_RANGE",t[t.UNIMPLEMENTED=12]="UNIMPLEMENTED",t[t.INTERNAL=13]="INTERNAL",t[t.UNAVAILABLE=14]="UNAVAILABLE",t[t.DATA_LOSS=15]="DATA_LOSS"}(__PRIVATE_RpcCode||(__PRIVATE_RpcCode={}));var __PRIVATE_EMPTY_MAYBE_DOCUMENT_MAP=new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H);function __PRIVATE_maybeDocumentMap(){return __PRIVATE_EMPTY_MAYBE_DOCUMENT_MAP}function __PRIVATE_nullableMaybeDocumentMap(){return __PRIVATE_maybeDocumentMap()}var __PRIVATE_EMPTY_DOCUMENT_MAP=new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H);function __PRIVATE_documentMap(){return __PRIVATE_EMPTY_DOCUMENT_MAP}var __PRIVATE_EMPTY_DOCUMENT_VERSION_MAP=new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H);function __PRIVATE_documentVersionMap(){return __PRIVATE_EMPTY_DOCUMENT_VERSION_MAP}var __PRIVATE_EMPTY_DOCUMENT_KEY_SET=new __PRIVATE_SortedSet(__PRIVATE_DocumentKey.H);function __PRIVATE_documentKeySet(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=__PRIVATE_EMPTY_DOCUMENT_KEY_SET,r=0,i=t;r<i.length;r++){var s=i[r];n=n.add(s)}return n}var __PRIVATE_EMPTY_TARGET_ID_SET=new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator);function __PRIVATE_targetIdSet(){return __PRIVATE_EMPTY_TARGET_ID_SET}var __PRIVATE_ChangeType,__PRIVATE_SyncState,__PRIVATE_DocumentSet=function(){function t(t){this.H=t?function(e,n){return t(e,n)||__PRIVATE_DocumentKey.H(e.key,n.key)}:function(t,e){return __PRIVATE_DocumentKey.H(t.key,e.key)},this.Gn=__PRIVATE_documentMap(),this.Bn=new __PRIVATE_SortedMap(this.H)}return t.Un=function(e){return new t(e.H)},t.prototype.has=function(t){return null!=this.Gn.get(t)},t.prototype.get=function(t){return this.Gn.get(t)},t.prototype.first=function(){return this.Bn.Rt()},t.prototype.last=function(){return this.Bn.It()},t.prototype.tt=function(){return this.Bn.tt()},t.prototype.indexOf=function(t){var e=this.Gn.get(t);return e?this.Bn.indexOf(e):-1},Object.defineProperty(t.prototype,"size",{get:function(){return this.Bn.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t){this.Bn.Vt((function(e,n){return t(e),!1}))},t.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.Gn.Pt(t.key,t),e.Bn.Pt(t,null))},t.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.Gn.remove(t),this.Bn.remove(e)):this},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.Bn.pt(),r=e.Bn.pt();n.Ct();){var i=n.Dt().key,s=r.Dt().key;if(!i.isEqual(s))return!1}return!0},t.prototype.toString=function(){var t=[];return this.forEach((function(e){t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},t.prototype.copy=function(e,n){var r=new t;return r.H=this.H,r.Gn=e,r.Bn=n,r},t}();!function(t){t[t.kn=0]="__PRIVATE_Added",t[t.xn=1]="__PRIVATE_Removed",t[t.Kn=2]="__PRIVATE_Modified",t[t.qn=3]="__PRIVATE_Metadata"}(__PRIVATE_ChangeType||(__PRIVATE_ChangeType={})),function(t){t[t.jn=0]="__PRIVATE_Local",t[t.Qn=1]="__PRIVATE_Synced"}(__PRIVATE_SyncState||(__PRIVATE_SyncState={}));var __PRIVATE_WatchTargetChangeState,__PRIVATE_DocumentChangeSet=function(){function t(){this.Wn=new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H)}return t.prototype.track=function(t){var e=t.doc.key,n=this.Wn.get(e);n?t.type!==__PRIVATE_ChangeType.kn&&n.type===__PRIVATE_ChangeType.qn?this.Wn=this.Wn.Pt(e,t):t.type===__PRIVATE_ChangeType.qn&&n.type!==__PRIVATE_ChangeType.xn?this.Wn=this.Wn.Pt(e,{type:n.type,doc:t.doc}):t.type===__PRIVATE_ChangeType.Kn&&n.type===__PRIVATE_ChangeType.Kn?this.Wn=this.Wn.Pt(e,{type:__PRIVATE_ChangeType.Kn,doc:t.doc}):t.type===__PRIVATE_ChangeType.Kn&&n.type===__PRIVATE_ChangeType.kn?this.Wn=this.Wn.Pt(e,{type:__PRIVATE_ChangeType.kn,doc:t.doc}):t.type===__PRIVATE_ChangeType.xn&&n.type===__PRIVATE_ChangeType.kn?this.Wn=this.Wn.remove(e):t.type===__PRIVATE_ChangeType.xn&&n.type===__PRIVATE_ChangeType.Kn?this.Wn=this.Wn.Pt(e,{type:__PRIVATE_ChangeType.xn,doc:n.doc}):t.type===__PRIVATE_ChangeType.kn&&n.type===__PRIVATE_ChangeType.xn?this.Wn=this.Wn.Pt(e,{type:__PRIVATE_ChangeType.Kn,doc:t.doc}):fail("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n)):this.Wn=this.Wn.Pt(e,t)},t.prototype.$n=function(){var t=[];return this.Wn.Vt((function(e,n){t.push(n)})),t},t}(),__PRIVATE_ViewSnapshot=function(){function t(t,e,n,r,i,s,o,u){this.query=t,this.docs=e,this.Yn=n,this.docChanges=r,this.Hn=i,this.fromCache=s,this.zn=o,this.Xn=u}return t.Jn=function(e,n,r,i){var s=[];return n.forEach((function(t){s.push({type:__PRIVATE_ChangeType.kn,doc:t})})),new t(e,n,__PRIVATE_DocumentSet.Un(n),s,r,i,!0,!1)},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return!this.Hn.tt()},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.zn===t.zn&&this.Hn.isEqual(t.Hn)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.Yn.isEqual(t.Yn)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},t}(),__PRIVATE_RemoteEvent=function(){function t(t,e,n,r,i){this.Fn=t,this.Zn=e,this.tr=n,this.er=r,this.nr=i}return t.rr=function(e,n){var r,i=((r={})[e]=TargetChange.ir(e,n),r);return new t(__PRIVATE_SnapshotVersion.MIN,i,__PRIVATE_targetIdSet(),__PRIVATE_maybeDocumentMap(),__PRIVATE_documentKeySet())},t}(),TargetChange=function(){function t(t,e,n,r,i){this.resumeToken=t,this.sr=e,this.or=n,this.ur=r,this.ar=i}return t.ir=function(e,n){return new t(__PRIVATE_emptyByteString(),n,__PRIVATE_documentKeySet(),__PRIVATE_documentKeySet(),__PRIVATE_documentKeySet())},t}(),__PRIVATE_DocumentWatchChange=function(t,e,n,r){this._r=t,this.removedTargetIds=e,this.key=n,this.cr=r},__PRIVATE_ExistenceFilterChange=function(t,e){this.targetId=t,this.hr=e};!function(t){t[t.lr=0]="__PRIVATE_NoChange",t[t.kn=1]="__PRIVATE_Added",t[t.xn=2]="__PRIVATE_Removed",t[t.Tr=3]="__PRIVATE_Current",t[t.dr=4]="__PRIVATE_Reset"}(__PRIVATE_WatchTargetChangeState||(__PRIVATE_WatchTargetChangeState={}));var __PRIVATE_WatchTargetChange=function(t,e,n,r){void 0===n&&(n=__PRIVATE_emptyByteString()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r},__PRIVATE_TargetState=function(){function t(){this.Er=0,this.Pr=__PRIVATE_snapshotChangesMap(),this.Ar=__PRIVATE_emptyByteString(),this.Rr=!1,this.Ir=!0}return Object.defineProperty(t.prototype,"sr",{get:function(){return this.Rr},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resumeToken",{get:function(){return this.Ar},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Vr",{get:function(){return 0!==this.Er},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mr",{get:function(){return this.Ir},enumerable:!0,configurable:!0}),t.prototype.vr=function(t){t.length>0&&(this.Ir=!0,this.Ar=t)},t.prototype.pr=function(){var t=__PRIVATE_documentKeySet(),e=__PRIVATE_documentKeySet(),n=__PRIVATE_documentKeySet();return this.Pr.forEach((function(r,i){switch(i){case __PRIVATE_ChangeType.kn:t=t.add(r);break;case __PRIVATE_ChangeType.Kn:e=e.add(r);break;case __PRIVATE_ChangeType.xn:n=n.add(r);break;default:fail("Encountered invalid change type: "+i)}})),new TargetChange(this.Ar,this.Rr,t,e,n)},t.prototype.br=function(){this.Ir=!1,this.Pr=__PRIVATE_snapshotChangesMap()},t.prototype.gr=function(t,e){this.Ir=!0,this.Pr=this.Pr.Pt(t,e)},t.prototype.wr=function(t){this.Ir=!0,this.Pr=this.Pr.remove(t)},t.prototype.yr=function(){this.Er+=1},t.prototype.Sr=function(){this.Er-=1},t.prototype.Dr=function(){this.Ir=!0,this.Rr=!0},t}(),__PRIVATE_LOG_TAG="WatchChangeAggregator",__PRIVATE_WatchChangeAggregator=function(){function t(t){this.Cr=t,this.Or={},this.Fr=__PRIVATE_maybeDocumentMap(),this.Nr=__PRIVATE_documentTargetMap(),this.Mr=new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator)}return t.prototype.Lr=function(t){for(var e=0,n=t._r;e<n.length;e++){var r=n[e];t.cr instanceof Document?this.Gr(r,t.cr):t.cr instanceof __PRIVATE_NoDocument&&this.Br(r,t.key,t.cr)}for(var i=0,s=t.removedTargetIds;i<s.length;i++){r=s[i];this.Br(r,t.key,t.cr)}},t.prototype.Ur=function(t){var e=this;this.kr(t,(function(n){var r=e.xr(n);switch(t.state){case __PRIVATE_WatchTargetChangeState.lr:e.Kr(n)&&r.vr(t.resumeToken);break;case __PRIVATE_WatchTargetChangeState.kn:r.Sr(),r.Vr||r.br(),r.vr(t.resumeToken);break;case __PRIVATE_WatchTargetChangeState.xn:r.Sr(),r.Vr||e.removeTarget(n),assert(!t.cause,"WatchChangeAggregator does not handle errored targets");break;case __PRIVATE_WatchTargetChangeState.Tr:e.Kr(n)&&(r.Dr(),r.vr(t.resumeToken));break;case __PRIVATE_WatchTargetChangeState.dr:e.Kr(n)&&(e.qr(n),r.vr(t.resumeToken));break;default:fail("Unknown target watch change state: "+t.state)}}))},t.prototype.kr=function(t,e){t.targetIds.length>0?t.targetIds.forEach(e):__PRIVATE_forEachNumber(this.Or,e)},t.prototype.jr=function(t){var e=t.targetId,n=t.hr.count,r=this.Qr(e);if(r){var i=r.target;if(i.He())if(0===n){var s=new __PRIVATE_DocumentKey(i.path);this.Br(e,s,new __PRIVATE_NoDocument(s,__PRIVATE_SnapshotVersion.W()))}else assert(1===n,"Single document existence filter with count: "+n);else this.Wr(e)!==n&&(this.qr(e),this.Mr=this.Mr.add(e))}},t.prototype.$r=function(t){var e=this,n={};__PRIVATE_forEachNumber(this.Or,(function(r,i){var s=e.Qr(r);if(s){if(i.sr&&s.target.He()){var o=new __PRIVATE_DocumentKey(s.target.path);null!==e.Fr.get(o)||e.Yr(r,o)||e.Br(r,o,new __PRIVATE_NoDocument(o,t))}i.mr&&(n[r]=i.pr(),i.br())}}));var r=__PRIVATE_documentKeySet();this.Nr.forEach((function(t,n){var i=!0;n.Qt((function(t){var n=e.Qr(t);return!n||n.On===__PRIVATE_TargetPurpose.Cn||(i=!1,!1)})),i&&(r=r.add(t))}));var i=new __PRIVATE_RemoteEvent(t,n,this.Mr,this.Fr,r);return this.Fr=__PRIVATE_maybeDocumentMap(),this.Nr=__PRIVATE_documentTargetMap(),this.Mr=new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator),i},t.prototype.Gr=function(t,e){if(this.Kr(t)){var n=this.Yr(t,e.key)?__PRIVATE_ChangeType.Kn:__PRIVATE_ChangeType.kn;this.xr(t).gr(e.key,n),this.Fr=this.Fr.Pt(e.key,e),this.Nr=this.Nr.Pt(e.key,this.Hr(e.key).add(t))}},t.prototype.Br=function(t,e,n){if(this.Kr(t)){var r=this.xr(t);this.Yr(t,e)?r.gr(e,__PRIVATE_ChangeType.xn):r.wr(e),this.Nr=this.Nr.Pt(e,this.Hr(e).delete(t)),n&&(this.Fr=this.Fr.Pt(e,n))}},t.prototype.removeTarget=function(t){delete this.Or[t]},t.prototype.Wr=function(t){var e=this.xr(t).pr();return this.Cr.zr(t).size+e.or.size-e.ar.size},t.prototype.yr=function(t){this.xr(t).yr()},t.prototype.xr=function(t){return this.Or[t]||(this.Or[t]=new __PRIVATE_TargetState),this.Or[t]},t.prototype.Hr=function(t){var e=this.Nr.get(t);return e||(e=new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator),this.Nr=this.Nr.Pt(t,e)),e},t.prototype.Kr=function(t){var e=null!==this.Qr(t);return e||debug(__PRIVATE_LOG_TAG,"Detected inactive target",t),e},t.prototype.Qr=function(t){var e=this.Or[t];return e&&e.Vr?null:this.Cr.Xr(t)},t.prototype.qr=function(t){var e=this;assert(!this.Or[t].Vr,"Should only reset active targets"),this.Or[t]=new __PRIVATE_TargetState,this.Cr.zr(t).forEach((function(n){e.Br(t,n,null)}))},t.prototype.Yr=function(t,e){return this.Cr.zr(t).has(e)},t}();function __PRIVATE_documentTargetMap(){return new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H)}function __PRIVATE_snapshotChangesMap(){return new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H)}var __PRIVATE_DIRECTIONS=function(){var t={};return t[__PRIVATE_Direction.ASCENDING.name]="ASCENDING",t[__PRIVATE_Direction.DESCENDING.name]="DESCENDING",t}(),__PRIVATE_OPERATORS=function(){var t={};return t[__PRIVATE_Operator.LESS_THAN.name]="LESS_THAN",t[__PRIVATE_Operator.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",t[__PRIVATE_Operator.GREATER_THAN.name]="GREATER_THAN",t[__PRIVATE_Operator.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",t[__PRIVATE_Operator.EQUAL.name]="EQUAL",t[__PRIVATE_Operator.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",t[__PRIVATE_Operator.IN.name]="IN",t[__PRIVATE_Operator.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",t}(),__PRIVATE_ISO_REG_EXP=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function __PRIVATE_assertPresent(t,e){assert(!isNullOrUndefined(t),e+" is missing")}function __PRIVATE_parseInt64(t){return"number"==typeof t?t:"string"==typeof t?Number(t):fail("can't parse "+t)}var __PRIVATE_JsonProtoSerializer=function(){function t(t,e){this.o=t,this.options=e}return t.prototype.Jr=function(){return this.options.Zr?"":new Uint8Array(0)},t.prototype.ti=function(t){return t},t.prototype.ei=function(t){var e=void 0===t.code?Code.UNKNOWN:__PRIVATE_mapCodeFromRpcCode(t.code);return new FirestoreError(e,t.message||"")},t.prototype.ni=function(t){return this.options.Zr||isNullOrUndefined(t)?t:{value:t}},t.prototype.ri=function(t){var e;return isNullOrUndefined(e="object"==typeof t?t.value:t)?null:e},t.prototype.Y=function(t){return this.options.Zr?new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")+"."+("000000000"+t.nanoseconds).slice(-9)+"Z":{seconds:""+t.seconds,nanos:t.nanoseconds}},t.prototype.j=function(t){if("string"==typeof t)return this.ii(t);assert(!!t,"Cannot deserialize null or undefined timestamp.");var e=__PRIVATE_parseInt64(t.seconds||"0"),n=t.nanos||0;return new Timestamp(e,n)},t.prototype.ii=function(t){var e=0,n=__PRIVATE_ISO_REG_EXP.exec(t);if(assert(!!n,"invalid timestamp: "+t),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t),s=Math.floor(i.getTime()/1e3);return new Timestamp(s,e)},t.prototype.si=function(t){return this.options.Zr?t.toBase64():this.ti(t.toUint8Array())},t.prototype.oi=function(t){return"string"==typeof t?(assert(this.options.Zr,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Blob.fromBase64String(t)):(assert(!this.options.Zr,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Blob.fromUint8Array(t))},t.prototype.toVersion=function(t){return this.Y(t.Y())},t.prototype.fromVersion=function(t){return assert(!!t,"Trying to deserialize version that isn't set"),__PRIVATE_SnapshotVersion.j(this.j(t))},t.prototype.ui=function(t,e){return this.ai(t).child("documents").child(e).ot()},t.prototype._i=function(t){var e=ResourcePath.ut(t);return assert(this.ci(e),"Tried to deserialize invalid key "+e.toString()),e},t.prototype.hi=function(t){return this.ui(this.o,t.path)},t.prototype.fi=function(t){var e=this._i(t);return assert(e.get(1)===this.o.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.o.projectId),assert(!e.get(3)&&!this.o.database||e.get(3)===this.o.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.o.database),new __PRIVATE_DocumentKey(this.li(e))},t.prototype.Ti=function(t){return this.ui(this.o,t)},t.prototype.di=function(t){var e=this._i(t);return 4===e.length?ResourcePath.at:this.li(e)},Object.defineProperty(t.prototype,"Ei",{get:function(){return new ResourcePath(["projects",this.o.projectId,"databases",this.o.database]).ot()},enumerable:!0,configurable:!0}),t.prototype.ai=function(t){return new ResourcePath(["projects",t.projectId,"databases",t.database])},t.prototype.li=function(t){return assert(t.length>4&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.J(5)},t.prototype.ci=function(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)},t.prototype.Pi=function(t){if(t instanceof __PRIVATE_NullValue)return{nullValue:"NULL_VALUE"};if(t instanceof __PRIVATE_BooleanValue)return{booleanValue:t.value()};if(t instanceof __PRIVATE_IntegerValue)return{integerValue:""+t.value()};if(t instanceof __PRIVATE_DoubleValue){var e=t.value();if(this.options.Zr){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof __PRIVATE_StringValue?{stringValue:t.value()}:t instanceof __PRIVATE_ObjectValue?{mapValue:this.Ai(t)}:t instanceof ArrayValue?{arrayValue:this.Ri(t)}:t instanceof __PRIVATE_TimestampValue?{timestampValue:this.Y(t.Zt)}:t instanceof __PRIVATE_GeoPointValue?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof __PRIVATE_BlobValue?{bytesValue:this.si(t.value())}:t instanceof __PRIVATE_RefValue?{referenceValue:this.ui(t.o,t.key.path)}:fail("Unknown FieldValue "+JSON.stringify(t))},t.prototype.Ii=function(t){var e=this;if("nullValue"in t)return __PRIVATE_NullValue.Le;if("booleanValue"in t)return __PRIVATE_BooleanValue.of(t.booleanValue);if("integerValue"in t)return new __PRIVATE_IntegerValue(__PRIVATE_parseInt64(t.integerValue));if("doubleValue"in t){if(this.options.Zr){if("NaN"===t.doubleValue)return __PRIVATE_DoubleValue.Ue;if("Infinity"===t.doubleValue)return __PRIVATE_DoubleValue.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return __PRIVATE_DoubleValue.NEGATIVE_INFINITY}return new __PRIVATE_DoubleValue(t.doubleValue)}if("stringValue"in t)return new __PRIVATE_StringValue(t.stringValue);if("mapValue"in t)return this.Vi(t.mapValue.fields||{});if("arrayValue"in t){__PRIVATE_assertPresent(t.arrayValue,"arrayValue");var n=t.arrayValue.values||[];return new ArrayValue(n.map((function(t){return e.Ii(t)})))}if("timestampValue"in t)return __PRIVATE_assertPresent(t.timestampValue,"timestampValue"),new __PRIVATE_TimestampValue(this.j(t.timestampValue));if("geoPointValue"in t){__PRIVATE_assertPresent(t.geoPointValue,"geoPointValue");var r=t.geoPointValue.latitude||0,i=t.geoPointValue.longitude||0;return new __PRIVATE_GeoPointValue(new GeoPoint(r,i))}if("bytesValue"in t){__PRIVATE_assertPresent(t.bytesValue,"bytesValue");var s=this.oi(t.bytesValue);return new __PRIVATE_BlobValue(s)}if("referenceValue"in t){__PRIVATE_assertPresent(t.referenceValue,"referenceValue");var o=this._i(t.referenceValue),u=new __PRIVATE_DatabaseId(o.get(1),o.get(3)),a=new __PRIVATE_DocumentKey(this.li(o));return new __PRIVATE_RefValue(u,a)}return fail("Unknown Value proto "+JSON.stringify(t))},t.prototype.mi=function(t,e){return{name:this.hi(t),fields:this.vi(e)}},t.prototype.pi=function(t){return assert(!t.ce,"Can't serialize documents with mutations."),{name:this.hi(t.key),fields:this.vi(t.data()),updateTime:this.Y(t.version.Y())}},t.prototype.bi=function(t,e){var n=this,r=this.fi(t.name),i=this.fromVersion(t.updateTime);return new Document(r,i,{hasCommittedMutations:!!e},void 0,t,(function(t){return n.Ii(t)}))},t.prototype.vi=function(t){var e=this,n={};return t.forEach((function(t,r){n[t]=e.Pi(r)})),n},t.prototype.Vi=function(t){var e=this,n=t,r=__PRIVATE_ObjectValue.EMPTY;return forEach(n,(function(t,n){r=r.set(new FieldPath([t]),e.Ii(n))})),r},t.prototype.Ai=function(t){return{fields:this.vi(t)}},t.prototype.Ri=function(t){var e=this,n=[];return t.forEach((function(t){n.push(e.Pi(t))})),{values:n}},t.prototype.gi=function(t){var e=this;assert(!!t.found,"Tried to deserialize a found document from a missing document."),__PRIVATE_assertPresent(t.found.name,"doc.found.name"),__PRIVATE_assertPresent(t.found.updateTime,"doc.found.updateTime");var n=this.fi(t.found.name),r=this.fromVersion(t.found.updateTime);return new Document(n,r,{},void 0,t.found,(function(t){return e.Ii(t)}))},t.prototype.wi=function(t){assert(!!t.missing,"Tried to deserialize a missing document from a found document."),assert(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fi(t.missing),n=this.fromVersion(t.readTime);return new __PRIVATE_NoDocument(e,n)},t.prototype.yi=function(t){return"found"in t?this.gi(t):"missing"in t?this.wi(t):fail("invalid batch get response: "+JSON.stringify(t))},t.prototype.Si=function(t){switch(t){case __PRIVATE_WatchTargetChangeState.kn:return"ADD";case __PRIVATE_WatchTargetChangeState.Tr:return"CURRENT";case __PRIVATE_WatchTargetChangeState.lr:return"NO_CHANGE";case __PRIVATE_WatchTargetChangeState.xn:return"REMOVE";case __PRIVATE_WatchTargetChangeState.dr:return"RESET";default:return fail("Unknown WatchTargetChangeState: "+t)}},t.prototype.Di=function(t){if(t instanceof __PRIVATE_ExistenceFilterChange)return{filter:{count:t.hr.count,targetId:t.targetId}};if(t instanceof __PRIVATE_DocumentWatchChange){if(t.cr instanceof Document){var e=t.cr;return{documentChange:{document:{name:this.hi(e.key),fields:this.vi(e.data()),updateTime:this.toVersion(e.version)},targetIds:t._r,removedTargetIds:t.removedTargetIds}}}if(t.cr instanceof __PRIVATE_NoDocument){e=t.cr;return{documentDelete:{document:this.hi(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}}}if(null===t.cr)return{documentRemove:{document:this.hi(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof __PRIVATE_WatchTargetChange){var n=void 0;return t.cause&&(n={code:__PRIVATE_mapRpcCodeFromCode(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.Si(t.state),targetIds:t.targetIds,resumeToken:this.ti(t.resumeToken),cause:n}}}return fail("Unrecognized watch change: "+JSON.stringify(t))},t.prototype.Ci=function(t){var e,n=this;if("targetChange"in t){__PRIVATE_assertPresent(t.targetChange,"targetChange");var r=this.Oi(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=t.targetChange.resumeToken||this.Jr(),o=t.targetChange.cause,u=o&&this.ei(o);e=new __PRIVATE_WatchTargetChange(r,i,s,u||null)}else if("documentChange"in t){__PRIVATE_assertPresent(t.documentChange,"documentChange");var a=t.documentChange;__PRIVATE_assertPresent(a.document,"documentChange.name"),__PRIVATE_assertPresent(a.document.name,"documentChange.document.name"),__PRIVATE_assertPresent(a.document.updateTime,"documentChange.document.updateTime");var _=this.fi(a.document.name),c=this.fromVersion(a.document.updateTime),h=new Document(_,c,{},void 0,a.document,(function(t){return n.Ii(t)})),f=a.targetIds||[],l=a.removedTargetIds||[];e=new __PRIVATE_DocumentWatchChange(f,l,h.key,h)}else if("documentDelete"in t){__PRIVATE_assertPresent(t.documentDelete,"documentDelete");var T=t.documentDelete;__PRIVATE_assertPresent(T.document,"documentDelete.document");_=this.fi(T.document),c=T.readTime?this.fromVersion(T.readTime):__PRIVATE_SnapshotVersion.W(),h=new __PRIVATE_NoDocument(_,c),l=T.removedTargetIds||[];e=new __PRIVATE_DocumentWatchChange([],l,h.key,h)}else if("documentRemove"in t){__PRIVATE_assertPresent(t.documentRemove,"documentRemove");var d=t.documentRemove;__PRIVATE_assertPresent(d.document,"documentRemove");_=this.fi(d.document),l=d.removedTargetIds||[];e=new __PRIVATE_DocumentWatchChange([],l,_,null)}else{if(!("filter"in t))return fail("Unknown change type "+JSON.stringify(t));__PRIVATE_assertPresent(t.filter,"filter");var E=t.filter;__PRIVATE_assertPresent(E.targetId,"filter.targetId");var P=E.count||0,A=new ExistenceFilter(P),R=E.targetId;e=new __PRIVATE_ExistenceFilterChange(R,A)}return e},t.prototype.Oi=function(t){return"NO_CHANGE"===t?__PRIVATE_WatchTargetChangeState.lr:"ADD"===t?__PRIVATE_WatchTargetChangeState.kn:"REMOVE"===t?__PRIVATE_WatchTargetChangeState.xn:"CURRENT"===t?__PRIVATE_WatchTargetChangeState.Tr:"RESET"===t?__PRIVATE_WatchTargetChangeState.dr:fail("Got unexpected TargetChange.state: "+t)},t.prototype.Fi=function(t){if(!("targetChange"in t))return __PRIVATE_SnapshotVersion.MIN;var e=t.targetChange;return e.targetIds&&e.targetIds.length?__PRIVATE_SnapshotVersion.MIN:e.readTime?this.fromVersion(e.readTime):__PRIVATE_SnapshotVersion.MIN},t.prototype.Ni=function(t){var e,n=this;if(t instanceof __PRIVATE_SetMutation)e={update:this.mi(t.key,t.value)};else if(t instanceof __PRIVATE_DeleteMutation)e={delete:this.hi(t.key)};else if(t instanceof __PRIVATE_PatchMutation)e={update:this.mi(t.key,t.data),updateMask:this.Mi(t.fe)};else if(t instanceof __PRIVATE_TransformMutation)e={transform:{document:this.hi(t.key),fieldTransforms:t.fieldTransforms.map((function(t){return n.Li(t)}))}};else{if(!(t instanceof __PRIVATE_VerifyMutation))return fail("Unknown mutation type "+t.type);e={verify:this.hi(t.key)}}return t._e.se||(e.currentDocument=this.Gi(t._e)),e},t.prototype.Bi=function(t){var e=this,n=t.currentDocument?this.Ui(t.currentDocument):Precondition.NONE;if(t.update){__PRIVATE_assertPresent(t.update.name,"name");var r=this.fi(t.update.name),i=this.Vi(t.update.fields||{});if(t.updateMask){var s=this.ki(t.updateMask);return new __PRIVATE_PatchMutation(r,i,s,n)}return new __PRIVATE_SetMutation(r,i,n)}if(t.delete){r=this.fi(t.delete);return new __PRIVATE_DeleteMutation(r,n)}if(t.transform){r=this.fi(t.transform.document);var o=t.transform.fieldTransforms.map((function(t){return e.xi(t)}));return assert(!0===n.exists,'Transforms only support precondition "exists == true"'),new __PRIVATE_TransformMutation(r,o)}if(t.verify){r=this.fi(t.verify);return new __PRIVATE_VerifyMutation(r,n)}return fail("unknown mutation proto: "+JSON.stringify(t))},t.prototype.Gi=function(t){return assert(!t.se,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:fail("Unknown precondition")},t.prototype.Ui=function(t){return void 0!==t.updateTime?Precondition.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?Precondition.exists(t.exists):Precondition.NONE},t.prototype.Ki=function(t,e){var n=this,r=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e);r.isEqual(__PRIVATE_SnapshotVersion.MIN)&&(r=this.fromVersion(e));var i=null;return t.transformResults&&t.transformResults.length>0&&(i=t.transformResults.map((function(t){return n.Ii(t)}))),new __PRIVATE_MutationResult(r,i)},t.prototype.qi=function(t,e){var n=this;return t&&t.length>0?(assert(void 0!==e,"Received a write result without a commit time"),t.map((function(t){return n.Ki(t,e)}))):[]},t.prototype.Li=function(t){var e=this,n=t.transform;if(n instanceof __PRIVATE_ServerTimestampTransform)return{fieldPath:t.field.ot(),setToServerValue:"REQUEST_TIME"};if(n instanceof __PRIVATE_ArrayUnionTransformOperation)return{fieldPath:t.field.ot(),appendMissingElements:{values:n.elements.map((function(t){return e.Pi(t)}))}};if(n instanceof __PRIVATE_ArrayRemoveTransformOperation)return{fieldPath:t.field.ot(),removeAllFromArray:{values:n.elements.map((function(t){return e.Pi(t)}))}};if(n instanceof __PRIVATE_NumericIncrementTransformOperation)return{fieldPath:t.field.ot(),increment:this.Pi(n.Jt)};throw fail("Unknown transform: "+t.transform)},t.prototype.xi=function(t){var e=this,n=null;if("setToServerValue"in t)assert("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),n=__PRIVATE_ServerTimestampTransform.instance;else if("appendMissingElements"in t){var r=t.appendMissingElements.values||[];n=new __PRIVATE_ArrayUnionTransformOperation(r.map((function(t){return e.Ii(t)})))}else if("removeAllFromArray"in t){r=t.removeAllFromArray.values||[];n=new __PRIVATE_ArrayRemoveTransformOperation(r.map((function(t){return e.Ii(t)})))}else if("increment"in t){var i=this.Ii(t.increment);assert(i instanceof __PRIVATE_NumberValue,"NUMERIC_ADD transform requires a NumberValue"),n=new __PRIVATE_NumericIncrementTransformOperation(i)}else fail("Unknown transform proto: "+JSON.stringify(t));var s=FieldPath.ft(t.fieldPath);return new FieldTransform(s,n)},t.prototype.ji=function(t){return{documents:[this.Ti(t.path)]}},t.prototype.Qi=function(t){var e=t.documents.length;assert(1===e,"DocumentsTarget contained other than 1 document: "+e);var n=t.documents[0];return Query.rn(this.di(n)).En()},t.prototype.Wi=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(assert(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.Ti(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(assert(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.Ti(n.Z()),e.structuredQuery.from=[{collectionId:n.nt()}]);var r=this.$i(t.filters);r&&(e.structuredQuery.where=r);var i=this.Yi(t.orderBy);i&&(e.structuredQuery.orderBy=i);var s=this.ni(t.limit);return null!==s&&(e.structuredQuery.limit=s),t.startAt&&(e.structuredQuery.startAt=this.Hi(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.Hi(t.endAt)),e},t.prototype.zi=function(t){var e=this.di(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;if(r>0){assert(1===r,"StructuredQuery.from with more than one collection is not supported.");var s=n.from[0];s.allDescendants?i=s.collectionId:e=e.child(s.collectionId)}var o=[];n.where&&(o=this.Xi(n.where));var u=[];n.orderBy&&(u=this.Ji(n.orderBy));var a=null;n.limit&&(a=this.ri(n.limit));var _=null;n.startAt&&(_=this.Zi(n.startAt));var c=null;return n.endAt&&(c=this.Zi(n.endAt)),new Query(e,i,u,o,a,__PRIVATE_LimitType.ze,_,c).En()},t.prototype.ts=function(t){var e=this.es(t.On);return null==e?null:{"goog-listen-tags":e}},t.prototype.es=function(t){switch(t){case __PRIVATE_TargetPurpose.Sn:return null;case __PRIVATE_TargetPurpose.Dn:return"existence-filter-mismatch";case __PRIVATE_TargetPurpose.Cn:return"limbo-document";default:return fail("Unrecognized query purpose: "+t)}},t.prototype.En=function(t){var e,n=t.target;return(e=n.He()?{documents:this.ji(n)}:{query:this.Wi(n)}).targetId=t.targetId,t.resumeToken.length>0&&(e.resumeToken=this.ti(t.resumeToken)),e},t.prototype.$i=function(t){var e=this;if(0!==t.length){var n=t.map((function(t){return t instanceof FieldFilter?e.ns(t):fail("Unrecognized filter: "+JSON.stringify(t))}));return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},t.prototype.Xi=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.rs(t)]:void 0!==t.fieldFilter?[this.ss(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((function(t){return e.Xi(t)})).reduce((function(t,e){return t.concat(e)})):fail("Unknown filter: "+JSON.stringify(t)):[]},t.prototype.Yi=function(t){var e=this;if(0!==t.length)return t.map((function(t){return e.os(t)}))},t.prototype.Ji=function(t){var e=this;return t.map((function(t){return e.us(t)}))},t.prototype.Hi=function(t){var e=this;return{before:t.before,values:t.position.map((function(t){return e.Pi(t)}))}},t.prototype.Zi=function(t){var e=this,n=!!t.before,r=t.values.map((function(t){return e.Ii(t)}));return new __PRIVATE_Bound(r,n)},t.prototype.as=function(t){return __PRIVATE_DIRECTIONS[t.name]},t.prototype._s=function(t){switch(t){case"ASCENDING":return __PRIVATE_Direction.ASCENDING;case"DESCENDING":return __PRIVATE_Direction.DESCENDING;default:return}},t.prototype.cs=function(t){return __PRIVATE_OPERATORS[t.name]},t.prototype.hs=function(t){switch(t){case"EQUAL":return __PRIVATE_Operator.EQUAL;case"GREATER_THAN":return __PRIVATE_Operator.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return __PRIVATE_Operator.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return __PRIVATE_Operator.LESS_THAN;case"LESS_THAN_OR_EQUAL":return __PRIVATE_Operator.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return __PRIVATE_Operator.ARRAY_CONTAINS;case"IN":return __PRIVATE_Operator.IN;case"ARRAY_CONTAINS_ANY":return __PRIVATE_Operator.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return fail("Unspecified operator");default:return fail("Unknown operator")}},t.prototype.fs=function(t){return{fieldPath:t.ot()}},t.prototype.ls=function(t){return FieldPath.ft(t.fieldPath)},t.prototype.os=function(t){return{field:this.fs(t.field),direction:this.as(t.dir)}},t.prototype.us=function(t){return new __PRIVATE_OrderBy(this.ls(t.field),this._s(t.direction))},t.prototype.ss=function(t){return FieldFilter.create(this.ls(t.fieldFilter.field),this.hs(t.fieldFilter.op),this.Ii(t.fieldFilter.value))},t.prototype.ns=function(t){if(t.op===__PRIVATE_Operator.EQUAL){if(t.value.isEqual(__PRIVATE_DoubleValue.Ue))return{unaryFilter:{field:this.fs(t.field),op:"IS_NAN"}};if(t.value.isEqual(__PRIVATE_NullValue.Le))return{unaryFilter:{field:this.fs(t.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.fs(t.field),op:this.cs(t.op),value:this.Pi(t.value)}}},t.prototype.rs=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.ls(t.unaryFilter.field);return FieldFilter.create(e,__PRIVATE_Operator.EQUAL,__PRIVATE_DoubleValue.Ue);case"IS_NULL":var n=this.ls(t.unaryFilter.field);return FieldFilter.create(n,__PRIVATE_Operator.EQUAL,__PRIVATE_NullValue.Le);case"OPERATOR_UNSPECIFIED":return fail("Unspecified filter");default:return fail("Unknown filter")}},t.prototype.Mi=function(t){var e=[];return t.fields.forEach((function(t){return e.push(t.ot())})),{fieldPaths:e}},t.prototype.ki=function(t){var e=(t.fieldPaths||[]).map((function(t){return FieldPath.ft(t)}));return __PRIVATE_FieldMask.ee(e)},t}(),__PRIVATE_PlatformSupport=function(){function t(){}return t.Ts=function(e){t.platform&&fail("Platform already defined"),t.platform=e},t.t=function(){return t.platform||fail("Platform not set"),t.platform},t}();function __PRIVATE_emptyByteString(){return __PRIVATE_PlatformSupport.t().Jr}function __PRIVATE_makeConstructorPrivate(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new FirestoreError(Code.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function __PRIVATE_assertUint8ArrayAvailable(){if("undefined"==typeof Uint8Array)throw new FirestoreError(Code.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function __PRIVATE_assertBase64Available(){if(!__PRIVATE_PlatformSupport.t().ds)throw new FirestoreError(Code.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var __PRIVATE_TimerId,Blob=function(){function t(t){__PRIVATE_assertBase64Available(),this.Es=t}return t.fromBase64String=function(e){__PRIVATE_validateExactNumberOfArgs("Blob.fromBase64String",arguments,1),__PRIVATE_validateArgType("Blob.fromBase64String","string",1,e),__PRIVATE_assertBase64Available();try{var n=__PRIVATE_PlatformSupport.t().atob(e);return new t(n)}catch(t){throw new FirestoreError(Code.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},t.fromUint8Array=function(e){if(__PRIVATE_validateExactNumberOfArgs("Blob.fromUint8Array",arguments,1),__PRIVATE_assertUint8ArrayAvailable(),!(e instanceof Uint8Array))throw __PRIVATE_invalidClassError("Blob.fromUint8Array","Uint8Array",1,e);var n=Array.prototype.map.call(e,(function(t){return String.fromCharCode(t)})).join("");return new t(n)},t.prototype.toBase64=function(){return __PRIVATE_validateExactNumberOfArgs("Blob.toBase64",arguments,0),__PRIVATE_assertBase64Available(),__PRIVATE_PlatformSupport.t().btoa(this.Es)},t.prototype.toUint8Array=function(){__PRIVATE_validateExactNumberOfArgs("Blob.toUint8Array",arguments,0),__PRIVATE_assertUint8ArrayAvailable();for(var t=new Uint8Array(this.Es.length),e=0;e<this.Es.length;e++)t[e]=this.Es.charCodeAt(e);return t},t.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},t.prototype.isEqual=function(t){return this.Es===t.Es},t.prototype.xe=function(){return 2*this.Es.length},t.prototype.K=function(t){return __PRIVATE_primitiveComparator(this.Es,t.Es)},t}(),__PRIVATE_PublicBlob=__PRIVATE_makeConstructorPrivate(Blob,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),__PRIVATE_ListenSequence=function(){function t(t,e){var n=this;this.previousValue=t,e&&(e.Ps=function(t){return n.As(t)},this.Rs=function(t){return e.Is(t)})}return t.prototype.As=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},t.prototype.next=function(){var t=++this.previousValue;return this.Rs&&this.Rs(t),t},t.Vs=-1,t}(),__PRIVATE_Deferred=function(){var t=this;this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))};!function(t){t.ms="all",t.vs="listen_stream_idle",t.ps="listen_stream_connection_backoff",t.bs="write_stream_idle",t.gs="write_stream_connection_backoff",t.ws="online_state_timeout",t.ys="client_metadata_refresh",t.Ss="lru_garbage_collection",t.Ds="retry_transaction"}(__PRIVATE_TimerId||(__PRIVATE_TimerId={}));var __PRIVATE_DelayedOperation=function(){function t(t,e,n,r,i){this.Cs=t,this.Os=e,this.Fs=n,this.op=r,this.Ns=i,this.Ms=new __PRIVATE_Deferred,this.then=this.Ms.promise.then.bind(this.Ms.promise),this.catch=this.Ms.promise.catch.bind(this.Ms.promise),this.Ms.promise.catch((function(t){}))}return t.Ls=function(e,n,r,i,s){var o=new t(e,n,Date.now()+r,i,s);return o.start(r),o},t.prototype.start=function(t){var e=this;this.Gs=setTimeout((function(){return e.Bs()}),t)},t.prototype.Us=function(){return this.Bs()},t.prototype.cancel=function(t){null!==this.Gs&&(this.clearTimeout(),this.Ms.reject(new FirestoreError(Code.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},t.prototype.Bs=function(){var t=this;this.Cs.ks((function(){return null!==t.Gs?(t.clearTimeout(),t.op().then((function(e){return t.Ms.resolve(e)}))):Promise.resolve()}))},t.prototype.clearTimeout=function(){null!==this.Gs&&(this.Ns(this),clearTimeout(this.Gs),this.Gs=null)},t}(),__PRIVATE_AsyncQueue=function(){function t(){this.xs=Promise.resolve(),this.Ks=!1,this.qs=[],this.js=null,this.Qs=!1,this.Ws=[]}return Object.defineProperty(t.prototype,"$s",{get:function(){return this.Ks},enumerable:!0,configurable:!0}),t.prototype.ks=function(t){this.enqueue(t)},t.prototype.Ys=function(t){this.Hs(),this.zs(t)},t.prototype.Xs=function(t){return this.Hs(),this.zs(t)},t.prototype.Js=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(e){switch(e.label){case 0:return this.Hs(),this.Ks?[3,2]:(this.Ks=!0,[4,this.Xs(t)]);case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},t.prototype.enqueue=function(t){return this.Hs(),this.Ks?new Promise((function(t){})):this.zs(t)},t.prototype.zs=function(t){var e=this,n=this.xs.then((function(){return e.Qs=!0,t().catch((function(t){e.js=t,e.Qs=!1;var n=t.stack||t.message||"";throw error("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout((function(){throw t}),0),t})).then((function(t){return e.Qs=!1,t}))}));return this.xs=n,n},t.prototype.Zs=function(t,e,n){var r=this;this.Hs(),assert(e>=0,"Attempted to schedule an operation with a negative delay of "+e),this.Ws.indexOf(t)>-1&&(e=0);var i=__PRIVATE_DelayedOperation.Ls(this,t,e,n,(function(t){return r.to(t)}));return this.qs.push(i),i},t.prototype.Hs=function(){this.js&&fail("AsyncQueue is already failed: "+(this.js.stack||this.js.message))},t.prototype.eo=function(){assert(this.Qs,"verifyOpInProgress() called when no op in progress on this queue.")},t.prototype.no=function(){return this.Xs((function(){return Promise.resolve()}))},t.prototype.ro=function(t){for(var e=0,n=this.qs;e<n.length;e++){if(n[e].Os===t)return!0}return!1},t.prototype.io=function(t){var e=this;return this.no().then((function(){assert(t===__PRIVATE_TimerId.ms||e.ro(t),"Attempted to drain to missing operation "+t),e.qs.sort((function(t,e){return t.Fs-e.Fs}));for(var n=0,r=e.qs;n<r.length;n++){var i=r[n];if(i.Us(),t!==__PRIVATE_TimerId.ms&&i.Os===t)break}return e.no()}))},t.prototype.so=function(t){this.Ws.push(t)},t.prototype.to=function(t){var e=this.qs.indexOf(t);assert(e>=0,"Delayed operation not found."),this.qs.splice(e,1)},t}(),__PRIVATE_escapeChar="",__PRIVATE_encodedSeparatorChar="",__PRIVATE_encodedNul="",__PRIVATE_encodedEscape="";function encode(t){for(var e="",n=0;n<t.length;n++)e.length>0&&(e=__PRIVATE_encodeSeparator(e)),e=__PRIVATE_encodeSegment(t.get(n),e);return __PRIVATE_encodeSeparator(e)}function __PRIVATE_encodeSegment(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var s=t.charAt(i);switch(s){case"\0":n+=__PRIVATE_escapeChar+__PRIVATE_encodedNul;break;case __PRIVATE_escapeChar:n+=__PRIVATE_escapeChar+__PRIVATE_encodedEscape;break;default:n+=s}}return n}function __PRIVATE_encodeSeparator(t){return t+__PRIVATE_escapeChar+__PRIVATE_encodedSeparatorChar}function decode(t){var e=t.length;if(assert(e>=2,"Invalid path "+t),2===e)return assert(t.charAt(0)===__PRIVATE_escapeChar&&t.charAt(1)===__PRIVATE_encodedSeparatorChar,"Non-empty path "+t+" had length 2"),ResourcePath.at;for(var n=e-2,r=[],i="",s=0;s<e;){var o=t.indexOf(__PRIVATE_escapeChar,s);switch((o<0||o>n)&&fail('Invalid encoded resource path: "'+t+'"'),t.charAt(o+1)){case __PRIVATE_encodedSeparatorChar:var u=t.substring(s,o),a=void 0;0===i.length?a=u:(a=i+=u,i=""),r.push(a);break;case __PRIVATE_encodedNul:i+=t.substring(s,o),i+="\0";break;case __PRIVATE_encodedEscape:i+=t.substring(s,o+1);break;default:fail('Invalid encoded resource path: "'+t+'"')}s=o+2}return new ResourcePath(r)}var __PRIVATE_BATCHID_UNKNOWN=-1,__PRIVATE_MutationBatch=function(){function t(t,e,n,r){this.batchId=t,this.ke=e,this.baseMutations=n,this.mutations=r,assert(r.length>0,"Cannot create an empty mutation batch")}return t.prototype.zt=function(t,e,n){e&&assert(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.oo;assert(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var s=this.mutations[i];if(s.key.isEqual(t)){var o=r[i];e=s.zt(e,o)}}return e},t.prototype.Ht=function(t,e){e&&assert(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++){(u=r[n]).key.isEqual(t)&&(e=u.Ht(e,e,this.ke))}for(var i=e,s=0,o=this.mutations;s<o.length;s++){var u;(u=o[s]).key.isEqual(t)&&(e=u.Ht(e,i,this.ke))}return e},t.prototype.uo=function(t){var e=this,n=t;return this.mutations.forEach((function(r){var i=e.Ht(r.key,t.get(r.key));i&&(n=n.Pt(r.key,i))})),n},t.prototype.keys=function(){return this.mutations.reduce((function(t,e){return t.add(e.key)}),__PRIVATE_documentKeySet())},t.prototype.isEqual=function(t){return this.batchId===t.batchId&&__PRIVATE_arrayEquals(this.mutations,t.mutations)&&__PRIVATE_arrayEquals(this.baseMutations,t.baseMutations)},t}(),__PRIVATE_MutationBatchResult=function(){function t(t,e,n,r,i){this.batch=t,this.ao=e,this.oo=n,this.streamToken=r,this._o=i}return t.from=function(e,n,r,i){assert(e.mutations.length===r.length,"Mutations sent "+e.mutations.length+" must equal results received "+r.length);for(var s=__PRIVATE_documentVersionMap(),o=e.mutations,u=0;u<o.length;u++)s=s.Pt(o[u].key,r[u].version);return new t(e,n,r,i,s)},t}(),__PRIVATE_ReferenceSet=function(){function t(){this.co=new __PRIVATE_SortedSet(__PRIVATE_DocReference.qe),this.ho=new __PRIVATE_SortedSet(__PRIVATE_DocReference.fo)}return t.prototype.tt=function(){return this.co.tt()},t.prototype.lo=function(t,e){var n=new __PRIVATE_DocReference(t,e);this.co=this.co.add(n),this.ho=this.ho.add(n)},t.prototype.To=function(t,e){var n=this;t.forEach((function(t){return n.lo(t,e)}))},t.prototype.do=function(t,e){this.Eo(new __PRIVATE_DocReference(t,e))},t.prototype.Po=function(t,e){var n=this;t.forEach((function(t){return n.do(t,e)}))},t.prototype.Ao=function(t){var e=this,n=__PRIVATE_DocumentKey.EMPTY,r=new __PRIVATE_DocReference(n,t),i=new __PRIVATE_DocReference(n,t+1),s=[];return this.ho.jt([r,i],(function(t){e.Eo(t),s.push(t.key)})),s},t.prototype.Ro=function(){var t=this;this.co.forEach((function(e){return t.Eo(e)}))},t.prototype.Eo=function(t){this.co=this.co.delete(t),this.ho=this.ho.delete(t)},t.prototype.Io=function(t){var e=__PRIVATE_DocumentKey.EMPTY,n=new __PRIVATE_DocReference(e,t),r=new __PRIVATE_DocReference(e,t+1),i=__PRIVATE_documentKeySet();return this.ho.jt([n,r],(function(t){i=i.add(t.key)})),i},t.prototype.Vo=function(t){var e=new __PRIVATE_DocReference(t,0),n=this.co.Wt(e);return null!==n&&t.isEqual(n.key)},t}(),__PRIVATE_DocReference=function(){function t(t,e){this.key=t,this.mo=e}return t.qe=function(t,e){return __PRIVATE_DocumentKey.H(t.key,e.key)||__PRIVATE_primitiveComparator(t.mo,e.mo)},t.fo=function(t,e){return __PRIVATE_primitiveComparator(t.mo,e.mo)||__PRIVATE_DocumentKey.H(t.key,e.key)},t}(),__PRIVATE_ObjectMap=function(){function t(t){this.vo=t,this.po={}}return t.prototype.get=function(t){var e=this.vo(t),n=this.po[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var s=i[r],o=s[0],u=s[1];if(o.isEqual(t))return u}},t.prototype.has=function(t){return void 0!==this.get(t)},t.prototype.set=function(t,e){var n=this.vo(t),r=this.po[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.po[n]=[[t,e]]},t.prototype.delete=function(t){var e=this.vo(t),n=this.po[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.po[e]:n.splice(r,1),!0;return!1},t.prototype.forEach=function(t){forEach(this.po,(function(e,n){for(var r=0,i=n;r<i.length;r++){var s=i[r],o=s[0],u=s[1];t(o,u)}}))},t.prototype.tt=function(){return __PRIVATE_isEmpty(this.po)},t}(),PersistencePromise=function(){function t(t){var e=this;this.bo=null,this.wo=null,this.result=void 0,this.error=void 0,this.yo=!1,this.So=!1,t((function(t){e.yo=!0,e.result=t,e.bo&&e.bo(t)}),(function(t){e.yo=!0,e.error=t,e.wo&&e.wo(t)}))}return t.prototype.catch=function(t){return this.next(void 0,t)},t.prototype.next=function(e,n){var r=this;return this.So&&fail("Called next() or catch() twice for PersistencePromise"),this.So=!0,this.yo?this.error?this.Do(n,this.error):this.Co(e,this.result):new t((function(t,i){r.bo=function(n){r.Co(e,n).next(t,i)},r.wo=function(e){r.Do(n,e).next(t,i)}}))},t.prototype.Oo=function(){var t=this;return new Promise((function(e,n){t.next(e,n)}))},t.prototype.Fo=function(e){try{var n=e();return n instanceof t?n:t.resolve(n)}catch(e){return t.reject(e)}},t.prototype.Co=function(e,n){return e?this.Fo((function(){return e(n)})):t.resolve(n)},t.prototype.Do=function(e,n){return e?this.Fo((function(){return e(n)})):t.reject(n)},t.resolve=function(e){return new t((function(t,n){t(e)}))},t.reject=function(e){return new t((function(t,n){n(e)}))},t.No=function(e){return new t((function(t,n){var r=0,i=0,s=!1;e.forEach((function(e){++r,e.next((function(){++i,s&&i===r&&t()}),(function(t){return n(t)}))})),s=!0,i===r&&t()}))},t.Mo=function(e){for(var n=t.resolve(!1),r=function(e){n=n.next((function(n){return n?t.resolve(n):e()}))},i=0,s=e;i<s.length;i++){r(s[i])}return n},t.forEach=function(t,e){var n=this,r=[];return t.forEach((function(t,i){r.push(e.call(n,t,i))})),this.No(r)},t}(),__PRIVATE_RemoteDocumentChangeBuffer=function(){function t(){this.Lo=new __PRIVATE_ObjectMap((function(t){return t.toString()})),this.Go=!1}return Object.defineProperty(t.prototype,"readTime",{get:function(){return assert(void 0!==this.Bo,"Read time is not set. All removeEntry() calls must include a readTime if `trackRemovals` is used."),this.Bo},set:function(t){assert(void 0===this.Bo||this.Bo.isEqual(t),"All changes in a RemoteDocumentChangeBuffer must have the same read time"),this.Bo=t},enumerable:!0,configurable:!0}),t.prototype.Uo=function(t,e){this.ko(),this.readTime=e,this.Lo.set(t.key,t)},t.prototype.xo=function(t,e){this.ko(),e&&(this.readTime=e),this.Lo.set(t,null)},t.prototype.Ko=function(t,e){this.ko();var n=this.Lo.get(e);return void 0!==n?PersistencePromise.resolve(n):this.qo(t,e)},t.prototype.getEntries=function(t,e){return this.jo(t,e)},t.prototype.apply=function(t){return this.ko(),this.Go=!0,this.Qo(t)},t.prototype.ko=function(){assert(!this.Go,"Changes have already been applied.")},t}(),__PRIVATE_PRIMARY_LEASE_LOST_ERROR_MSG="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",__PRIVATE_PersistenceTransaction=function(){function t(){this.Wo=[]}return t.prototype.$o=function(t){this.Wo.push(t)},t.prototype.Yo=function(){this.Wo.forEach((function(t){return t()}))},t}(),__PRIVATE_LOG_TAG$1="SimpleDb",__PRIVATE_TRANSACTION_RETRY_COUNT=3,__PRIVATE_SimpleDb=function(){function t(e){this.db=e,12.2===t.Ho(util.getUA())&&error("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}return t.zo=function(e,n,r){return assert(t.Xo(),"IndexedDB not supported in current environment."),debug(__PRIVATE_LOG_TAG$1,"Opening database:",e),new PersistencePromise((function(i,s){var o=window.indexedDB.open(e,n);o.onsuccess=function(e){var n=e.target.result;i(new t(n))},o.onblocked=function(){s(new FirestoreError(Code.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},o.onerror=function(t){var e=t.target.error;"VersionError"===e.name?s(new FirestoreError(Code.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):s(e)},o.onupgradeneeded=function(t){debug(__PRIVATE_LOG_TAG$1,'Database "'+e+'" requires upgrade from version:',t.oldVersion);var n=t.target.result;r.createOrUpgrade(n,o.transaction,t.oldVersion,SCHEMA_VERSION).next((function(){debug(__PRIVATE_LOG_TAG$1,"Database upgrade to version "+SCHEMA_VERSION+" complete")}))}})).Oo()},t.delete=function(t){return debug(__PRIVATE_LOG_TAG$1,"Removing database:",t),__PRIVATE_wrapRequest(window.indexedDB.deleteDatabase(t)).Oo()},t.Xo=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(t.Jo())return!0;if(void 0===window.navigator)return!1;var e=util.getUA(),n=t.Ho(e),r=0<n&&n<10,i=t.Zo(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||s)},t.Jo=function(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.tu)},t.eu=function(t,e){return t.store(e)},t.Ho=function(t){var e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)},t.Zo=function(t){var e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)},t.prototype.nu=function(t){this.db.onversionchange=function(e){return t(e)}},t.prototype.runTransaction=function(t,e,n){return tslib.__awaiter(this,void 0,void 0,(function(){var r,i,s,o,u,a;return tslib.__generator(this,(function(_){switch(_.label){case 0:r=t.startsWith("readonly"),i=t.endsWith("idempotent"),s=0,o=function(){var t,o,a,_;return tslib.__generator(this,(function(c){switch(c.label){case 0:++s,t=__PRIVATE_SimpleDbTransaction.open(u.db,r?"readonly":"readwrite",e),c.label=1;case 1:return c.trys.push([1,3,,4]),(o=n(t).catch((function(e){return t.abort(e),PersistencePromise.reject(e)})).Oo()).catch((function(){})),[4,t.ru];case 2:return c.sent(),[2,{value:o}];case 3:return a=c.sent(),_=i&&"FirebaseError"!==a.name&&s<__PRIVATE_TRANSACTION_RETRY_COUNT,debug(__PRIVATE_LOG_TAG$1,"Transaction failed with error: %s. Retrying: %s.",a.message,_),_?[3,4]:[2,{value:Promise.reject(a)}];case 4:return[2]}}))},u=this,_.label=1;case 1:return[5,o()];case 2:return"object"==typeof(a=_.sent())?[2,a.value]:[3,1];case 3:return[2]}}))}))},t.prototype.close=function(){this.db.close()},t}(),__PRIVATE_IterationController=function(){function t(t){this.iu=t,this.su=!1,this.ou=null}return Object.defineProperty(t.prototype,"yo",{get:function(){return this.su},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uu",{get:function(){return this.ou},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cursor",{set:function(t){this.iu=t},enumerable:!0,configurable:!0}),t.prototype.done=function(){this.su=!0},t.prototype.au=function(t){this.ou=t},t.prototype.delete=function(){return __PRIVATE_wrapRequest(this.iu.delete())},t}(),__PRIVATE_SimpleDbTransaction=function(){function t(t){var e=this;this.transaction=t,this.aborted=!1,this._u=new __PRIVATE_Deferred,this.transaction.oncomplete=function(){e._u.resolve()},this.transaction.onabort=function(){t.error?e._u.reject(t.error):e._u.resolve()},this.transaction.onerror=function(t){var n=__PRIVATE_checkForAndReportiOSError(t.target.error);e._u.reject(n)}}return t.open=function(e,n,r){return new t(e.transaction(r,n))},Object.defineProperty(t.prototype,"ru",{get:function(){return this._u.promise},enumerable:!0,configurable:!0}),t.prototype.abort=function(t){t&&this._u.reject(t),this.aborted||(debug(__PRIVATE_LOG_TAG$1,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},t.prototype.store=function(t){var e=this.transaction.objectStore(t);return assert(!!e,"Object store not part of transaction: "+t),new __PRIVATE_SimpleDbStore(e)},t}(),__PRIVATE_SimpleDbStore=function(){function t(t){this.store=t}return t.prototype.put=function(t,e){var n;return void 0!==e?(debug(__PRIVATE_LOG_TAG$1,"PUT",this.store.name,t,e),n=this.store.put(e,t)):(debug(__PRIVATE_LOG_TAG$1,"PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),__PRIVATE_wrapRequest(n)},t.prototype.add=function(t){return debug(__PRIVATE_LOG_TAG$1,"ADD",this.store.name,t,t),__PRIVATE_wrapRequest(this.store.add(t))},t.prototype.get=function(t){var e=this;return __PRIVATE_wrapRequest(this.store.get(t)).next((function(n){return void 0===n&&(n=null),debug(__PRIVATE_LOG_TAG$1,"GET",e.store.name,t,n),n}))},t.prototype.delete=function(t){return debug(__PRIVATE_LOG_TAG$1,"DELETE",this.store.name,t),__PRIVATE_wrapRequest(this.store.delete(t))},t.prototype.count=function(){return debug(__PRIVATE_LOG_TAG$1,"COUNT",this.store.name),__PRIVATE_wrapRequest(this.store.count())},t.prototype.cu=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.hu(n,(function(t,e){r.push(e)})).next((function(){return r}))},t.prototype.fu=function(t,e){debug(__PRIVATE_LOG_TAG$1,"DELETE ALL",this.store.name);var n=this.options(t,e);n.lu=!1;var r=this.cursor(n);return this.hu(r,(function(t,e,n){return n.delete()}))},t.prototype.Tu=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.hu(r,e)},t.prototype.du=function(t){var e=this.cursor({});return new PersistencePromise((function(n,r){e.onerror=function(t){var e=__PRIVATE_checkForAndReportiOSError(t.target.error);r(e)},e.onsuccess=function(e){var r=e.target.result;r?t(r.primaryKey,r.value).next((function(t){t?r.continue():n()})):n()}}))},t.prototype.hu=function(t,e){var n=[];return new PersistencePromise((function(r,i){t.onerror=function(t){i(t.target.error)},t.onsuccess=function(t){var i=t.target.result;if(i){var s=new __PRIVATE_IterationController(i),o=e(i.primaryKey,i.value,s);if(o instanceof PersistencePromise){var u=o.catch((function(t){return s.done(),PersistencePromise.reject(t)}));n.push(u)}s.yo?r():null===s.uu?i.continue():i.continue(s.uu)}else r()}})).next((function(){return PersistencePromise.No(n)}))},t.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(assert(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},t.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.lu?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},t}();function __PRIVATE_wrapRequest(t){return new PersistencePromise((function(e,n){t.onsuccess=function(t){var n=t.target.result;e(n)},t.onerror=function(t){var e=__PRIVATE_checkForAndReportiOSError(t.target.error);n(e)}}))}var __PRIVATE_reportedIOSError=!1;function __PRIVATE_checkForAndReportiOSError(t){var e=__PRIVATE_SimpleDb.Ho(util.getUA());if(e>=12.2&&e<13){var n="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(n)>=0){var r=new FirestoreError("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+n+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return __PRIVATE_reportedIOSError||(__PRIVATE_reportedIOSError=!0,setTimeout((function(){throw r}),0)),r}}return t}var __PRIVATE_IndexedDbMutationQueue=function(){function t(t,e,n,r){this.userId=t,this.serializer=e,this.Eu=n,this.Pu=r,this.Au={}}return t.Ru=function(e,n,r,i){return assert(""!==e.uid,"UserID must not be an empty string."),new t(e.R()?e.uid:"",n,r,i)},t.prototype.Iu=function(t){var e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return __PRIVATE_mutationsStore(t).Tu({index:DbMutationBatch.userMutationsIndex,range:n},(function(t,n,r){e=!1,r.done()})).next((function(){return e}))},t.prototype.Vu=function(t,e,n){return this.mu(t).next((function(e){return e.lastStreamToken=__PRIVATE_convertStreamToken(n),__PRIVATE_mutationQueuesStore(t).put(e)}))},t.prototype.vu=function(t){return this.mu(t).next((function(t){return t.lastStreamToken}))},t.prototype.pu=function(t,e){return this.mu(t).next((function(n){return n.lastStreamToken=__PRIVATE_convertStreamToken(e),__PRIVATE_mutationQueuesStore(t).put(n)}))},t.prototype.bu=function(t,e,n,r){var i=this,s=__PRIVATE_documentMutationsStore(t),o=__PRIVATE_mutationsStore(t);return o.add({}).next((function(u){assert("number"==typeof u,"Auto-generated key is not a number");for(var a=new __PRIVATE_MutationBatch(u,e,n,r),_=i.serializer.gu(i.userId,a),c=[],h=new __PRIVATE_SortedSet((function(t,e){return __PRIVATE_primitiveComparator(t.ot(),e.ot())})),f=0,l=r;f<l.length;f++){var T=l[f],d=DbDocumentMutation.key(i.userId,T.key.path,u);h=h.add(T.key.path.Z()),c.push(o.put(_)),c.push(s.put(d,DbDocumentMutation.PLACEHOLDER))}return h.forEach((function(e){c.push(i.Eu.wu(t,e))})),t.$o((function(){i.Au[u]=a.keys()})),PersistencePromise.No(c).next((function(){return a}))}))},t.prototype.yu=function(t,e){var n=this;return __PRIVATE_mutationsStore(t).get(e).next((function(t){return t?(assert(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.Su(t)):null}))},t.prototype.Du=function(t,e){var n=this;return this.Au[e]?PersistencePromise.resolve(this.Au[e]):this.yu(t,e).next((function(t){if(t){var r=t.keys();return n.Au[e]=r,r}return null}))},t.prototype.Cu=function(t,e){var n=this,r=e+1,i=IDBKeyRange.lowerBound([this.userId,r]),s=null;return __PRIVATE_mutationsStore(t).Tu({index:DbMutationBatch.userMutationsIndex,range:i},(function(t,e,i){e.userId===n.userId&&(assert(e.batchId>=r,"Should have found mutation after "+r),s=n.serializer.Su(e)),i.done()})).next((function(){return s}))},t.prototype.Ou=function(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=__PRIVATE_BATCHID_UNKNOWN;return __PRIVATE_mutationsStore(t).Tu({index:DbMutationBatch.userMutationsIndex,range:e,reverse:!0},(function(t,e,r){n=e.batchId,r.done()})).next((function(){return n}))},t.prototype.Fu=function(t){var e=this,n=IDBKeyRange.bound([this.userId,__PRIVATE_BATCHID_UNKNOWN],[this.userId,Number.POSITIVE_INFINITY]);return __PRIVATE_mutationsStore(t).cu(DbMutationBatch.userMutationsIndex,n).next((function(t){return t.map((function(t){return e.serializer.Su(t)}))}))},t.prototype.Nu=function(t,e){var n=this,r=DbDocumentMutation.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),s=[];return __PRIVATE_documentMutationsStore(t).Tu({range:i},(function(r,i,o){var u=r[0],a=r[1],_=r[2],c=decode(a);if(u===n.userId&&e.path.isEqual(c))return __PRIVATE_mutationsStore(t).get(_).next((function(t){if(!t)throw fail("Dangling document-mutation reference found: "+r+" which points to "+_);assert(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+_),s.push(n.serializer.Su(t))}));o.done()})).next((function(){return s}))},t.prototype.Mu=function(t,e){var n=this,r=new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator),i=[];return e.forEach((function(e){var s=DbDocumentMutation.prefixForPath(n.userId,e.path),o=IDBKeyRange.lowerBound(s),u=__PRIVATE_documentMutationsStore(t).Tu({range:o},(function(t,i,s){var o=t[0],u=t[1],a=t[2],_=decode(u);o===n.userId&&e.path.isEqual(_)?r=r.add(a):s.done()}));i.push(u)})),PersistencePromise.No(i).next((function(){return n.Lu(t,r)}))},t.prototype.Gu=function(t,e){var n=this;assert(!e.He(),"Document queries shouldn't go down this path"),assert(!e.bn(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=e.path,i=r.length+1,s=DbDocumentMutation.prefixForPath(this.userId,r),o=IDBKeyRange.lowerBound(s),u=new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator);return __PRIVATE_documentMutationsStore(t).Tu({range:o},(function(t,e,s){var o=t[0],a=t[1],_=t[2],c=decode(a);o===n.userId&&r.rt(c)?c.length===i&&(u=u.add(_)):s.done()})).next((function(){return n.Lu(t,u)}))},t.prototype.Lu=function(t,e){var n=this,r=[],i=[];return e.forEach((function(e){i.push(__PRIVATE_mutationsStore(t).get(e).next((function(t){if(null===t)throw fail("Dangling document-mutation reference found, which points to "+e);assert(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.Su(t))})))})),PersistencePromise.No(i).next((function(){return r}))},t.prototype.Bu=function(t,e){var n=this;return __PRIVATE_removeMutationBatch(t.Uu,this.userId,e).next((function(r){return t.$o((function(){n.ku(e.batchId)})),PersistencePromise.forEach(r,(function(e){return n.Pu.xu(t,e)}))}))},t.prototype.ku=function(t){delete this.Au[t]},t.prototype.Ku=function(t){var e=this;return this.Iu(t).next((function(n){if(!n)return PersistencePromise.resolve();var r=IDBKeyRange.lowerBound(DbDocumentMutation.prefixForUser(e.userId)),i=[];return __PRIVATE_documentMutationsStore(t).Tu({range:r},(function(t,n,r){if(t[0]===e.userId){var s=decode(t[1]);i.push(s)}else r.done()})).next((function(){assert(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map((function(t){return t.ot()})))}))}))},t.prototype.Vo=function(t,e){return __PRIVATE_mutationQueueContainsKey(t,this.userId,e)},t.prototype.mu=function(t){var e=this;return __PRIVATE_mutationQueuesStore(t).get(this.userId).next((function(t){return t||new DbMutationQueue(e.userId,__PRIVATE_BATCHID_UNKNOWN,"")}))},t}();function __PRIVATE_mutationQueueContainsKey(t,e,n){var r=DbDocumentMutation.prefixForPath(e,n.path),i=r[1],s=IDBKeyRange.lowerBound(r),o=!1;return __PRIVATE_documentMutationsStore(t).Tu({range:s,lu:!0},(function(t,n,r){var s=t[0],u=t[1];t[2];s===e&&u===i&&(o=!0),r.done()})).next((function(){return o}))}function __PRIVATE_mutationQueuesContainKey(t,e){var n=!1;return __PRIVATE_mutationQueuesStore(t).du((function(r){return __PRIVATE_mutationQueueContainsKey(t,r,e).next((function(t){return t&&(n=!0),PersistencePromise.resolve(!t)}))})).next((function(){return n}))}function __PRIVATE_removeMutationBatch(t,e,n){var r=t.store(DbMutationBatch.store),i=t.store(DbDocumentMutation.store),s=[],o=IDBKeyRange.only(n.batchId),u=0,a=r.Tu({range:o},(function(t,e,n){return u++,n.delete()}));s.push(a.next((function(){assert(1===u,"Dangling document-mutation reference found: Missing batch "+n.batchId)})));for(var _=[],c=0,h=n.mutations;c<h.length;c++){var f=h[c],l=DbDocumentMutation.key(e,f.key.path,n.batchId);s.push(i.delete(l)),_.push(f.key)}return PersistencePromise.No(s).next((function(){return _}))}function __PRIVATE_convertStreamToken(t){return t instanceof Uint8Array?(assert(__PRIVATE_SimpleDb.Jo(),"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function __PRIVATE_mutationsStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbMutationBatch.store)}function __PRIVATE_documentMutationsStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbDocumentMutation.store)}function __PRIVATE_mutationQueuesStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbMutationQueue.store)}var __PRIVATE_GeneratorIds,__PRIVATE_RESERVED_BITS=1;!function(t){t[t.qu=0]="__PRIVATE_QueryCache",t[t.ju=1]="__PRIVATE_SyncEngine"}(__PRIVATE_GeneratorIds||(__PRIVATE_GeneratorIds={}));var __PRIVATE_TargetIdGenerator=function(){function t(t,e){this.Qu=t,assert((t&__PRIVATE_RESERVED_BITS)===t,"Generator ID "+t+" contains more than "+__PRIVATE_RESERVED_BITS+" reserved bits"),this.Wu(void 0!==e?e:this.Qu)}return t.prototype.next=function(){var t=this.$u;return this.$u+=1<<__PRIVATE_RESERVED_BITS,t},t.prototype.after=function(t){return this.Wu(t+(1<<__PRIVATE_RESERVED_BITS)),this.next()},t.prototype.Wu=function(t){assert((t&__PRIVATE_RESERVED_BITS)===this.Qu,"Cannot supply target ID from different generator ID"),this.$u=t},t.Yu=function(){return new t(__PRIVATE_GeneratorIds.qu,2)},t.Hu=function(){return new t(__PRIVATE_GeneratorIds.ju)},t}(),__PRIVATE_LocalDocumentsView=function(){function t(t,e,n){this.zu=t,this.Xu=e,this.Eu=n}return t.prototype.Ju=function(t,e){var n=this;return this.Xu.Nu(t,e).next((function(r){return n.Zu(t,e,r)}))},t.prototype.Zu=function(t,e,n){return this.zu.Ko(t,e).next((function(t){for(var r=0,i=n;r<i.length;r++){t=i[r].Ht(e,t)}return t}))},t.prototype.ta=function(t,e,n){var r=__PRIVATE_nullableMaybeDocumentMap();return e.forEach((function(t,e){for(var i=0,s=n;i<s.length;i++){e=s[i].Ht(t,e)}r=r.Pt(t,e)})),r},t.prototype.ea=function(t,e){var n=this;return this.zu.getEntries(t,e).next((function(e){return n.na(t,e)}))},t.prototype.na=function(t,e){var n=this;return this.Xu.Mu(t,e).next((function(r){var i=n.ta(t,e,r),s=__PRIVATE_maybeDocumentMap();return i.forEach((function(t,e){e||(e=new __PRIVATE_NoDocument(t,__PRIVATE_SnapshotVersion.W())),s=s.Pt(t,e)})),s}))},t.prototype.ra=function(t,e,n){return e.He()?this.ia(t,e.path):e.bn()?this.sa(t,e,n):this.oa(t,e,n)},t.prototype.ia=function(t,e){return this.Ju(t,new __PRIVATE_DocumentKey(e)).next((function(t){var e=__PRIVATE_documentMap();return t instanceof Document&&(e=e.Pt(t.key,t)),e}))},t.prototype.sa=function(t,e,n){var r=this;assert(e.path.tt(),"Currently we only support collection group queries at the root.");var i=e.collectionGroup,s=__PRIVATE_documentMap();return this.Eu.ua(t,i).next((function(o){return PersistencePromise.forEach(o,(function(o){var u=e.Tn(o.child(i));return r.oa(t,u,n).next((function(t){t.forEach((function(t,e){s=s.Pt(t,e)}))}))})).next((function(){return s}))}))},t.prototype.oa=function(t,e,n){var r,i,s=this;return this.zu.ra(t,e,n).next((function(n){return r=n,s.Xu.Gu(t,e)})).next((function(e){return i=e,s.aa(t,i,r).next((function(t){r=t;for(var e=0,n=i;e<n.length;e++)for(var s=n[e],o=0,u=s.mutations;o<u.length;o++){var a=u[o],_=a.key,c=r.get(_),h=a.Ht(c,c,s.ke);r=h instanceof Document?r.Pt(_,h):r.remove(_)}}))})).next((function(){return r.forEach((function(t,n){e.matches(n)||(r=r.remove(t))})),r}))},t.prototype.aa=function(t,e,n){for(var r=__PRIVATE_documentKeySet(),i=0,s=e;i<s.length;i++)for(var o=0,u=s[i].mutations;o<u.length;o++){var a=u[o];a instanceof __PRIVATE_PatchMutation&&null===n.get(a.key)&&(r=r.add(a.key))}var _=n;return this.zu.getEntries(t,r).next((function(t){return t.forEach((function(t,e){null!==e&&e instanceof Document&&(_=_.Pt(t,e))})),_}))},t}(),__PRIVATE_LocalViewChanges=function(){function t(t,e,n,r){this.targetId=t,this.fromCache=e,this._a=n,this.ca=r}return t.ha=function(e,n){for(var r=__PRIVATE_documentKeySet(),i=__PRIVATE_documentKeySet(),s=0,o=n.docChanges;s<o.length;s++){var u=o[s];switch(u.type){case __PRIVATE_ChangeType.kn:r=r.add(u.doc.key);break;case __PRIVATE_ChangeType.xn:i=i.add(u.doc.key)}}return new t(e,n.fromCache,r,i)},t}(),__PRIVATE_LOG_TAG$2="LocalStore",__PRIVATE_LocalStore=function(){function t(t,e,n){this.persistence=t,this.fa=e,this.la=new __PRIVATE_ReferenceSet,this.Ta=new __PRIVATE_SortedMap(__PRIVATE_primitiveComparator),this.da=new __PRIVATE_ObjectMap((function(t){return t.canonicalId()})),this.Ea=__PRIVATE_SnapshotVersion.MIN,assert(t.Pa,"LocalStore was passed an unstarted persistence implementation"),this.persistence.Pu.Aa(this.la),this.Xu=t.Ra(n),this.Ia=t.Va(),this.ma=t.va(),this.pa=new __PRIVATE_LocalDocumentsView(this.Ia,this.Xu,this.persistence.ba()),this.fa.ga(this.pa)}return t.prototype.start=function(){return this.wa()},t.prototype.ya=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n,r,i=this;return tslib.__generator(this,(function(s){switch(s.label){case 0:return e=this.Xu,n=this.pa,[4,this.persistence.runTransaction("Handle user change","readonly-idempotent",(function(r){var s;return i.Xu.Fu(r).next((function(o){return s=o,e=i.persistence.Ra(t),n=new __PRIVATE_LocalDocumentsView(i.Ia,e,i.persistence.ba()),e.Fu(r)})).next((function(t){for(var e=[],i=[],o=__PRIVATE_documentKeySet(),u=0,a=s;u<a.length;u++){var _=a[u];e.push(_.batchId);for(var c=0,h=_.mutations;c<h.length;c++){var f=h[c];o=o.add(f.key)}}for(var l=0,T=t;l<T.length;l++){_=T[l];i.push(_.batchId);for(var d=0,E=_.mutations;d<E.length;d++){f=E[d];o=o.add(f.key)}}return n.ea(r,o).next((function(t){return{Sa:t,Da:e,Ca:i}}))}))}))];case 1:return r=s.sent(),this.Xu=e,this.pa=n,this.fa.ga(this.pa),[2,r]}}))}))},t.prototype.Oa=function(t){var e,n=this,r=Timestamp.now(),i=t.reduce((function(t,e){return t.add(e.key)}),__PRIVATE_documentKeySet());return this.persistence.runTransaction("Locally write mutations","readwrite-idempotent",(function(s){return n.pa.ea(s,i).next((function(i){e=i;for(var o=[],u=0,a=t;u<a.length;u++){var _=a[u],c=_.he(e.get(_.key));null!=c&&o.push(new __PRIVATE_PatchMutation(_.key,c,c.fe(),Precondition.exists(!0)))}return n.Xu.bu(s,r,o,t)}))})).then((function(t){var n=t.uo(e);return{batchId:t.batchId,Lo:n}}))},t.prototype.Fa=function(t){var e=this;return this.persistence.runTransaction("Lookup mutation documents","readonly-idempotent",(function(n){return e.Xu.Du(n,t).next((function(t){return t?e.pa.ea(n,t):PersistencePromise.resolve(null)}))}))},t.prototype.Vu=function(t){var e=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary-idempotent",(function(n){var r=t.batch.keys(),i=e.Ia.Na({Ma:!0});return e.Xu.Vu(n,t.batch,t.streamToken).next((function(){return e.La(n,t,i)})).next((function(){return i.apply(n)})).next((function(){return e.Xu.Ku(n)})).next((function(){return e.pa.ea(n,r)}))}))},t.prototype.Ga=function(t){var e=this;return this.persistence.runTransaction("Reject batch","readwrite-primary-idempotent",(function(n){var r;return e.Xu.yu(n,t).next((function(t){return assert(null!==t,"Attempt to reject nonexistent batch!"),r=t.keys(),e.Xu.Bu(n,t)})).next((function(){return e.Xu.Ku(n)})).next((function(){return e.pa.ea(n,r)}))}))},t.prototype.Ou=function(){var t=this;return this.persistence.runTransaction("Get highest unacknowledged batch id","readonly-idempotent",(function(e){return t.Xu.Ou(e)}))},t.prototype.vu=function(){var t=this;return this.persistence.runTransaction("Get last stream token","readonly-idempotent",(function(e){return t.Xu.vu(e)}))},t.prototype.pu=function(t){var e=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary-idempotent",(function(n){return e.Xu.pu(n,t)}))},t.prototype.Ba=function(){var t=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly-idempotent",(function(e){return t.ma.Ba(e)}))},t.prototype.Ua=function(e){var n=this,r=e.Fn,i=this.Ta;return this.persistence.runTransaction("Apply remote event","readwrite-primary-idempotent",(function(s){var o=n.Ia.Na({Ma:!0});i=n.Ta;var u=[];__PRIVATE_forEachNumber(e.Zn,(function(e,o){var a=i.get(e);if(a){u.push(n.ma.ka(s,o.ar,e).next((function(){return n.ma.xa(s,o.or,e)})));var _=o.resumeToken;if(_.length>0){var c=a.Mn(_,r).Nn(s.Ka);i=i.Pt(e,c),t.qa(a,c,o)&&u.push(n.ma.ja(s,c))}}}));var a=__PRIVATE_maybeDocumentMap(),_=__PRIVATE_documentKeySet();if(e.er.forEach((function(t,e){_=_.add(t)})),u.push(o.getEntries(s,_).next((function(t){e.er.forEach((function(i,_){var c=t.get(i);_ instanceof __PRIVATE_NoDocument&&_.version.isEqual(__PRIVATE_SnapshotVersion.MIN)?(o.xo(i,r),a=a.Pt(i,_)):null==c||_.version._(c.version)>0||0===_.version._(c.version)&&c.hasPendingWrites?(assert(!__PRIVATE_SnapshotVersion.MIN.isEqual(r),"Cannot add a document when the remote version is zero"),o.Uo(_,r),a=a.Pt(i,_)):debug(__PRIVATE_LOG_TAG$2,"Ignoring outdated watch update for ",i,". Current version:",c.version," Watch version:",_.version),e.nr.has(i)&&u.push(n.persistence.Pu.Qa(s,i))}))}))),!r.isEqual(__PRIVATE_SnapshotVersion.MIN)){var c=n.ma.Ba(s).next((function(t){return assert(r._(t)>=0,"Watch stream reverted to previous snapshot?? "+r+" < "+t),n.ma.Wa(s,s.Ka,r)}));u.push(c)}return PersistencePromise.No(u).next((function(){return o.apply(s)})).next((function(){return n.pa.na(s,a)}))})).then((function(t){return n.Ta=i,t}))},t.qa=function(t,e,n){return assert(e.resumeToken.length>0,"Attempted to persist target data with no resume token"),0===t.resumeToken.length||(e.Fn.$()-t.Fn.$()>=this.$a||n.or.size+n.ur.size+n.ar.size>0)},t.prototype.Ya=function(t){for(var e=this,n=0,r=t;n<r.length;n++){var i=r[n],s=i.targetId;if(this.la.To(i._a,s),this.la.Po(i.ca,s),!i.fromCache){var o=this.Ta.get(s);assert(null!==o,"Can't set limbo-free snapshot version for unknown target: "+s);var u=o.Fn,a=o.Ln(u);this.Ta=this.Ta.Pt(s,a)}}return this.persistence.runTransaction("notifyLocalViewChanges","readwrite-idempotent",(function(n){return PersistencePromise.forEach(t,(function(t){return PersistencePromise.forEach(t.ca,(function(t){return e.persistence.Pu.do(n,t)}))}))}))},t.prototype.Ha=function(t){var e=this;return this.persistence.runTransaction("Get next mutation batch","readonly-idempotent",(function(n){return void 0===t&&(t=__PRIVATE_BATCHID_UNKNOWN),e.Xu.Cu(n,t)}))},t.prototype.za=function(t){var e=this;return this.persistence.runTransaction("read document","readonly-idempotent",(function(n){return e.pa.Ju(n,t)}))},t.prototype.Xa=function(t){var e=this;return this.persistence.runTransaction("Allocate target","readwrite-idempotent",(function(n){var r;return e.ma.Ja(n,t).next((function(i){return i?(r=i,PersistencePromise.resolve(r)):e.ma.Za(n).next((function(i){return r=new __PRIVATE_TargetData(t,i,__PRIVATE_TargetPurpose.Sn,n.Ka),e.ma.t_(n,r).next((function(){return r}))}))}))})).then((function(n){return null===e.Ta.get(n.targetId)&&(e.Ta=e.Ta.Pt(n.targetId,n),e.da.set(t,n.targetId)),n}))},t.prototype.Ja=function(t,e){var n=this.da.get(e);return void 0!==n?PersistencePromise.resolve(this.Ta.get(n)):this.ma.Ja(t,e)},t.prototype.e_=function(t,e){var n=this,r=this.Ta.get(t);assert(null!==r,"Tried to release nonexistent target: "+t);var i=e?"readwrite-idempotent":"readwrite-primary-idempotent";return this.persistence.runTransaction("Release target",i,(function(i){var s=n.la.Ao(t);return e?PersistencePromise.resolve():PersistencePromise.forEach(s,(function(t){return n.persistence.Pu.do(i,t)})).next((function(){n.persistence.Pu.removeTarget(i,r)}))})).then((function(){n.Ta=n.Ta.remove(t),n.da.delete(r.target)}))},t.prototype.n_=function(t,e){var n=this,r=__PRIVATE_SnapshotVersion.MIN,i=__PRIVATE_documentKeySet();return this.persistence.runTransaction("Execute query","readonly-idempotent",(function(s){return n.Ja(s,t.En()).next((function(t){if(t)return r=t.lastLimboFreeSnapshotVersion,n.ma.r_(s,t.targetId).next((function(t){i=t}))})).next((function(){return n.fa.ra(s,t,e?r:__PRIVATE_SnapshotVersion.MIN,e?i:__PRIVATE_documentKeySet())})).next((function(t){return{documents:t,i_:i}}))}))},t.prototype.s_=function(t){var e=this;return this.persistence.runTransaction("Remote document keys","readonly-idempotent",(function(n){return e.ma.r_(n,t)}))},t.prototype.o_=function(){return this.persistence.o_()},t.prototype.u_=function(t){this.Xu.ku(t)},t.prototype.a_=function(t){this.persistence.a_(t)},t.prototype.La=function(t,e,n){var r=this,i=e.batch,s=i.keys(),o=PersistencePromise.resolve();return s.forEach((function(r){o=o.next((function(){return n.Ko(t,r)})).next((function(t){var s=t,o=e._o.get(r);assert(null!==o,"ackVersions should contain every doc in the write."),(!s||s.version._(o)<0)&&((s=i.zt(r,s,e))?n.Uo(s,e.ao):assert(!t,"Mutation batch "+i+" applied to document "+t+" resulted in null"))}))})),o.next((function(){return r.Xu.Bu(t,i)}))},t.prototype.__=function(t){var e=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary-idempotent",(function(n){return t.c_(n,e.Ta)}))},t.prototype.h_=function(t){var e=this,n=this.Ta.get(t);return n?Promise.resolve(n.target):this.persistence.runTransaction("Get target data","readonly-idempotent",(function(n){return e.ma.Xr(n,t).next((function(t){return t?t.target:null}))}))},t.prototype.f_=function(){var t=this;return this.persistence.runTransaction("Get new document changes","readonly-idempotent",(function(e){return t.Ia.f_(e,t.Ea)})).then((function(e){var n=e.l_,r=e.readTime;return t.Ea=r,n}))},t.prototype.wa=function(){return tslib.__awaiter(this,void 0,void 0,(function(){var t,e=this;return tslib.__generator(this,(function(n){switch(n.label){case 0:return t=this,[4,this.persistence.runTransaction("Synchronize last document change read time","readonly-idempotent",(function(t){return e.Ia.T_(t)}))];case 1:return t.Ea=n.sent(),[2]}}))}))},t.$a=3e8,t}();function __PRIVATE_ignoreIfPrimaryLeaseLoss(t){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(e){if(t.code!==Code.FAILED_PRECONDITION||t.message!==__PRIVATE_PRIMARY_LEASE_LOST_ERROR_MSG)throw t;return debug(__PRIVATE_LOG_TAG$2,"Unexpectedly lost primary lease"),[2]}))}))}function __PRIVATE_bufferEntryComparator(t,e){var n=t[0],r=t[1],i=e[0],s=e[1],o=__PRIVATE_primitiveComparator(n,i);return 0===o?__PRIVATE_primitiveComparator(r,s):o}var __PRIVATE_RollingSequenceNumberBuffer=function(){function t(t){this.d_=t,this.buffer=new __PRIVATE_SortedSet(__PRIVATE_bufferEntryComparator),this.E_=0}return t.prototype.P_=function(){return++this.E_},t.prototype.A_=function(t){var e=[t,this.P_()];if(this.buffer.size<this.d_)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();__PRIVATE_bufferEntryComparator(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(t.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),t}(),__PRIVATE_GC_DID_NOT_RUN={R_:!1,I_:0,V_:0,m_:0},__PRIVATE_LruParams=function(){function t(t,e,n){this.v_=t,this.p_=e,this.b_=n}return t.g_=function(e){return new t(e,t.w_,t.y_)},t.S_=-1,t.D_=1048576,t.C_=41943040,t.w_=10,t.y_=1e3,t.O_=new t(t.C_,t.w_,t.y_),t.DISABLED=new t(t.S_,0,0),t}(),__PRIVATE_INITIAL_GC_DELAY_MS=6e4,__PRIVATE_REGULAR_GC_DELAY_MS=3e5,__PRIVATE_LruScheduler=function(){function t(t,e,n){this.F_=t,this.Cs=e,this.N_=n,this.M_=!1,this.L_=null}return t.prototype.start=function(){assert(null===this.L_,"Cannot start an already started LruScheduler"),this.F_.params.v_!==__PRIVATE_LruParams.S_&&this.G_()},t.prototype.stop=function(){this.L_&&(this.L_.cancel(),this.L_=null)},Object.defineProperty(t.prototype,"Pa",{get:function(){return null!==this.L_},enumerable:!0,configurable:!0}),t.prototype.G_=function(){var t=this;assert(null===this.L_,"Cannot schedule GC while a task is pending");var e=this.M_?__PRIVATE_REGULAR_GC_DELAY_MS:__PRIVATE_INITIAL_GC_DELAY_MS;debug("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.L_=this.Cs.Zs(__PRIVATE_TimerId.Ss,e,(function(){return t.L_=null,t.M_=!0,t.N_.__(t.F_).then((function(){return t.G_()})).catch(__PRIVATE_ignoreIfPrimaryLeaseLoss)}))},t}(),__PRIVATE_LruGarbageCollector=function(){function t(t,e){this.B_=t,this.params=e}return t.prototype.U_=function(t,e){return this.B_.k_(t).next((function(t){return Math.floor(e/100*t)}))},t.prototype.x_=function(t,e){var n=this;if(0===e)return PersistencePromise.resolve(__PRIVATE_ListenSequence.Vs);var r=new __PRIVATE_RollingSequenceNumberBuffer(e);return this.B_.kr(t,(function(t){return r.A_(t.sequenceNumber)})).next((function(){return n.B_.K_(t,(function(t){return r.A_(t)}))})).next((function(){return r.maxValue}))},t.prototype.q_=function(t,e,n){return this.B_.q_(t,e,n)},t.prototype.j_=function(t,e){return this.B_.j_(t,e)},t.prototype.c_=function(t,e){var n=this;return this.params.v_===__PRIVATE_LruParams.S_?(debug("LruGarbageCollector","Garbage collection skipped; disabled"),PersistencePromise.resolve(__PRIVATE_GC_DID_NOT_RUN)):this.Q_(t).next((function(r){return r<n.params.v_?(debug("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+n.params.v_),__PRIVATE_GC_DID_NOT_RUN):n.W_(t,e)}))},t.prototype.Q_=function(t){return this.B_.Q_(t)},t.prototype.W_=function(t,e){var n,r,i,s,o,u,a,_=this,c=Date.now();return this.U_(t,this.params.p_).next((function(e){return e>_.params.b_?(debug("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+_.params.b_+" from "+e),r=_.params.b_):r=e,s=Date.now(),_.x_(t,r)})).next((function(r){return n=r,o=Date.now(),_.q_(t,n,e)})).next((function(e){return i=e,u=Date.now(),_.j_(t,n)})).next((function(t){(a=Date.now(),__PRIVATE_getLogLevel()<=LogLevel.DEBUG)&&debug("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(s-c)+"ms\n\tDetermined least recently used "+r+" in "+(o-s)+"ms\n\tRemoved "+i+" targets in "+(u-o)+"ms\n\tRemoved "+t+" documents in "+(a-u)+"ms\nTotal Duration: "+(a-c)+"ms");return PersistencePromise.resolve({R_:!0,I_:r,V_:i,m_:t})}))},t}(),__PRIVATE_IndexedDbTargetCache=function(){function t(t,e){this.Pu=t,this.serializer=e,this.Y_=__PRIVATE_TargetIdGenerator.Yu()}return t.prototype.Za=function(t){var e=this;return this.H_(t).next((function(n){return n.highestTargetId=e.Y_.after(n.highestTargetId),e.z_(t,n).next((function(){return n.highestTargetId}))}))},t.prototype.Ba=function(t){return this.H_(t).next((function(t){return __PRIVATE_SnapshotVersion.j(new Timestamp(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))}))},t.prototype.X_=function(t){return __PRIVATE_getHighestListenSequenceNumber(t.Uu)},t.prototype.Wa=function(t,e,n){var r=this;return this.H_(t).next((function(i){return i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.Y()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),r.z_(t,i)}))},t.prototype.t_=function(t,e){var n=this;return this.J_(t,e).next((function(){return n.H_(t).next((function(r){return r.targetCount+=1,n.Z_(e,r),n.z_(t,r)}))}))},t.prototype.ja=function(t,e){return this.J_(t,e)},t.prototype.tc=function(t,e){var n=this;return this.ec(t,e.targetId).next((function(){return __PRIVATE_targetsStore(t).delete(e.targetId)})).next((function(){return n.H_(t)})).next((function(e){return assert(e.targetCount>0,"Removing from an empty target cache"),e.targetCount-=1,n.z_(t,e)}))},t.prototype.q_=function(t,e,n){var r=this,i=0,s=[];return __PRIVATE_targetsStore(t).Tu((function(o,u){var a=r.serializer.nc(u);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(i++,s.push(r.tc(t,a)))})).next((function(){return PersistencePromise.No(s)})).next((function(){return i}))},t.prototype.kr=function(t,e){var n=this;return __PRIVATE_targetsStore(t).Tu((function(t,r){var i=n.serializer.nc(r);e(i)}))},t.prototype.H_=function(t){return __PRIVATE_retrieveMetadata(t.Uu)},t.prototype.z_=function(t,e){return __PRIVATE_globalTargetStore(t).put(DbTargetGlobal.key,e)},t.prototype.J_=function(t,e){return __PRIVATE_targetsStore(t).put(this.serializer.rc(e))},t.prototype.Z_=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},t.prototype.ic=function(t){return this.H_(t).next((function(t){return t.targetCount}))},t.prototype.Ja=function(t,e){var n=this,r=e.canonicalId(),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),s=null;return __PRIVATE_targetsStore(t).Tu({range:i,index:DbTarget.queryTargetsIndexName},(function(t,r,i){var o=n.serializer.nc(r);e.isEqual(o.target)&&(s=o,i.done())})).next((function(){return s}))},t.prototype.xa=function(t,e,n){var r=this,i=[],s=__PRIVATE_documentTargetStore(t);return e.forEach((function(e){var o=encode(e.path);i.push(s.put(new DbTargetDocument(n,o))),i.push(r.Pu.lo(t,e))})),PersistencePromise.No(i)},t.prototype.ka=function(t,e,n){var r=this,i=__PRIVATE_documentTargetStore(t);return PersistencePromise.forEach(e,(function(e){var s=encode(e.path);return PersistencePromise.No([i.delete([n,s]),r.Pu.do(t,e)])}))},t.prototype.ec=function(t,e){var n=__PRIVATE_documentTargetStore(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},t.prototype.r_=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=__PRIVATE_documentTargetStore(t),i=__PRIVATE_documentKeySet();return r.Tu({range:n,lu:!0},(function(t,e,n){var r=decode(t[1]),s=new __PRIVATE_DocumentKey(r);i=i.add(s)})).next((function(){return i}))},t.prototype.Vo=function(t,e){var n=encode(e.path),r=IDBKeyRange.bound([n],[__PRIVATE_immediateSuccessor(n)],!1,!0),i=0;return __PRIVATE_documentTargetStore(t).Tu({index:DbTargetDocument.documentTargetsIndex,lu:!0,range:r},(function(t,e,n){var r=t[0];t[1];0!==r&&(i++,n.done())})).next((function(){return i>0}))},t.prototype.Xr=function(t,e){var n=this;return __PRIVATE_targetsStore(t).get(e).next((function(t){return t?n.serializer.nc(t):null}))},t}();function __PRIVATE_targetsStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbTarget.store)}function __PRIVATE_globalTargetStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbTargetGlobal.store)}function __PRIVATE_retrieveMetadata(t){return __PRIVATE_SimpleDb.eu(t,DbTargetGlobal.store).get(DbTargetGlobal.key).next((function(t){return assert(null!==t,"Missing metadata row."),t}))}function __PRIVATE_getHighestListenSequenceNumber(t){return __PRIVATE_retrieveMetadata(t).next((function(t){return t.highestListenSequenceNumber}))}function __PRIVATE_documentTargetStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbTargetDocument.store)}var __PRIVATE_IndexedDbRemoteDocumentCache=function(){function t(t,e){this.serializer=t,this.Eu=e}return t.prototype.Uo=function(t,e,n){return __PRIVATE_remoteDocumentsStore(t).put(__PRIVATE_dbKey(e),n)},t.prototype.xo=function(t,e){var n=__PRIVATE_remoteDocumentsStore(t),r=__PRIVATE_dbKey(e);return n.delete(r)},t.prototype.updateMetadata=function(t,e){var n=this;return this.getMetadata(t).next((function(r){return r.byteSize+=e,n.sc(t,r)}))},t.prototype.Ko=function(t,e){var n=this;return __PRIVATE_remoteDocumentsStore(t).get(__PRIVATE_dbKey(e)).next((function(t){return n.oc(t)}))},t.prototype.uc=function(t,e){var n=this;return __PRIVATE_remoteDocumentsStore(t).get(__PRIVATE_dbKey(e)).next((function(t){var e=n.oc(t);return e?{ac:e,size:__PRIVATE_dbDocumentSize(t)}:null}))},t.prototype.getEntries=function(t,e){var n=this,r=__PRIVATE_nullableMaybeDocumentMap();return this._c(t,e,(function(t,e){var i=n.oc(e);r=r.Pt(t,i)})).next((function(){return r}))},t.prototype.cc=function(t,e){var n=this,r=__PRIVATE_nullableMaybeDocumentMap(),i=new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H);return this._c(t,e,(function(t,e){var s=n.oc(e);s?(r=r.Pt(t,s),i=i.Pt(t,__PRIVATE_dbDocumentSize(e))):(r=r.Pt(t,null),i=i.Pt(t,0))})).next((function(){return{hc:r,fc:i}}))},t.prototype._c=function(t,e,n){if(e.tt())return PersistencePromise.resolve();var r=IDBKeyRange.bound(e.first().path.st(),e.last().path.st()),i=e.pt(),s=i.Dt();return __PRIVATE_remoteDocumentsStore(t).Tu({range:r},(function(t,e,r){for(var o=__PRIVATE_DocumentKey.dt(t);s&&__PRIVATE_DocumentKey.H(s,o)<0;)n(s,null),s=i.Dt();s&&s.isEqual(o)&&(n(s,e),s=i.Ct()?i.Dt():null),s?r.au(s.path.st()):r.done()})).next((function(){for(;s;)n(s,null),s=i.Ct()?i.Dt():null}))},t.prototype.ra=function(t,e,n){var r=this;assert(!e.bn(),"CollectionGroup queries should be handled in LocalDocumentsView");var i=__PRIVATE_documentMap(),s=e.path.length+1,o={};if(n.isEqual(__PRIVATE_SnapshotVersion.MIN)){var u=e.path.st();o.range=IDBKeyRange.lowerBound(u)}else{var a=e.path.st(),_=this.serializer.lc(n);o.range=IDBKeyRange.lowerBound([a,_],!0),o.index=DbRemoteDocument.collectionReadTimeIndex}return __PRIVATE_remoteDocumentsStore(t).Tu(o,(function(t,n,o){if(t.length===s){var u=r.serializer.Tc(n);e.path.rt(u.key.path)?u instanceof Document&&e.matches(u)&&(i=i.Pt(u.key,u)):o.done()}})).next((function(){return i}))},t.prototype.f_=function(t,e){var n=this,r=__PRIVATE_maybeDocumentMap(),i=this.serializer.lc(e),s=__PRIVATE_remoteDocumentsStore(t),o=IDBKeyRange.lowerBound(i,!0);return s.Tu({index:DbRemoteDocument.readTimeIndex,range:o},(function(t,e){var s=n.serializer.Tc(e);r=r.Pt(s.key,s),i=e.readTime})).next((function(){return{l_:r,readTime:n.serializer.dc(i)}}))},t.prototype.T_=function(t){var e=this,n=__PRIVATE_remoteDocumentsStore(t),r=__PRIVATE_SnapshotVersion.MIN;return n.Tu({index:DbRemoteDocument.readTimeIndex,reverse:!0},(function(t,n,i){n.readTime&&(r=e.serializer.dc(n.readTime)),i.done()})).next((function(){return r}))},t.prototype.Na=function(e){return new t.Ec(this,!!e&&e.Ma)},t.prototype.Pc=function(t){return this.getMetadata(t).next((function(t){return t.byteSize}))},t.prototype.getMetadata=function(t){return __PRIVATE_documentGlobalStore(t).get(DbRemoteDocumentGlobal.key).next((function(t){return assert(!!t,"Missing document cache metadata"),t}))},t.prototype.sc=function(t,e){return __PRIVATE_documentGlobalStore(t).put(DbRemoteDocumentGlobal.key,e)},t.prototype.oc=function(t){if(t){var e=this.serializer.Tc(t);return e instanceof __PRIVATE_NoDocument&&e.version.isEqual(__PRIVATE_SnapshotVersion.W())?null:e}return null},t.Ec=function(t){function e(e,n){var r=t.call(this)||this;return r.Ac=e,r.Ma=n,r.Rc=new __PRIVATE_ObjectMap((function(t){return t.toString()})),r}return tslib.__extends(e,t),e.prototype.Qo=function(t){var e=this,n=[],r=0,i=new __PRIVATE_SortedSet((function(t,e){return __PRIVATE_primitiveComparator(t.ot(),e.ot())}));return this.Lo.forEach((function(s,o){var u=e.Rc.get(s);if(assert(void 0!==u,"Cannot modify a document that wasn't read (for "+s+")"),o){assert(!e.readTime.isEqual(__PRIVATE_SnapshotVersion.MIN),"Cannot add a document with a read time of zero");var a=e.Ac.serializer.Ic(o,e.readTime);i=i.add(s.path.Z());var _=__PRIVATE_dbDocumentSize(a);r+=_-u,n.push(e.Ac.Uo(t,s,a))}else if(r-=u,e.Ma){var c=e.Ac.serializer.Ic(new __PRIVATE_NoDocument(s,__PRIVATE_SnapshotVersion.W()),e.readTime);n.push(e.Ac.Uo(t,s,c))}else n.push(e.Ac.xo(t,s))})),i.forEach((function(r){n.push(e.Ac.Eu.wu(t,r))})),n.push(this.Ac.updateMetadata(t,r)),PersistencePromise.No(n)},e.prototype.qo=function(t,e){var n=this;return this.Ac.uc(t,e).next((function(t){return null===t?(n.Rc.set(e,0),null):(n.Rc.set(e,t.size),t.ac)}))},e.prototype.jo=function(t,e){var n=this;return this.Ac.cc(t,e).next((function(t){var e=t.hc;return t.fc.forEach((function(t,e){n.Rc.set(t,e)})),e}))},e}(__PRIVATE_RemoteDocumentChangeBuffer),t}();function __PRIVATE_documentGlobalStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbRemoteDocumentGlobal.store)}function __PRIVATE_remoteDocumentsStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbRemoteDocument.store)}function __PRIVATE_dbKey(t){return t.path.st()}function __PRIVATE_dbDocumentSize(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw fail("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var __PRIVATE_MemoryIndexManager=function(){function t(){this.Vc=new __PRIVATE_MemoryCollectionParentIndex}return t.prototype.wu=function(t,e){return this.Vc.add(e),PersistencePromise.resolve()},t.prototype.ua=function(t,e){return PersistencePromise.resolve(this.Vc.getEntries(e))},t}(),__PRIVATE_MemoryCollectionParentIndex=function(){function t(){this.index={}}return t.prototype.add=function(t){assert(t.length%2==1,"Expected a collection path.");var e=t.nt(),n=t.Z(),r=this.index[e]||new __PRIVATE_SortedSet(ResourcePath.H),i=!r.has(n);return this.index[e]=r.add(n),i},t.prototype.has=function(t){var e=t.nt(),n=t.Z(),r=this.index[e];return r&&r.has(n)},t.prototype.getEntries=function(t){return(this.index[t]||new __PRIVATE_SortedSet(ResourcePath.H)).st()},t}(),SCHEMA_VERSION=9,SchemaConverter=function(){function t(t){this.serializer=t}return t.prototype.createOrUpgrade=function(t,e,n,r){var i=this;assert(n<r&&n>=0&&r<=SCHEMA_VERSION,"Unexpected schema upgrade from v"+n+" to v{toVersion}.");var s=new __PRIVATE_SimpleDbTransaction(e);n<1&&r>=1&&(__PRIVATE_createPrimaryClientStore(t),__PRIVATE_createMutationQueue(t),__PRIVATE_createQueryCache(t),__PRIVATE_createRemoteDocumentCache(t));var o=PersistencePromise.resolve();return n<3&&r>=3&&(0!==n&&(__PRIVATE_dropQueryCache(t),__PRIVATE_createQueryCache(t)),o=o.next((function(){return __PRIVATE_writeEmptyTargetGlobalEntry(s)}))),n<4&&r>=4&&(0!==n&&(o=o.next((function(){return __PRIVATE_upgradeMutationBatchSchemaAndMigrateData(t,s)}))),o=o.next((function(){__PRIVATE_createClientMetadataStore(t)}))),n<5&&r>=5&&(o=o.next((function(){return i.removeAcknowledgedMutations(s)}))),n<6&&r>=6&&(o=o.next((function(){return __PRIVATE_createDocumentGlobalStore(t),i.addDocumentGlobal(s)}))),n<7&&r>=7&&(o=o.next((function(){return i.ensureSequenceNumbers(s)}))),n<8&&r>=8&&(o=o.next((function(){return i.createCollectionParentIndex(t,s)}))),n<9&&r>=9&&(o=o.next((function(){__PRIVATE_dropRemoteDocumentChangesStore(t),__PRIVATE_createRemoteDocumentReadTimeIndex(e)}))),o},t.prototype.addDocumentGlobal=function(t){var e=0;return t.store(DbRemoteDocument.store).Tu((function(t,n){e+=__PRIVATE_dbDocumentSize(n)})).next((function(){var n=new DbRemoteDocumentGlobal(e);return t.store(DbRemoteDocumentGlobal.store).put(DbRemoteDocumentGlobal.key,n)}))},t.prototype.removeAcknowledgedMutations=function(t){var e=this,n=t.store(DbMutationQueue.store),r=t.store(DbMutationBatch.store);return n.cu().next((function(n){return PersistencePromise.forEach(n,(function(n){var i=IDBKeyRange.bound([n.userId,__PRIVATE_BATCHID_UNKNOWN],[n.userId,n.lastAcknowledgedBatchId]);return r.cu(DbMutationBatch.userMutationsIndex,i).next((function(r){return PersistencePromise.forEach(r,(function(r){assert(r.userId===n.userId,"Cannot process batch "+r.batchId+" from unexpected user");var i=e.serializer.Su(r);return __PRIVATE_removeMutationBatch(t,n.userId,i).next((function(){}))}))}))}))}))},t.prototype.ensureSequenceNumbers=function(t){var e=t.store(DbTargetDocument.store),n=t.store(DbRemoteDocument.store);return __PRIVATE_getHighestListenSequenceNumber(t).next((function(t){var r=[];return n.Tu((function(n,i){var s=new ResourcePath(n),o=__PRIVATE_sentinelKey(s);r.push(e.get(o).next((function(n){return n?PersistencePromise.resolve():function(n){return e.put(new DbTargetDocument(0,encode(n),t))}(s)})))})).next((function(){return PersistencePromise.No(r)}))}))},t.prototype.createCollectionParentIndex=function(t,e){t.createObjectStore(DbCollectionParent.store,{keyPath:DbCollectionParent.keyPath});var n=e.store(DbCollectionParent.store),r=new __PRIVATE_MemoryCollectionParentIndex,i=function(t){if(r.add(t)){var e=t.nt(),i=t.Z();return n.put({collectionId:e,parent:encode(i)})}};return e.store(DbRemoteDocument.store).Tu({lu:!0},(function(t,e){var n=new ResourcePath(t);return i(n.Z())})).next((function(){return e.store(DbDocumentMutation.store).Tu({lu:!0},(function(t,e){t[0];var n=t[1],r=(t[2],decode(n));return i(r.Z())}))}))},t}();function __PRIVATE_sentinelKey(t){return[0,encode(t)]}var DbTimestamp=function(t,e){this.seconds=t,this.nanoseconds=e},DbPrimaryClient=function(){function t(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}return t.store="owner",t.key="owner",t}();function __PRIVATE_createPrimaryClientStore(t){t.createObjectStore(DbPrimaryClient.store)}var DbMutationQueue=function(){function t(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}return t.store="mutationQueues",t.keyPath="userId",t}(),DbMutationBatch=function(){function t(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}return t.store="mutations",t.keyPath="batchId",t.userMutationsIndex="userMutationsIndex",t.userMutationsKeyPath=["userId","batchId"],t}();function __PRIVATE_createMutationQueue(t){t.createObjectStore(DbMutationQueue.store,{keyPath:DbMutationQueue.keyPath}),t.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath,autoIncrement:!0}).createIndex(DbMutationBatch.userMutationsIndex,DbMutationBatch.userMutationsKeyPath,{unique:!0}),t.createObjectStore(DbDocumentMutation.store)}function __PRIVATE_upgradeMutationBatchSchemaAndMigrateData(t,e){return e.store(DbMutationBatch.store).cu().next((function(n){t.deleteObjectStore(DbMutationBatch.store),t.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath,autoIncrement:!0}).createIndex(DbMutationBatch.userMutationsIndex,DbMutationBatch.userMutationsKeyPath,{unique:!0});var r=e.store(DbMutationBatch.store),i=n.map((function(t){return r.put(t)}));return PersistencePromise.No(i)}))}var DbDocumentMutation=function(){function t(){}return t.prefixForUser=function(t){return[t]},t.prefixForPath=function(t,e){return[t,encode(e)]},t.key=function(t,e,n){return[t,encode(e),n]},t.store="documentMutations",t.PLACEHOLDER=new t,t}();function __PRIVATE_createRemoteDocumentCache(t){t.createObjectStore(DbRemoteDocument.store)}var DbNoDocument=function(t,e){this.path=t,this.readTime=e},DbUnknownDocument=function(t,e){this.path=t,this.version=e},DbRemoteDocument=function(){function t(t,e,n,r,i,s){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=i,this.parentPath=s}return t.store="remoteDocuments",t.readTimeIndex="readTimeIndex",t.readTimeIndexPath="readTime",t.collectionReadTimeIndex="collectionReadTimeIndex",t.collectionReadTimeIndexPath=["parentPath","readTime"],t}(),DbRemoteDocumentGlobal=function(){function t(t){this.byteSize=t}return t.store="remoteDocumentGlobal",t.key="remoteDocumentGlobalKey",t}();function __PRIVATE_createDocumentGlobalStore(t){t.createObjectStore(DbRemoteDocumentGlobal.store)}var DbTarget=function(){function t(t,e,n,r,i,s,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.lastLimboFreeSnapshotVersion=s,this.query=o}return t.store="targets",t.keyPath="targetId",t.queryTargetsIndexName="queryTargetsIndex",t.queryTargetsKeyPath=["canonicalId","targetId"],t}(),DbTargetDocument=function(){function t(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n,assert(0===t==(void 0!==n),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return t.store="targetDocuments",t.keyPath=["targetId","path"],t.documentTargetsIndex="documentTargetsIndex",t.documentTargetsKeyPath=["path","targetId"],t}(),DbTargetGlobal=function(){function t(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}return t.key="targetGlobalKey",t.store="targetGlobal",t}(),DbCollectionParent=function(){function t(t,e){this.collectionId=t,this.parent=e}return t.store="collectionParents",t.keyPath=["collectionId","parent"],t}();function __PRIVATE_createQueryCache(t){t.createObjectStore(DbTargetDocument.store,{keyPath:DbTargetDocument.keyPath}).createIndex(DbTargetDocument.documentTargetsIndex,DbTargetDocument.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(DbTarget.store,{keyPath:DbTarget.keyPath}).createIndex(DbTarget.queryTargetsIndexName,DbTarget.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(DbTargetGlobal.store)}function __PRIVATE_dropQueryCache(t){t.deleteObjectStore(DbTargetDocument.store),t.deleteObjectStore(DbTarget.store),t.deleteObjectStore(DbTargetGlobal.store)}function __PRIVATE_dropRemoteDocumentChangesStore(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}function __PRIVATE_writeEmptyTargetGlobalEntry(t){var e=t.store(DbTargetGlobal.store),n=new DbTargetGlobal(0,0,__PRIVATE_SnapshotVersion.MIN.Y(),0);return e.put(DbTargetGlobal.key,n)}function __PRIVATE_createRemoteDocumentReadTimeIndex(t){var e=t.objectStore(DbRemoteDocument.store);e.createIndex(DbRemoteDocument.readTimeIndex,DbRemoteDocument.readTimeIndexPath,{unique:!1}),e.createIndex(DbRemoteDocument.collectionReadTimeIndex,DbRemoteDocument.collectionReadTimeIndexPath,{unique:!1})}var DbClientMetadata=function(){function t(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}return t.store="clientMetadata",t.keyPath="clientId",t}();function __PRIVATE_createClientMetadataStore(t){t.createObjectStore(DbClientMetadata.store,{keyPath:DbClientMetadata.keyPath})}var V1_STORES=[DbMutationQueue.store,DbMutationBatch.store,DbDocumentMutation.store,DbRemoteDocument.store,DbTarget.store,DbPrimaryClient.store,DbTargetGlobal.store,DbTargetDocument.store],V3_STORES=V1_STORES,V4_STORES=tslib.__spreadArrays(V3_STORES,[DbClientMetadata.store]),V6_STORES=tslib.__spreadArrays(V4_STORES,[DbRemoteDocumentGlobal.store]),V8_STORES=tslib.__spreadArrays(V6_STORES,[DbCollectionParent.store]),ALL_STORES=V8_STORES,__PRIVATE_IndexedDbIndexManager=function(){function t(){this.mc=new __PRIVATE_MemoryCollectionParentIndex}return t.prototype.wu=function(t,e){var n=this;if(assert(e.length%2==1,"Expected a collection path."),!this.mc.has(e)){var r=e.nt(),i=e.Z();t.$o((function(){n.mc.add(e)}));var s={collectionId:r,parent:encode(i)};return __PRIVATE_collectionParentsStore(t).put(s)}return PersistencePromise.resolve()},t.prototype.ua=function(t,e){var n=[],r=IDBKeyRange.bound([e,""],[__PRIVATE_immediateSuccessor(e),""],!1,!0);return __PRIVATE_collectionParentsStore(t).cu(r).next((function(t){for(var r=0,i=t;r<i.length;r++){var s=i[r];if(s.collectionId!==e)break;n.push(decode(s.parent))}return n}))},t}();function __PRIVATE_collectionParentsStore(t){return __PRIVATE_IndexedDbPersistence.eu(t,DbCollectionParent.store)}var LocalSerializer=function(){function t(t){this.vc=t}return t.prototype.Tc=function(t){if(t.document)return this.vc.bi(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=__PRIVATE_DocumentKey.dt(t.noDocument.path),n=this.pc(t.noDocument.readTime);return new __PRIVATE_NoDocument(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}if(t.unknownDocument){e=__PRIVATE_DocumentKey.dt(t.unknownDocument.path),n=this.pc(t.unknownDocument.version);return new __PRIVATE_UnknownDocument(e,n)}return fail("Unexpected DbRemoteDocument")},t.prototype.Ic=function(t,e){var n=this.lc(e),r=t.key.path.Z().st();if(t instanceof Document){var i=t.proto?t.proto:this.vc.pi(t),s=t.hasCommittedMutations;return new DbRemoteDocument(null,null,i,s,n,r)}if(t instanceof __PRIVATE_NoDocument){var o=t.key.path.st(),u=this.bc(t.version);s=t.hasCommittedMutations;return new DbRemoteDocument(null,new DbNoDocument(o,u),null,s,n,r)}if(t instanceof __PRIVATE_UnknownDocument){o=t.key.path.st();var a=this.bc(t.version);return new DbRemoteDocument(new DbUnknownDocument(o,a),null,null,!0,n,r)}return fail("Unexpected MaybeDocument")},t.prototype.lc=function(t){var e=t.Y();return[e.seconds,e.nanoseconds]},t.prototype.dc=function(t){var e=new Timestamp(t[0],t[1]);return __PRIVATE_SnapshotVersion.j(e)},t.prototype.bc=function(t){var e=t.Y();return new DbTimestamp(e.seconds,e.nanoseconds)},t.prototype.pc=function(t){var e=new Timestamp(t.seconds,t.nanoseconds);return __PRIVATE_SnapshotVersion.j(e)},t.prototype.gu=function(t,e){var n=this,r=e.baseMutations.map((function(t){return n.vc.Ni(t)})),i=e.mutations.map((function(t){return n.vc.Ni(t)}));return new DbMutationBatch(t,e.batchId,e.ke.toMillis(),r,i)},t.prototype.Su=function(t){var e=this,n=(t.baseMutations||[]).map((function(t){return e.vc.Bi(t)})),r=t.mutations.map((function(t){return e.vc.Bi(t)})),i=Timestamp.fromMillis(t.localWriteTimeMs);return new __PRIVATE_MutationBatch(t.batchId,i,n,r)},t.prototype.gc=function(t){var e=[];return t.forEach((function(t){e.push(encode(t.path))})),e},t.prototype.wc=function(t){for(var e=__PRIVATE_documentKeySet(),n=0,r=t;n<r.length;n++){var i=r[n];e=e.add(new __PRIVATE_DocumentKey(decode(i)))}return e},t.prototype.nc=function(t){var e,n=this.pc(t.readTime),r=void 0!==t.lastLimboFreeSnapshotVersion?this.pc(t.lastLimboFreeSnapshotVersion):__PRIVATE_SnapshotVersion.MIN,i=t.resumeToken;return e=__PRIVATE_isDocumentQuery(t.query)?this.vc.Qi(t.query):this.vc.zi(t.query),new __PRIVATE_TargetData(e,t.targetId,__PRIVATE_TargetPurpose.Sn,t.lastListenSequenceNumber,n,r,i)},t.prototype.rc=function(t){assert(__PRIVATE_TargetPurpose.Sn===t.On,"Only queries with purpose "+__PRIVATE_TargetPurpose.Sn+" may be stored, got "+t.On);var e,n,r=this.bc(t.Fn),i=this.bc(t.lastLimboFreeSnapshotVersion);return e=t.target.He()?this.vc.ji(t.target):this.vc.Wi(t.target),t.resumeToken instanceof Uint8Array?(assert(__PRIVATE_SimpleDb.Jo(),"Persisting non-string stream tokens is only supported with mock persistence ."),n=t.resumeToken.toString()):n=t.resumeToken,new DbTarget(t.targetId,t.target.canonicalId(),r,n,t.sequenceNumber,i,e)},t}();function __PRIVATE_isDocumentQuery(t){return void 0!==t.documents}var __PRIVATE_LOG_TAG$3="IndexedDbPersistence",__PRIVATE_MAX_CLIENT_AGE_MS=18e5,__PRIVATE_MAX_PRIMARY_ELIGIBLE_AGE_MS=5e3,__PRIVATE_CLIENT_METADATA_REFRESH_INTERVAL_MS=4e3,__PRIVATE_PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",__PRIVATE_UNSUPPORTED_PLATFORM_ERROR_MSG="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",__PRIVATE_ZOMBIED_CLIENTS_KEY_PREFIX="firestore_zombie",__PRIVATE_IndexedDbTransaction=function(t){function e(e,n){var r=t.call(this)||this;return r.Uu=e,r.Ka=n,r}return tslib.__extends(e,t),e}(__PRIVATE_PersistenceTransaction),__PRIVATE_IndexedDbPersistence=function(){function t(e,n,r,i,s,o,u,a){if(this.allowTabSynchronization=e,this.persistenceKey=n,this.clientId=r,this.yc=o,this.Sc=a,this.Dc=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Cc=null,this.inForeground=!1,this.Oc=null,this.Fc=null,this.Nc=Number.NEGATIVE_INFINITY,this.Mc=function(t){return Promise.resolve()},this.Pu=new __PRIVATE_IndexedDbLruDelegate(this,s),this.Lc=n+t.Gc,this.serializer=new LocalSerializer(u),this.document=i.document,this.ma=new __PRIVATE_IndexedDbTargetCache(this.Pu,this.serializer),this.Eu=new __PRIVATE_IndexedDbIndexManager,this.zu=new __PRIVATE_IndexedDbRemoteDocumentCache(this.serializer,this.Eu),!i.window||!i.window.localStorage)throw new FirestoreError(Code.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=i.window,this.Bc=this.window.localStorage}return t.eu=function(t,e){if(t instanceof __PRIVATE_IndexedDbTransaction)return __PRIVATE_SimpleDb.eu(t.Uu,e);throw fail("IndexedDbPersistence must use instances of IndexedDbTransaction")},t.Uc=function(e){return tslib.__awaiter(this,void 0,void 0,(function(){var n;return tslib.__generator(this,(function(r){switch(r.label){case 0:if(!t.Xo())throw new FirestoreError(Code.UNIMPLEMENTED,__PRIVATE_UNSUPPORTED_PLATFORM_ERROR_MSG);return[4,(n=new t(e.allowTabSynchronization,e.persistenceKey,e.clientId,e.platform,e.kc,e.yc,e.serializer,e.Sc)).start()];case 1:return r.sent(),[2,n]}}))}))},t.prototype.start=function(){var t=this;return assert(!this.Pa,"IndexedDbPersistence double-started!"),assert(null!==this.window,"Expected 'window' to be defined"),__PRIVATE_SimpleDb.zo(this.Lc,SCHEMA_VERSION,new SchemaConverter(this.serializer)).then((function(e){return t.xc=e,t.Kc()})).then((function(){return t.qc(),t.jc(),t.Qc(),t.xc.runTransaction("readonly-idempotent",[DbTargetGlobal.store],(function(t){return __PRIVATE_getHighestListenSequenceNumber(t)}))})).then((function(e){t.Wc=new __PRIVATE_ListenSequence(e,t.Sc)})).then((function(){t.Dc=!0})).catch((function(e){return t.xc&&t.xc.close(),Promise.reject(e)}))},t.prototype.$c=function(t){var e=this;return this.Mc=function(n){return tslib.__awaiter(e,void 0,void 0,(function(){return tslib.__generator(this,(function(e){return this.Pa?[2,t(n)]:[2]}))}))},t(this.isPrimary)},t.prototype.Yc=function(t){var e=this;this.xc.nu((function(n){return tslib.__awaiter(e,void 0,void 0,(function(){return tslib.__generator(this,(function(e){switch(e.label){case 0:return null!==n.newVersion?[3,2]:[4,t()];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}))},t.prototype.a_=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.yc.ks((function(){return tslib.__awaiter(e,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return this.Pa?[4,this.Kc()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))})))},t.prototype.Kc=function(){var t=this;return this.xc.runTransaction("readwrite-idempotent",ALL_STORES,(function(e){return __PRIVATE_clientMetadataStore(e).put(new DbClientMetadata(t.clientId,Date.now(),t.networkEnabled,t.inForeground)).next((function(){if(t.isPrimary)return t.Hc(e).next((function(e){e||(t.isPrimary=!1,t.yc.ks((function(){return t.Mc(!1)})))}))})).next((function(){return t.zc(e)})).next((function(n){return t.isPrimary&&!n?t.Xc(e).next((function(){return!1})):!!n&&t.Jc(e).next((function(){return!0}))}))})).catch((function(e){if(!t.allowTabSynchronization)throw e;return debug(__PRIVATE_LOG_TAG$3,"Releasing owner lease after error during lease refresh",e),!1})).then((function(e){t.isPrimary!==e&&t.yc.ks((function(){return t.Mc(e)})),t.isPrimary=e}))},t.prototype.Hc=function(t){var e=this;return __PRIVATE_primaryClientStore(t).get(DbPrimaryClient.key).next((function(t){return PersistencePromise.resolve(e.Zc(t))}))},t.prototype.th=function(t){return __PRIVATE_clientMetadataStore(t).delete(this.clientId)},t.prototype.eh=function(){return tslib.__awaiter(this,void 0,void 0,(function(){var e=this;return tslib.__generator(this,(function(n){switch(n.label){case 0:return!this.isPrimary||this.nh(this.Nc,__PRIVATE_MAX_CLIENT_AGE_MS)?[3,2]:(this.Nc=Date.now(),[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary-idempotent",(function(n){var r=t.eu(n,DbClientMetadata.store);return r.cu().next((function(t){var n=e.rh(t,__PRIVATE_MAX_CLIENT_AGE_MS),i=t.filter((function(t){return-1===n.indexOf(t)}));return PersistencePromise.forEach(i,(function(t){return r.delete(t.clientId)})).next((function(){return i}))}))})).catch((function(){return[]}))]);case 1:n.sent().forEach((function(t){e.window.localStorage.removeItem(e.ih(t.clientId))})),n.label=2;case 2:return[2]}}))}))},t.prototype.Qc=function(){var t=this;this.Fc=this.yc.Zs(__PRIVATE_TimerId.ys,__PRIVATE_CLIENT_METADATA_REFRESH_INTERVAL_MS,(function(){return t.Kc().then((function(){return t.eh()})).then((function(){return t.Qc()}))}))},t.prototype.Zc=function(t){return!!t&&t.ownerId===this.clientId},t.prototype.zc=function(t){var e=this;return __PRIVATE_primaryClientStore(t).get(DbPrimaryClient.key).next((function(n){if(null!==n&&e.nh(n.leaseTimestampMs,__PRIVATE_MAX_PRIMARY_ELIGIBLE_AGE_MS)&&!e.sh(n.ownerId)){if(e.Zc(n)&&e.networkEnabled)return!0;if(!e.Zc(n)){if(!n.allowTabSynchronization)throw new FirestoreError(Code.FAILED_PRECONDITION,__PRIVATE_PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG);return!1}}return!(!e.networkEnabled||!e.inForeground)||__PRIVATE_clientMetadataStore(t).cu().next((function(t){return void 0===e.rh(t,__PRIVATE_MAX_PRIMARY_ELIGIBLE_AGE_MS).find((function(t){if(e.clientId!==t.clientId){var n=!e.networkEnabled&&t.networkEnabled,r=!e.inForeground&&t.inForeground,i=e.networkEnabled===t.networkEnabled;if(n||r&&i)return!0}return!1}))}))})).next((function(t){return e.isPrimary!==t&&debug(__PRIVATE_LOG_TAG$3,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t}))},t.prototype.shutdown=function(){return tslib.__awaiter(this,void 0,void 0,(function(){var t=this;return tslib.__generator(this,(function(e){switch(e.label){case 0:return this.Dc=!1,this.oh(),this.Fc&&(this.Fc.cancel(),this.Fc=null),this.uh(),this.ah(),[4,this.xc.runTransaction("readwrite-idempotent",[DbPrimaryClient.store,DbClientMetadata.store],(function(e){return t.Xc(e).next((function(){return t.th(e)}))}))];case 1:return e.sent(),this.xc.close(),this._h(),[2]}}))}))},t.prototype.rh=function(t,e){var n=this;return t.filter((function(t){return n.nh(t.updateTimeMs,e)&&!n.sh(t.clientId)}))},t.prototype.o_=function(){var t=this;return this.xc.runTransaction("readonly-idempotent",[DbClientMetadata.store],(function(e){return __PRIVATE_clientMetadataStore(e).cu().next((function(e){return t.rh(e,__PRIVATE_MAX_CLIENT_AGE_MS).map((function(t){return t.clientId}))}))}))},t.clearPersistence=function(e){return tslib.__awaiter(this,void 0,void 0,(function(){var n;return tslib.__generator(this,(function(r){switch(r.label){case 0:return t.Xo()?(n=e+t.Gc,[4,__PRIVATE_SimpleDb.delete(n)]):[2,Promise.resolve()];case 1:return r.sent(),[2]}}))}))},Object.defineProperty(t.prototype,"Pa",{get:function(){return this.Dc},enumerable:!0,configurable:!0}),t.prototype.Ra=function(t){return assert(this.Pa,"Cannot initialize MutationQueue before persistence is started."),__PRIVATE_IndexedDbMutationQueue.Ru(t,this.serializer,this.Eu,this.Pu)},t.prototype.va=function(){return assert(this.Pa,"Cannot initialize TargetCache before persistence is started."),this.ma},t.prototype.Va=function(){return assert(this.Pa,"Cannot initialize RemoteDocumentCache before persistence is started."),this.zu},t.prototype.ba=function(){return assert(this.Pa,"Cannot initialize IndexManager before persistence is started."),this.Eu},t.prototype.runTransaction=function(t,e,n){var r=this;debug(__PRIVATE_LOG_TAG$3,"Starting transaction:",t);var i,s=e.endsWith("idempotent"),o=e.startsWith("readonly")?s?"readonly-idempotent":"readonly":s?"readwrite-idempotent":"readwrite";return this.xc.runTransaction(o,ALL_STORES,(function(s){return i=new __PRIVATE_IndexedDbTransaction(s,r.Wc.next()),"readwrite-primary"===e||"readwrite-primary-idempotent"===e?r.Hc(s).next((function(t){return!!t||r.zc(s)})).next((function(e){if(!e)throw error("Failed to obtain primary lease for action '"+t+"'."),r.isPrimary=!1,r.yc.ks((function(){return r.Mc(!1)})),new FirestoreError(Code.FAILED_PRECONDITION,__PRIVATE_PRIMARY_LEASE_LOST_ERROR_MSG);return n(i)})).next((function(t){return r.Jc(s).next((function(){return t}))})):r.hh(s).next((function(){return n(i)}))})).then((function(t){return i.Yo(),t}))},t.prototype.hh=function(t){var e=this;return __PRIVATE_primaryClientStore(t).get(DbPrimaryClient.key).next((function(t){if(null!==t&&e.nh(t.leaseTimestampMs,__PRIVATE_MAX_PRIMARY_ELIGIBLE_AGE_MS)&&!e.sh(t.ownerId)&&!e.Zc(t)&&!t.allowTabSynchronization)throw new FirestoreError(Code.FAILED_PRECONDITION,__PRIVATE_PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG)}))},t.prototype.Jc=function(t){var e=new DbPrimaryClient(this.clientId,this.allowTabSynchronization,Date.now());return __PRIVATE_primaryClientStore(t).put(DbPrimaryClient.key,e)},t.Xo=function(){return __PRIVATE_SimpleDb.Xo()},t.fh=function(t){var e=t.o.projectId;return t.o.u||(e+="."+t.o.database),"firestore/"+t.persistenceKey+"/"+e+"/"},t.prototype.Xc=function(t){var e=this,n=__PRIVATE_primaryClientStore(t);return n.get(DbPrimaryClient.key).next((function(t){return e.Zc(t)?(debug(__PRIVATE_LOG_TAG$3,"Releasing primary lease."),n.delete(DbPrimaryClient.key)):PersistencePromise.resolve()}))},t.prototype.nh=function(t,e){var n=Date.now();return!(t<n-e)&&(!(t>n)||(error("Detected an update time that is in the future: "+t+" > "+n),!1))},t.prototype.qc=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Oc=function(){t.yc.ks((function(){return t.inForeground="visible"===t.document.visibilityState,t.Kc()}))},this.document.addEventListener("visibilitychange",this.Oc),this.inForeground="visible"===this.document.visibilityState)},t.prototype.uh=function(){this.Oc&&(assert(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.Oc),this.Oc=null)},t.prototype.jc=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.Cc=function(){t.oh(),t.yc.ks((function(){return t.shutdown()}))},this.window.addEventListener("unload",this.Cc))},t.prototype.ah=function(){this.Cc&&(assert("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.Cc),this.Cc=null)},t.prototype.sh=function(t){try{var e=null!==this.Bc.getItem(this.ih(t));return debug(__PRIVATE_LOG_TAG$3,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return error(__PRIVATE_LOG_TAG$3,"Failed to get zombied client id.",t),!1}},t.prototype.oh=function(){try{this.Bc.setItem(this.ih(this.clientId),String(Date.now()))}catch(t){error("Failed to set zombie client id.",t)}},t.prototype._h=function(){try{this.Bc.removeItem(this.ih(this.clientId))}catch(t){}},t.prototype.ih=function(t){return __PRIVATE_ZOMBIED_CLIENTS_KEY_PREFIX+"_"+this.persistenceKey+"_"+t},t.Gc="main",t}();function __PRIVATE_primaryClientStore(t){return t.store(DbPrimaryClient.store)}function __PRIVATE_clientMetadataStore(t){return t.store(DbClientMetadata.store)}var __PRIVATE_IndexedDbLruDelegate=function(){function t(t,e){this.db=t,this.lh=null,this.F_=new __PRIVATE_LruGarbageCollector(this,e)}return t.prototype.k_=function(t){var e=this.Th(t);return this.db.va().ic(t).next((function(t){return e.next((function(e){return t+e}))}))},t.prototype.Th=function(t){var e=0;return this.K_(t,(function(t){e++})).next((function(){return e}))},t.prototype.kr=function(t,e){return this.db.va().kr(t,e)},t.prototype.K_=function(t,e){return this.dh(t,(function(t,n){return e(n)}))},t.prototype.Aa=function(t){this.lh=t},t.prototype.lo=function(t,e){return __PRIVATE_writeSentinelKey(t,e)},t.prototype.do=function(t,e){return __PRIVATE_writeSentinelKey(t,e)},t.prototype.q_=function(t,e,n){return this.db.va().q_(t,e,n)},t.prototype.xu=function(t,e){return __PRIVATE_writeSentinelKey(t,e)},t.prototype.Eh=function(t,e){return this.lh.Vo(e)?PersistencePromise.resolve(!0):__PRIVATE_mutationQueuesContainKey(t,e)},t.prototype.j_=function(t,e){var n=this,r=this.db.Va().Na(),i=[],s=0;return this.dh(t,(function(o,u){if(u<=e){var a=n.Eh(t,o).next((function(e){if(!e)return s++,r.Ko(t,o).next((function(){return r.xo(o),__PRIVATE_documentTargetStore(t).delete(__PRIVATE_sentinelKey$1(o))}))}));i.push(a)}})).next((function(){return PersistencePromise.No(i)})).next((function(){return r.apply(t)})).next((function(){return s}))},t.prototype.removeTarget=function(t,e){var n=e.Nn(t.Ka);return this.db.va().ja(t,n)},t.prototype.Qa=function(t,e){return __PRIVATE_writeSentinelKey(t,e)},t.prototype.dh=function(t,e){var n,r=__PRIVATE_documentTargetStore(t),i=__PRIVATE_ListenSequence.Vs;return r.Tu({index:DbTargetDocument.documentTargetsIndex},(function(t,r){var s=t[0],o=(t[1],r.path),u=r.sequenceNumber;0===s?(i!==__PRIVATE_ListenSequence.Vs&&e(new __PRIVATE_DocumentKey(decode(n)),i),i=u,n=o):i=__PRIVATE_ListenSequence.Vs})).next((function(){i!==__PRIVATE_ListenSequence.Vs&&e(new __PRIVATE_DocumentKey(decode(n)),i)}))},t.prototype.Q_=function(t){return this.db.Va().Pc(t)},t}();function __PRIVATE_sentinelKey$1(t){return[0,encode(t.path)]}function __PRIVATE_sentinelRow(t,e){return new DbTargetDocument(0,encode(t.path),e)}function __PRIVATE_writeSentinelKey(t,e){return __PRIVATE_documentTargetStore(t).put(__PRIVATE_sentinelRow(e,t.Ka))}var __PRIVATE_IndexFreeQueryEngine=function(){function t(){}return t.prototype.ga=function(t){this.Ph=t},t.prototype.ra=function(t,e,n,r){var i=this;return assert(void 0!==this.Ph,"setLocalDocumentsView() not called"),e.dn()?this.Ah(t,e):n.isEqual(__PRIVATE_SnapshotVersion.MIN)?this.Ah(t,e):this.Ph.ea(t,r).next((function(s){var o=i.Rh(e,s);return(e.mn()||e.vn())&&i.Ih(e.Ze,o,r,n)?i.Ah(t,e):(__PRIVATE_getLogLevel()<=LogLevel.DEBUG&&debug("IndexFreeQueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),e.toString()),i.Ph.ra(t,e,n).next((function(t){return o.forEach((function(e){t=t.Pt(e.key,e)})),t})))}))},t.prototype.Rh=function(t,e){var n=new __PRIVATE_SortedSet((function(e,n){return t.Pn(e,n)}));return e.forEach((function(e,r){r instanceof Document&&t.matches(r)&&(n=n.add(r))})),n},t.prototype.Ih=function(t,e,n,r){if(n.size!==e.size)return!0;var i=t===__PRIVATE_LimitType.ze?e.last():e.first();return!!i&&(i.hasPendingWrites||i.version._(r)>0)},t.prototype.Ah=function(t,e){return __PRIVATE_getLogLevel()<=LogLevel.DEBUG&&debug("IndexFreeQueryEngine","Using full collection scan to execute query: %s",e.toString()),this.Ph.ra(t,e,__PRIVATE_SnapshotVersion.MIN)},t}(),__PRIVATE_MemoryMutationQueue=function(){function t(t,e){this.Eu=t,this.Pu=e,this.Xu=[],this.Vh=1,this.lastStreamToken=__PRIVATE_emptyByteString(),this.mh=new __PRIVATE_SortedSet(__PRIVATE_DocReference.qe)}return t.prototype.Iu=function(t){return PersistencePromise.resolve(0===this.Xu.length)},t.prototype.Vu=function(t,e,n){var r=e.batchId,i=this.vh(r,"acknowledged");assert(0===i,"Can only acknowledge the first batch in the mutation queue");var s=this.Xu[i];return assert(r===s.batchId,"Queue ordering failure: expected batch "+r+", got batch "+s.batchId),this.lastStreamToken=n,PersistencePromise.resolve()},t.prototype.vu=function(t){return PersistencePromise.resolve(this.lastStreamToken)},t.prototype.pu=function(t,e){return this.lastStreamToken=e,PersistencePromise.resolve()},t.prototype.bu=function(t,e,n,r){assert(0!==r.length,"Mutation batches should not be empty");var i=this.Vh;(this.Vh++,this.Xu.length>0)&&assert(this.Xu[this.Xu.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");var s=new __PRIVATE_MutationBatch(i,e,n,r);this.Xu.push(s);for(var o=0,u=r;o<u.length;o++){var a=u[o];this.mh=this.mh.add(new __PRIVATE_DocReference(a.key,i)),this.Eu.wu(t,a.key.path.Z())}return PersistencePromise.resolve(s)},t.prototype.yu=function(t,e){return PersistencePromise.resolve(this.ph(e))},t.prototype.Du=function(t,e){var n=this.ph(e);return assert(null!=n,"Failed to find local mutation batch."),PersistencePromise.resolve(n.keys())},t.prototype.Cu=function(t,e){var n=e+1,r=this.bh(n),i=r<0?0:r;return PersistencePromise.resolve(this.Xu.length>i?this.Xu[i]:null)},t.prototype.Ou=function(){return PersistencePromise.resolve(0===this.Xu.length?__PRIVATE_BATCHID_UNKNOWN:this.Vh-1)},t.prototype.Fu=function(t){return PersistencePromise.resolve(this.Xu.slice())},t.prototype.Nu=function(t,e){var n=this,r=new __PRIVATE_DocReference(e,0),i=new __PRIVATE_DocReference(e,Number.POSITIVE_INFINITY),s=[];return this.mh.jt([r,i],(function(t){assert(e.isEqual(t.key),"Should only iterate over a single key's batches");var r=n.ph(t.mo);assert(null!==r,"Batches in the index must exist in the main table"),s.push(r)})),PersistencePromise.resolve(s)},t.prototype.Mu=function(t,e){var n=this,r=new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator);return e.forEach((function(t){var e=new __PRIVATE_DocReference(t,0),i=new __PRIVATE_DocReference(t,Number.POSITIVE_INFINITY);n.mh.jt([e,i],(function(e){assert(t.isEqual(e.key),"For each key, should only iterate over a single key's batches"),r=r.add(e.mo)}))})),PersistencePromise.resolve(this.gh(r))},t.prototype.Gu=function(t,e){assert(!e.bn(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,i=n;__PRIVATE_DocumentKey.lt(i)||(i=i.child(""));var s=new __PRIVATE_DocReference(new __PRIVATE_DocumentKey(i),0),o=new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator);return this.mh.Qt((function(t){var e=t.key.path;return!!n.rt(e)&&(e.length===r&&(o=o.add(t.mo)),!0)}),s),PersistencePromise.resolve(this.gh(o))},t.prototype.gh=function(t){var e=this,n=[];return t.forEach((function(t){var r=e.ph(t);null!==r&&n.push(r)})),n},t.prototype.Bu=function(t,e){var n=this;assert(0===this.vh(e.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.Xu.shift();var r=this.mh;return PersistencePromise.forEach(e.mutations,(function(i){var s=new __PRIVATE_DocReference(i.key,e.batchId);return r=r.delete(s),n.Pu.xu(t,i.key)})).next((function(){n.mh=r}))},t.prototype.ku=function(t){},t.prototype.Vo=function(t,e){var n=new __PRIVATE_DocReference(e,0),r=this.mh.Wt(n);return PersistencePromise.resolve(e.isEqual(r&&r.key))},t.prototype.Ku=function(t){return 0===this.Xu.length&&assert(this.mh.tt(),"Document leak -- detected dangling mutation references when queue is empty."),PersistencePromise.resolve()},t.prototype.vh=function(t,e){var n=this.bh(t);return assert(n>=0&&n<this.Xu.length,"Batches must exist to be "+e),n},t.prototype.bh=function(t){return 0===this.Xu.length?0:t-this.Xu[0].batchId},t.prototype.ph=function(t){var e=this.bh(t);if(e<0||e>=this.Xu.length)return null;var n=this.Xu[e];return assert(n.batchId===t,"If found batch must match"),n},t}();function __PRIVATE_documentEntryMap(){return new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H)}var __PRIVATE_PersistentStreamState,__PRIVATE_MemoryRemoteDocumentCache=function(){function t(t,e){this.Eu=t,this.wh=e,this.docs=__PRIVATE_documentEntryMap(),this.size=0}return t.prototype.Uo=function(t,e,n){assert(!n.isEqual(__PRIVATE_SnapshotVersion.MIN),"Cannot add a document with a read time of zero");var r=e.key,i=this.docs.get(r),s=i?i.size:0,o=this.wh(e);return this.docs=this.docs.Pt(r,{ac:e,size:o,readTime:n}),this.size+=o-s,this.Eu.wu(t,r.path.Z())},t.prototype.xo=function(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)},t.prototype.Ko=function(t,e){var n=this.docs.get(e);return PersistencePromise.resolve(n?n.ac:null)},t.prototype.getEntries=function(t,e){var n=this,r=__PRIVATE_nullableMaybeDocumentMap();return e.forEach((function(t){var e=n.docs.get(t);r=r.Pt(t,e?e.ac:null)})),PersistencePromise.resolve(r)},t.prototype.ra=function(t,e,n){assert(!e.bn(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var r=__PRIVATE_documentMap(),i=new __PRIVATE_DocumentKey(e.path.child("")),s=this.docs.bt(i);s.Ct();){var o=s.Dt(),u=o.key,a=o.value,_=a.ac,c=a.readTime;if(!e.path.rt(u.path))break;c._(n)<=0||_ instanceof Document&&e.matches(_)&&(r=r.Pt(_.key,_))}return PersistencePromise.resolve(r)},t.prototype.yh=function(t,e){return PersistencePromise.forEach(this.docs,(function(t){return e(t)}))},t.prototype.f_=function(t,e){throw new Error("getNewDocumentChanges() is not supported with MemoryPersistence")},t.prototype.T_=function(t){return PersistencePromise.resolve(__PRIVATE_SnapshotVersion.MIN)},t.prototype.Na=function(e){return new t.Ec(this)},t.prototype.Pc=function(t){return PersistencePromise.resolve(this.size)},t.Ec=function(t){function e(e){var n=t.call(this)||this;return n.Ac=e,n}return tslib.__extends(e,t),e.prototype.Qo=function(t){var e=this,n=[];return this.Lo.forEach((function(r,i){i?n.push(e.Ac.Uo(t,i,e.readTime)):e.Ac.xo(r)})),PersistencePromise.No(n)},e.prototype.qo=function(t,e){return this.Ac.Ko(t,e)},e.prototype.jo=function(t,e){return this.Ac.getEntries(t,e)},e}(__PRIVATE_RemoteDocumentChangeBuffer),t}(),__PRIVATE_MemoryTargetCache=function(){function t(t){this.persistence=t,this.Sh=new __PRIVATE_ObjectMap((function(t){return t.canonicalId()})),this.lastRemoteSnapshotVersion=__PRIVATE_SnapshotVersion.MIN,this.highestTargetId=0,this.Dh=0,this.Ch=new __PRIVATE_ReferenceSet,this.targetCount=0,this.Y_=__PRIVATE_TargetIdGenerator.Yu()}return t.prototype.kr=function(t,e){return this.Sh.forEach((function(t,n){return e(n)})),PersistencePromise.resolve()},t.prototype.Ba=function(t){return PersistencePromise.resolve(this.lastRemoteSnapshotVersion)},t.prototype.X_=function(t){return PersistencePromise.resolve(this.Dh)},t.prototype.Za=function(t){var e=this.Y_.after(this.highestTargetId);return this.highestTargetId=e,PersistencePromise.resolve(e)},t.prototype.Wa=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Dh&&(this.Dh=e),PersistencePromise.resolve()},t.prototype.J_=function(t){this.Sh.set(t.target,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.Dh&&(this.Dh=t.sequenceNumber)},t.prototype.t_=function(t,e){return assert(!this.Sh.has(e.target),"Adding a target that already exists"),this.J_(e),this.targetCount+=1,PersistencePromise.resolve()},t.prototype.ja=function(t,e){return assert(this.Sh.has(e.target),"Updating a non-existent target"),this.J_(e),PersistencePromise.resolve()},t.prototype.tc=function(t,e){return assert(this.targetCount>0,"Removing a target from an empty cache"),assert(this.Sh.has(e.target),"Removing a non-existent target from the cache"),this.Sh.delete(e.target),this.Ch.Ao(e.targetId),this.targetCount-=1,PersistencePromise.resolve()},t.prototype.q_=function(t,e,n){var r=this,i=0,s=[];return this.Sh.forEach((function(o,u){u.sequenceNumber<=e&&null===n.get(u.targetId)&&(r.Sh.delete(o),s.push(r.ec(t,u.targetId)),i++)})),PersistencePromise.No(s).next((function(){return i}))},t.prototype.ic=function(t){return PersistencePromise.resolve(this.targetCount)},t.prototype.Ja=function(t,e){var n=this.Sh.get(e)||null;return PersistencePromise.resolve(n)},t.prototype.Xr=function(t,e){return fail("Not yet implemented.")},t.prototype.xa=function(t,e,n){this.Ch.To(e,n);var r=this.persistence.Pu,i=[];return r&&e.forEach((function(e){i.push(r.lo(t,e))})),PersistencePromise.No(i)},t.prototype.ka=function(t,e,n){this.Ch.Po(e,n);var r=this.persistence.Pu,i=[];return r&&e.forEach((function(e){i.push(r.do(t,e))})),PersistencePromise.No(i)},t.prototype.ec=function(t,e){return this.Ch.Ao(e),PersistencePromise.resolve()},t.prototype.r_=function(t,e){var n=this.Ch.Io(e);return PersistencePromise.resolve(n)},t.prototype.Vo=function(t,e){return PersistencePromise.resolve(this.Ch.Vo(e))},t}(),__PRIVATE_LOG_TAG$4="MemoryPersistence",__PRIVATE_MemoryPersistence=function(){function t(t,e){var n=this;this.clientId=t,this.Oh={},this.Wc=new __PRIVATE_ListenSequence(0),this.Dc=!1,this.Dc=!0,this.Pu=e(this),this.ma=new __PRIVATE_MemoryTargetCache(this);this.Eu=new __PRIVATE_MemoryIndexManager,this.zu=new __PRIVATE_MemoryRemoteDocumentCache(this.Eu,(function(t){return n.Pu.Fh(t)}))}return t.Nh=function(e,n){return new t(e,(function(t){return new __PRIVATE_MemoryLruDelegate(t,n)}))},t.Mh=function(e){return new t(e,(function(t){return new __PRIVATE_MemoryEagerDelegate(t)}))},t.prototype.shutdown=function(){return this.Dc=!1,Promise.resolve()},Object.defineProperty(t.prototype,"Pa",{get:function(){return this.Dc},enumerable:!0,configurable:!0}),t.prototype.o_=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){return[2,[this.clientId]]}))}))},t.prototype.$c=function(t){return t(!0)},t.prototype.Yc=function(){},t.prototype.a_=function(t){},t.prototype.ba=function(){return this.Eu},t.prototype.Ra=function(t){var e=this.Oh[t.I()];return e||(e=new __PRIVATE_MemoryMutationQueue(this.Eu,this.Pu),this.Oh[t.I()]=e),e},t.prototype.va=function(){return this.ma},t.prototype.Va=function(){return this.zu},t.prototype.runTransaction=function(t,e,n){var r=this;debug(__PRIVATE_LOG_TAG$4,"Starting transaction:",t);var i=new __PRIVATE_MemoryTransaction(this.Wc.next());return this.Pu.Lh(),n(i).next((function(t){return r.Pu.Gh(i).next((function(){return t}))})).Oo().then((function(t){return i.Yo(),t}))},t.prototype.Bh=function(t,e){return PersistencePromise.Mo(values(this.Oh).map((function(n){return function(){return n.Vo(t,e)}})))},t}(),__PRIVATE_MemoryTransaction=function(t){function e(e){var n=t.call(this)||this;return n.Ka=e,n}return tslib.__extends(e,t),e}(__PRIVATE_PersistenceTransaction),__PRIVATE_MemoryEagerDelegate=function(){function t(t){this.persistence=t,this.lh=null,this.Uh=null}return Object.defineProperty(t.prototype,"kh",{get:function(){if(this.Uh)return this.Uh;throw fail("orphanedDocuments is only valid during a transaction.")},enumerable:!0,configurable:!0}),t.prototype.Aa=function(t){this.lh=t},t.prototype.lo=function(t,e){return this.kh.delete(e),PersistencePromise.resolve()},t.prototype.do=function(t,e){return this.kh.add(e),PersistencePromise.resolve()},t.prototype.xu=function(t,e){return this.kh.add(e),PersistencePromise.resolve()},t.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.va();return r.r_(t,e.targetId).next((function(t){t.forEach((function(t){return n.kh.add(t)}))})).next((function(){return r.tc(t,e)}))},t.prototype.Lh=function(){this.Uh=new Set},t.prototype.Gh=function(t){var e=this,n=this.persistence.Va().Na();return PersistencePromise.forEach(this.kh,(function(r){return e.xh(t,r).next((function(t){t||n.xo(r)}))})).next((function(){return e.Uh=null,n.apply(t)}))},t.prototype.Qa=function(t,e){var n=this;return this.xh(t,e).next((function(t){t?n.kh.delete(e):n.kh.add(e)}))},t.prototype.Fh=function(t){return 0},t.prototype.xh=function(t,e){var n=this;return PersistencePromise.Mo([function(){return n.persistence.va().Vo(t,e)},function(){return n.persistence.Bh(t,e)},function(){return PersistencePromise.resolve(n.lh.Vo(e))}])},t}(),__PRIVATE_MemoryLruDelegate=function(){function t(t,e){this.persistence=t,this.lh=null,this.Kh=new __PRIVATE_ObjectMap((function(t){return encode(t.path)})),this.F_=new __PRIVATE_LruGarbageCollector(this,e)}return t.prototype.Lh=function(){},t.prototype.Gh=function(t){return PersistencePromise.resolve()},t.prototype.kr=function(t,e){return this.persistence.va().kr(t,e)},t.prototype.k_=function(t){var e=this.qh(t);return this.persistence.va().ic(t).next((function(t){return e.next((function(e){return t+e}))}))},t.prototype.qh=function(t){var e=0;return this.K_(t,(function(t){e++})).next((function(){return e}))},t.prototype.K_=function(t,e){var n=this;return PersistencePromise.forEach(this.Kh,(function(r,i){return n.Eh(t,r,i).next((function(t){return t?PersistencePromise.resolve():e(i)}))}))},t.prototype.Aa=function(t){this.lh=t},t.prototype.q_=function(t,e,n){return this.persistence.va().q_(t,e,n)},t.prototype.j_=function(t,e){var n=this,r=0,i=this.persistence.Va(),s=i.Na();return i.yh(t,(function(i){return n.Eh(t,i,e).next((function(t){t||(r++,s.xo(i))}))})).next((function(){return s.apply(t)})).next((function(){return r}))},t.prototype.xu=function(t,e){return this.Kh.set(e,t.Ka),PersistencePromise.resolve()},t.prototype.removeTarget=function(t,e){var n=e.Nn(t.Ka);return this.persistence.va().ja(t,n)},t.prototype.lo=function(t,e){return this.Kh.set(e,t.Ka),PersistencePromise.resolve()},t.prototype.do=function(t,e){return this.Kh.set(e,t.Ka),PersistencePromise.resolve()},t.prototype.Qa=function(t,e){return this.Kh.set(e,t.Ka),PersistencePromise.resolve()},t.prototype.Fh=function(t){var e=t.key.toString().length;return t instanceof Document&&(e+=t.data().Me()),e},t.prototype.Eh=function(t,e,n){var r=this;return PersistencePromise.Mo([function(){return r.persistence.Bh(t,e)},function(){return PersistencePromise.resolve(r.lh.Vo(e))},function(){return r.persistence.va().Vo(t,e)},function(){var t=r.Kh.get(e);return PersistencePromise.resolve(void 0!==t&&t>n)}])},t.prototype.Q_=function(t){return this.persistence.Va().Pc(t)},t}(),__PRIVATE_LOG_TAG$5="ExponentialBackoff",__PRIVATE_DEFAULT_BACKOFF_INITIAL_DELAY_MS=1e3,__PRIVATE_DEFAULT_BACKOFF_FACTOR=1.5,__PRIVATE_DEFAULT_BACKOFF_MAX_DELAY_MS=6e4,__PRIVATE_ExponentialBackoff=function(){function t(t,e,n,r,i){void 0===n&&(n=__PRIVATE_DEFAULT_BACKOFF_INITIAL_DELAY_MS),void 0===r&&(r=__PRIVATE_DEFAULT_BACKOFF_FACTOR),void 0===i&&(i=__PRIVATE_DEFAULT_BACKOFF_MAX_DELAY_MS),this.yc=t,this.Os=e,this.jh=n,this.Qh=r,this.Wh=i,this.$h=0,this.Yh=null,this.Hh=Date.now(),this.reset()}return t.prototype.reset=function(){this.$h=0},t.prototype.zh=function(){this.$h=this.Wh},t.prototype.Xh=function(t){var e=this;this.cancel();var n=Math.floor(this.$h+this.Jh()),r=Math.max(0,Date.now()-this.Hh),i=Math.max(0,n-r);this.$h>0&&debug(__PRIVATE_LOG_TAG$5,"Backing off for "+i+" ms (base delay: "+this.$h+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.Yh=this.yc.Zs(this.Os,i,(function(){return e.Hh=Date.now(),t()})),this.$h*=this.Qh,this.$h<this.jh&&(this.$h=this.jh),this.$h>this.Wh&&(this.$h=this.Wh)},t.prototype.cancel=function(){null!==this.Yh&&(this.Yh.cancel(),this.Yh=null)},t.prototype.Jh=function(){return(Math.random()-.5)*this.$h},t}(),__PRIVATE_LOG_TAG$6="PersistentStream";!function(t){t[t.Zh=0]="__PRIVATE_Initial",t[t.tf=1]="__PRIVATE_Starting",t[t.ef=2]="__PRIVATE_Open",t[t.Error=3]="Error",t[t.nf=4]="__PRIVATE_Backoff"}(__PRIVATE_PersistentStreamState||(__PRIVATE_PersistentStreamState={}));var __PRIVATE_IDLE_TIMEOUT_MS=6e4,__PRIVATE_PersistentStream=function(){function t(t,e,n,r,i,s){this.yc=t,this.rf=n,this.connection=r,this.if=i,this.listener=s,this.state=__PRIVATE_PersistentStreamState.Zh,this.sf=0,this.uf=null,this.stream=null,this.af=new __PRIVATE_ExponentialBackoff(t,e)}return t.prototype._f=function(){return this.state===__PRIVATE_PersistentStreamState.tf||this.state===__PRIVATE_PersistentStreamState.ef||this.state===__PRIVATE_PersistentStreamState.nf},t.prototype.cf=function(){return this.state===__PRIVATE_PersistentStreamState.ef},t.prototype.start=function(){this.state!==__PRIVATE_PersistentStreamState.Error?(assert(this.state===__PRIVATE_PersistentStreamState.Zh,"Already started"),this.auth()):this.hf()},t.prototype.stop=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return this._f()?[4,this.close(__PRIVATE_PersistentStreamState.Zh)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.ff=function(){assert(!this._f(),"Can only inhibit backoff in a stopped state"),this.state=__PRIVATE_PersistentStreamState.Zh,this.af.reset()},t.prototype.lf=function(){var t=this;this.cf()&&null===this.uf&&(this.uf=this.yc.Zs(this.rf,__PRIVATE_IDLE_TIMEOUT_MS,(function(){return t.Tf()})))},t.prototype.df=function(t){this.Ef(),this.stream.send(t)},t.prototype.Tf=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){return this.cf()?[2,this.close(__PRIVATE_PersistentStreamState.Zh)]:[2]}))}))},t.prototype.Ef=function(){this.uf&&(this.uf.cancel(),this.uf=null)},t.prototype.close=function(t,e){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(n){switch(n.label){case 0:return assert(this._f(),"Only started streams should be closed."),assert(t===__PRIVATE_PersistentStreamState.Error||isNullOrUndefined(e),"Can't provide an error when not in an error state."),this.Ef(),this.af.cancel(),this.sf++,t!==__PRIVATE_PersistentStreamState.Error?this.af.reset():e&&e.code===Code.RESOURCE_EXHAUSTED?(error(e.toString()),error("Using maximum backoff delay to prevent overloading the backend."),this.af.zh()):e&&e.code===Code.UNAUTHENTICATED&&this.if.g(),null!==this.stream&&(this.Pf(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.Af(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.Pf=function(){},t.prototype.auth=function(){var t=this;assert(this.state===__PRIVATE_PersistentStreamState.Zh,"Must be in initial state to auth"),this.state=__PRIVATE_PersistentStreamState.tf;var e=this.Rf(this.sf),n=this.sf;this.if.getToken().then((function(e){t.sf===n&&t.If(e)}),(function(n){e((function(){var e=new FirestoreError(Code.UNKNOWN,"Fetching auth token failed: "+n.message);return t.Vf(e)}))}))},t.prototype.If=function(t){var e=this;assert(this.state===__PRIVATE_PersistentStreamState.tf,"Trying to start stream in a non-starting state");var n=this.Rf(this.sf);this.stream=this.mf(t),this.stream.vf((function(){n((function(){return assert(e.state===__PRIVATE_PersistentStreamState.tf,"Expected stream to be in state Starting, but was "+e.state),e.state=__PRIVATE_PersistentStreamState.ef,e.listener.vf()}))})),this.stream.Af((function(t){n((function(){return e.Vf(t)}))})),this.stream.onMessage((function(t){n((function(){return e.onMessage(t)}))}))},t.prototype.hf=function(){var t=this;assert(this.state===__PRIVATE_PersistentStreamState.Error,"Should only perform backoff when in Error state"),this.state=__PRIVATE_PersistentStreamState.nf,this.af.Xh((function(){return tslib.__awaiter(t,void 0,void 0,(function(){return tslib.__generator(this,(function(t){return assert(this.state===__PRIVATE_PersistentStreamState.nf,"Backoff elapsed but state is now: "+this.state),this.state=__PRIVATE_PersistentStreamState.Zh,this.start(),assert(this._f(),"PersistentStream should have started"),[2]}))}))}))},t.prototype.Vf=function(t){return assert(this._f(),"Can't handle server close on non-started stream"),debug(__PRIVATE_LOG_TAG$6,"close with error: "+t),this.stream=null,this.close(__PRIVATE_PersistentStreamState.Error,t)},t.prototype.Rf=function(t){var e=this;return function(n){e.yc.ks((function(){return e.sf===t?n():(debug(__PRIVATE_LOG_TAG$6,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())}))}},t}(),__PRIVATE_PersistentListenStream=function(t){function e(e,n,r,i,s){var o=t.call(this,e,__PRIVATE_TimerId.ps,__PRIVATE_TimerId.vs,n,r,s)||this;return o.serializer=i,o}return tslib.__extends(e,t),e.prototype.mf=function(t){return this.connection.pf("Listen",t)},e.prototype.onMessage=function(t){this.af.reset();var e=this.serializer.Ci(t),n=this.serializer.Fi(t);return this.listener.bf(e,n)},e.prototype.watch=function(t){var e={};e.database=this.serializer.Ei,e.addTarget=this.serializer.En(t);var n=this.serializer.ts(t);n&&(e.labels=n),this.df(e)},e.prototype.gf=function(t){var e={};e.database=this.serializer.Ei,e.removeTarget=t,this.df(e)},e}(__PRIVATE_PersistentStream),__PRIVATE_PersistentWriteStream=function(t){function e(e,n,r,i,s){var o=t.call(this,e,__PRIVATE_TimerId.gs,__PRIVATE_TimerId.bs,n,r,s)||this;return o.serializer=i,o.wf=!1,o.lastStreamToken=__PRIVATE_emptyByteString(),o}return tslib.__extends(e,t),Object.defineProperty(e.prototype,"yf",{get:function(){return this.wf},enumerable:!0,configurable:!0}),e.prototype.start=function(){this.wf=!1,t.prototype.start.call(this)},e.prototype.Pf=function(){this.wf&&this.Sf([])},e.prototype.mf=function(t){return this.connection.pf("Write",t)},e.prototype.onMessage=function(t){if(assert(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.wf){this.af.reset();var e=this.serializer.qi(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.Df(n,e)}return assert(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.wf=!0,this.listener.Cf()},e.prototype.Of=function(){assert(this.cf(),"Writing handshake requires an opened stream"),assert(!this.wf,"Handshake already completed");var t={};t.database=this.serializer.Ei,this.df(t)},e.prototype.Sf=function(t){var e=this;assert(this.cf(),"Writing mutations requires an opened stream"),assert(this.wf,"Handshake must be complete before writing mutations"),assert(this.lastStreamToken.length>0,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:t.map((function(t){return e.serializer.Ni(t)}))};this.df(n)},e}(__PRIVATE_PersistentStream),__PRIVATE_Datastore=function(){function t(t,e,n,r){this.yc=t,this.connection=e,this.credentials=n,this.serializer=r}return t.prototype.Ff=function(t){return new __PRIVATE_PersistentWriteStream(this.yc,this.connection,this.credentials,this.serializer,t)},t.prototype.Nf=function(t){return new __PRIVATE_PersistentListenStream(this.yc,this.connection,this.credentials,this.serializer,t)},t.prototype.commit=function(t){var e=this,n={database:this.serializer.Ei,writes:t.map((function(t){return e.serializer.Ni(t)}))};return this.Mf("Commit",n).then((function(t){return e.serializer.qi(t.writeResults,t.commitTime)}))},t.prototype.lookup=function(t){var e=this,n={database:this.serializer.Ei,documents:t.map((function(t){return e.serializer.hi(t)}))};return this.Lf("BatchGetDocuments",n).then((function(n){var r=__PRIVATE_maybeDocumentMap();n.forEach((function(t){var n=e.serializer.yi(t);r=r.Pt(n.key,n)}));var i=[];return t.forEach((function(t){var e=r.get(t);assert(!!e,"Missing entity in write response for "+t),i.push(e)})),i}))},t.prototype.Mf=function(t,e){var n=this;return this.credentials.getToken().then((function(r){return n.connection.Mf(t,e,r)})).catch((function(t){throw t.code===Code.UNAUTHENTICATED&&n.credentials.g(),t}))},t.prototype.Lf=function(t,e){var n=this;return this.credentials.getToken().then((function(r){return n.connection.Lf(t,e,r)})).catch((function(t){throw t.code===Code.UNAUTHENTICATED&&n.credentials.g(),t}))},t}(),FieldPath$1=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];__PRIVATE_validateNamedArrayAtLeastNumberOfElements("FieldPath",t,"fieldNames",1);for(var n=0;n<t.length;++n)if(__PRIVATE_validateArgType("FieldPath","string",n,t[n]),0===t[n].length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this.Gf=new FieldPath(t)}return t.documentId=function(){return t.Bf},t.prototype.isEqual=function(e){if(!(e instanceof t))throw __PRIVATE_invalidClassError("isEqual","FieldPath",1,e);return this.Gf.isEqual(e.Gf)},t.Bf=new t(FieldPath.ht().ot()),t}(),__PRIVATE_RESERVED=new RegExp("[~\\*/\\[\\]]");function __PRIVATE_fromDotSeparatedString(t){if(t.search(__PRIVATE_RESERVED)>=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(FieldPath$1.bind.apply(FieldPath$1,tslib.__spreadArrays([void 0],t.split("."))))}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}var __PRIVATE_UserDataSource,__PRIVATE_FieldValueImpl=function(){function t(t){this.Uf=t}return t.delete=function(){return __PRIVATE_validateNoArgs("FieldValue.delete",arguments),__PRIVATE_DeleteFieldValueImpl.instance},t.serverTimestamp=function(){return __PRIVATE_validateNoArgs("FieldValue.serverTimestamp",arguments),__PRIVATE_ServerTimestampFieldValueImpl.instance},t.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return __PRIVATE_validateAtLeastNumberOfArgs("FieldValue.arrayUnion",arguments,1),new __PRIVATE_ArrayUnionFieldValueImpl(t)},t.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return __PRIVATE_validateAtLeastNumberOfArgs("FieldValue.arrayRemove",arguments,1),new __PRIVATE_ArrayRemoveFieldValueImpl(t)},t.increment=function(t){return __PRIVATE_validateArgType("FieldValue.increment","number",1,t),__PRIVATE_validateExactNumberOfArgs("FieldValue.increment",arguments,1),new __PRIVATE_NumericIncrementFieldValueImpl(t)},t.prototype.isEqual=function(t){return this===t},t}(),__PRIVATE_DeleteFieldValueImpl=function(t){function e(){return t.call(this,"FieldValue.delete")||this}return tslib.__extends(e,t),e.instance=new e,e}(__PRIVATE_FieldValueImpl),__PRIVATE_ServerTimestampFieldValueImpl=function(t){function e(){return t.call(this,"FieldValue.serverTimestamp")||this}return tslib.__extends(e,t),e.instance=new e,e}(__PRIVATE_FieldValueImpl),__PRIVATE_ArrayUnionFieldValueImpl=function(t){function e(e){var n=t.call(this,"FieldValue.arrayUnion")||this;return n.kf=e,n}return tslib.__extends(e,t),e}(__PRIVATE_FieldValueImpl),__PRIVATE_ArrayRemoveFieldValueImpl=function(t){function e(e){var n=t.call(this,"FieldValue.arrayRemove")||this;return n.kf=e,n}return tslib.__extends(e,t),e}(__PRIVATE_FieldValueImpl),__PRIVATE_NumericIncrementFieldValueImpl=function(t){function e(e){var n=t.call(this,"FieldValue.increment")||this;return n.xf=e,n}return tslib.__extends(e,t),e}(__PRIVATE_FieldValueImpl),__PRIVATE_PublicFieldValue=__PRIVATE_makeConstructorPrivate(__PRIVATE_FieldValueImpl,"Use FieldValue.<field>() instead."),__PRIVATE_RESERVED_FIELD_REGEX=/^__.*__$/,__PRIVATE_ParsedSetData=function(){function t(t,e,n){this.data=t,this.fe=e,this.fieldTransforms=n}return t.prototype.Kf=function(t,e){var n=[];return null!==this.fe?n.push(new __PRIVATE_PatchMutation(t,this.data,this.fe,e)):n.push(new __PRIVATE_SetMutation(t,this.data,e)),this.fieldTransforms.length>0&&n.push(new __PRIVATE_TransformMutation(t,this.fieldTransforms)),n},t}(),__PRIVATE_ParsedUpdateData=function(){function t(t,e,n){this.data=t,this.fe=e,this.fieldTransforms=n}return t.prototype.Kf=function(t,e){var n=[new __PRIVATE_PatchMutation(t,this.data,this.fe,e)];return this.fieldTransforms.length>0&&n.push(new __PRIVATE_TransformMutation(t,this.fieldTransforms)),n},t}();function __PRIVATE_isWrite(t){switch(t){case __PRIVATE_UserDataSource.Set:case __PRIVATE_UserDataSource.qf:case __PRIVATE_UserDataSource.jf:return!0;case __PRIVATE_UserDataSource.Qf:case __PRIVATE_UserDataSource.Wf:return!1;default:throw fail("Unexpected case for UserDataSource: "+t)}}!function(t){t[t.Set=0]="Set",t[t.jf=1]="__PRIVATE_Update",t[t.qf=2]="__PRIVATE_MergeSet",t[t.Qf=3]="__PRIVATE_Argument",t[t.Wf=4]="__PRIVATE_ArrayArgument"}(__PRIVATE_UserDataSource||(__PRIVATE_UserDataSource={}));var __PRIVATE_ParseContext=function(){function t(t,e,n,r,i,s){this.$f=t,this.methodName=e,this.path=n,this.Yf=r,void 0===i&&this.Hf(),this.Yf=void 0!==r&&r,this.fieldTransforms=i||[],this.fe=s||[]}return t.prototype.zf=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.$f,this.methodName,n,!1,this.fieldTransforms,this.fe);return r.Xf(e),r},t.prototype.Jf=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.$f,this.methodName,n,!1,this.fieldTransforms,this.fe);return r.Hf(),r},t.prototype.Zf=function(e){return new t(this.$f,this.methodName,null,!0,this.fieldTransforms,this.fe)},t.prototype.tl=function(t){var e=null===this.path||this.path.tt()?"":" (found in field "+this.path.toString()+")";return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},t.prototype.contains=function(t){return void 0!==this.fe.find((function(e){return t.rt(e)}))||void 0!==this.fieldTransforms.find((function(e){return t.rt(e.field)}))},t.prototype.Hf=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.Xf(this.path.get(t))},t.prototype.Xf=function(t){if(0===t.length)throw this.tl("Document fields must not be empty");if(__PRIVATE_isWrite(this.$f)&&__PRIVATE_RESERVED_FIELD_REGEX.test(t))throw this.tl('Document fields cannot begin and end with "__"')},t}(),__PRIVATE_DocumentKeyReference=function(t,e){this.o=t,this.key=e},__PRIVATE_UserDataConverter=function(){function t(t){this.el=t}return t.prototype.nl=function(t,e){var n=new __PRIVATE_ParseContext(__PRIVATE_UserDataSource.Set,t,FieldPath.at);__PRIVATE_validatePlainObject("Data must be an object, but it was:",n,e);var r=this.rl(e,n);return new __PRIVATE_ParsedSetData(r,null,n.fieldTransforms)},t.prototype.il=function(t,e,n){var r=new __PRIVATE_ParseContext(__PRIVATE_UserDataSource.qf,t,FieldPath.at);__PRIVATE_validatePlainObject("Data must be an object, but it was:",r,e);var i,s,o=this.rl(e,r);if(n){for(var u=new __PRIVATE_SortedSet(FieldPath.H),a=0,_=n;a<_.length;a++){var c=_[a],h=void 0;if(c instanceof FieldPath$1)h=c.Gf;else{if("string"!=typeof c)throw fail("Expected stringOrFieldPath to be a string or a FieldPath");h=__PRIVATE_fieldPathFromDotSeparatedString(t,c)}if(!r.contains(h))throw new FirestoreError(Code.INVALID_ARGUMENT,"Field '"+h+"' is specified in your field mask but missing from your input data.");u=u.add(h)}i=__PRIVATE_FieldMask.te(u),s=r.fieldTransforms.filter((function(t){return i.ne(t.field)}))}else i=__PRIVATE_FieldMask.ee(r.fe),s=r.fieldTransforms;return new __PRIVATE_ParsedSetData(o,i,s)},t.prototype.sl=function(t,e){var n=this,r=new __PRIVATE_ParseContext(__PRIVATE_UserDataSource.jf,t,FieldPath.at);__PRIVATE_validatePlainObject("Data must be an object, but it was:",r,e);var i=new __PRIVATE_SortedSet(FieldPath.H),s=__PRIVATE_ObjectValue.EMPTY;forEach(e,(function(e,o){var u=__PRIVATE_fieldPathFromDotSeparatedString(t,e),a=r.Jf(u);if((o=n.ol(o,a))instanceof __PRIVATE_DeleteFieldValueImpl)i=i.add(u);else{var _=n.rl(o,a);null!=_&&(i=i.add(u),s=s.set(u,_))}}));var o=__PRIVATE_FieldMask.te(i);return new __PRIVATE_ParsedUpdateData(s,o,r.fieldTransforms)},t.prototype.ul=function(t,e,n,r){var i=new __PRIVATE_ParseContext(__PRIVATE_UserDataSource.jf,t,FieldPath.at),s=[__PRIVATE_fieldPathFromArgument(t,e)],o=[n];if(r.length%2!=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var u=0;u<r.length;u+=2)s.push(__PRIVATE_fieldPathFromArgument(t,r[u])),o.push(r[u+1]);var a=new __PRIVATE_SortedSet(FieldPath.H),_=__PRIVATE_ObjectValue.EMPTY;for(u=0;u<s.length;++u){var c=s[u],h=i.Jf(c),f=this.ol(o[u],h);if(f instanceof __PRIVATE_DeleteFieldValueImpl)a=a.add(c);else{var l=this.rl(f,h);null!=l&&(a=a.add(c),_=_.set(c,l))}}var T=__PRIVATE_FieldMask.te(a);return new __PRIVATE_ParsedUpdateData(_,T,i.fieldTransforms)},t.prototype.al=function(t,e,n){void 0===n&&(n=!1);var r=new __PRIVATE_ParseContext(n?__PRIVATE_UserDataSource.Wf:__PRIVATE_UserDataSource.Qf,t,FieldPath.at),i=this.rl(e,r);return assert(null!=i,"Parsed data should not be null."),assert(0===r.fieldTransforms.length,"Field transforms should have been disallowed."),i},t.prototype.ol=function(t,e){try{return this.el(t)}catch(t){var n=__PRIVATE_errorMessage(t);throw e.tl(n)}},t.prototype.rl=function(t,e){if(__PRIVATE_looksLikeJsonObject(t=this.ol(t,e)))return __PRIVATE_validatePlainObject("Unsupported field value:",e,t),this._l(t,e);if(t instanceof __PRIVATE_FieldValueImpl)return this.cl(t,e),null;if(e.path&&e.fe.push(e.path),t instanceof Array){if(e.Yf&&e.$f!==__PRIVATE_UserDataSource.Wf)throw e.tl("Nested arrays are not supported");return this.hl(t,e)}return this.fl(t,e)},t.prototype._l=function(t,e){var n=this,r=new __PRIVATE_SortedMap(__PRIVATE_primitiveComparator);return __PRIVATE_isEmpty(t)?e.path&&e.path.length>0&&e.fe.push(e.path):forEach(t,(function(t,i){var s=n.rl(i,e.zf(t));null!=s&&(r=r.Pt(t,s))})),new __PRIVATE_ObjectValue(r)},t.prototype.hl=function(t,e){for(var n=[],r=0,i=0,s=t;i<s.length;i++){var o=s[i],u=this.rl(o,e.Zf(r));null==u&&(u=__PRIVATE_NullValue.Le),n.push(u),r++}return new ArrayValue(n)},t.prototype.cl=function(t,e){if(!__PRIVATE_isWrite(e.$f))throw e.tl(t.Uf+"() can only be used with update() and set()");if(null===e.path)throw e.tl(t.Uf+"() is not currently supported inside arrays");if(t instanceof __PRIVATE_DeleteFieldValueImpl){if(e.$f!==__PRIVATE_UserDataSource.qf)throw e.$f===__PRIVATE_UserDataSource.jf?(assert(e.path.length>0,"FieldValue.delete() at the top level should have already been handled."),e.tl("FieldValue.delete() can only appear at the top level of your update data")):e.tl("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fe.push(e.path)}else if(t instanceof __PRIVATE_ServerTimestampFieldValueImpl)e.fieldTransforms.push(new FieldTransform(e.path,__PRIVATE_ServerTimestampTransform.instance));else if(t instanceof __PRIVATE_ArrayUnionFieldValueImpl){var n=this.ll(t.Uf,t.kf),r=new __PRIVATE_ArrayUnionTransformOperation(n);e.fieldTransforms.push(new FieldTransform(e.path,r))}else if(t instanceof __PRIVATE_ArrayRemoveFieldValueImpl){n=this.ll(t.Uf,t.kf);var i=new __PRIVATE_ArrayRemoveTransformOperation(n);e.fieldTransforms.push(new FieldTransform(e.path,i))}else if(t instanceof __PRIVATE_NumericIncrementFieldValueImpl){var s=this.al("FieldValue.increment",t.xf),o=new __PRIVATE_NumericIncrementTransformOperation(s);e.fieldTransforms.push(new FieldTransform(e.path,o))}else fail("Unknown FieldValue type: "+t)},t.prototype.fl=function(t,e){if(null===t)return __PRIVATE_NullValue.Le;if("number"==typeof t)return isSafeInteger(t)?new __PRIVATE_IntegerValue(t):new __PRIVATE_DoubleValue(t);if("boolean"==typeof t)return __PRIVATE_BooleanValue.of(t);if("string"==typeof t)return new __PRIVATE_StringValue(t);if(t instanceof Date)return new __PRIVATE_TimestampValue(Timestamp.fromDate(t));if(t instanceof Timestamp)return new __PRIVATE_TimestampValue(new Timestamp(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof GeoPoint)return new __PRIVATE_GeoPointValue(t);if(t instanceof Blob)return new __PRIVATE_BlobValue(t);if(t instanceof __PRIVATE_DocumentKeyReference)return new __PRIVATE_RefValue(t.o,t.key);throw e.tl("Unsupported field value: "+__PRIVATE_valueDescription(t))},t.prototype.ll=function(t,e){var n=this;return e.map((function(e,r){var i=new __PRIVATE_ParseContext(__PRIVATE_UserDataSource.Qf,t,FieldPath.at);return n.rl(e,i.Zf(r))}))},t}();function __PRIVATE_looksLikeJsonObject(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Timestamp||t instanceof GeoPoint||t instanceof Blob||t instanceof __PRIVATE_DocumentKeyReference||t instanceof __PRIVATE_FieldValueImpl)}function __PRIVATE_validatePlainObject(t,e,n){if(!__PRIVATE_looksLikeJsonObject(n)||!__PRIVATE_isPlainObject(n)){var r=__PRIVATE_valueDescription(n);throw"an object"===r?e.tl(t+" a custom object"):e.tl(t+" "+r)}}function __PRIVATE_fieldPathFromArgument(t,e){if(e instanceof FieldPath$1)return e.Gf;if("string"==typeof e)return __PRIVATE_fieldPathFromDotSeparatedString(t,e);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function __PRIVATE_fieldPathFromDotSeparatedString(t,e){try{return __PRIVATE_fromDotSeparatedString(e).Gf}catch(e){var n=__PRIVATE_errorMessage(e);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+n)}}function __PRIVATE_errorMessage(t){return t instanceof Error?t.message:t.toString()}var Transaction=function(){function t(t){this.Tl=t,this.dl=__PRIVATE_documentVersionMap(),this.mutations=[],this.El=!1,this.Pl=null,this.Al=new Set}return t.prototype.lookup=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n=this;return tslib.__generator(this,(function(r){switch(r.label){case 0:if(this.Rl(),this.mutations.length>0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,this.Tl.lookup(t)];case 1:return(e=r.sent()).forEach((function(t){t instanceof __PRIVATE_NoDocument||t instanceof Document?n.Il(t):fail("Document in a transaction was a "+t.constructor.name)})),[2,e]}}))}))},t.prototype.set=function(t,e){this.write(e.Kf(t,this._e(t))),this.Al.add(t)},t.prototype.update=function(t,e){try{this.write(e.Kf(t,this.Vl(t)))}catch(t){this.Pl=t}this.Al.add(t)},t.prototype.delete=function(t){this.write([new __PRIVATE_DeleteMutation(t,this._e(t))]),this.Al.add(t)},t.prototype.commit=function(){return tslib.__awaiter(this,void 0,void 0,(function(){var t,e=this;return tslib.__generator(this,(function(n){switch(n.label){case 0:if(this.Rl(),this.Pl)throw this.Pl;return t=this.dl,this.mutations.forEach((function(e){t=t.remove(e.key)})),t.forEach((function(t,n){e.mutations.push(new __PRIVATE_VerifyMutation(t,e._e(t)))})),[4,this.Tl.commit(this.mutations)];case 1:return n.sent(),this.El=!0,[2]}}))}))},t.prototype.Il=function(t){var e;if(t instanceof Document)e=t.version;else{if(!(t instanceof __PRIVATE_NoDocument))throw fail("Document in a transaction was a "+t.constructor.name);e=__PRIVATE_SnapshotVersion.W()}var n=this.dl.get(t.key);if(null!==n){if(!e.isEqual(n))throw new FirestoreError(Code.ABORTED,"Document version changed between two reads.")}else this.dl=this.dl.Pt(t.key,e)},t.prototype._e=function(t){var e=this.dl.get(t);return!this.Al.has(t)&&e?Precondition.updateTime(e):Precondition.NONE},t.prototype.Vl=function(t){var e=this.dl.get(t);if(!this.Al.has(t)&&e){if(e.isEqual(__PRIVATE_SnapshotVersion.W()))throw new FirestoreError(Code.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Precondition.updateTime(e)}return Precondition.exists(!0)},t.prototype.write=function(t){this.Rl(),this.mutations=this.mutations.concat(t)},t.prototype.Rl=function(){assert(!this.El,"A transaction object cannot be used after its update callback has been invoked.")},t}(),__PRIVATE_LOG_TAG$7="OnlineStateTracker",__PRIVATE_MAX_WATCH_STREAM_FAILURES=1,__PRIVATE_ONLINE_STATE_TIMEOUT_MS=1e4,__PRIVATE_OnlineStateTracker=function(){function t(t,e){this.Cs=t,this.ml=e,this.state=__PRIVATE_OnlineState.h,this.vl=0,this.pl=null,this.bl=!0}return t.prototype.gl=function(){var t=this;0===this.vl&&(this.wl(__PRIVATE_OnlineState.h),assert(null===this.pl,"onlineStateTimer shouldn't be started yet"),this.pl=this.Cs.Zs(__PRIVATE_TimerId.ws,__PRIVATE_ONLINE_STATE_TIMEOUT_MS,(function(){return t.pl=null,assert(t.state===__PRIVATE_OnlineState.h,"Timer should be canceled if we transitioned to a different state."),t.yl("Backend didn't respond within "+__PRIVATE_ONLINE_STATE_TIMEOUT_MS/1e3+" seconds."),t.wl(__PRIVATE_OnlineState.T),Promise.resolve()})))},t.prototype.Sl=function(t){this.state===__PRIVATE_OnlineState.l?(this.wl(__PRIVATE_OnlineState.h),assert(0===this.vl,"watchStreamFailures must be 0"),assert(null===this.pl,"onlineStateTimer must be null")):(this.vl++,this.vl>=__PRIVATE_MAX_WATCH_STREAM_FAILURES&&(this.Dl(),this.yl("Connection failed "+__PRIVATE_MAX_WATCH_STREAM_FAILURES+" times. Most recent error: "+t.toString()),this.wl(__PRIVATE_OnlineState.T)))},t.prototype.set=function(t){this.Dl(),this.vl=0,t===__PRIVATE_OnlineState.l&&(this.bl=!1),this.wl(t)},t.prototype.wl=function(t){t!==this.state&&(this.state=t,this.ml(t))},t.prototype.yl=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.bl?(error(e),this.bl=!1):debug(__PRIVATE_LOG_TAG$7,e)},t.prototype.Dl=function(){null!==this.pl&&(this.pl.cancel(),this.pl=null)},t}(),__PRIVATE_LOG_TAG$8="RemoteStore",__PRIVATE_MAX_PENDING_WRITES=10,__PRIVATE_RemoteStore=function(){function t(t,e,n,r,i){var s=this;this.N_=t,this.Tl=e,this.Cl=[],this.Ol={},this.Fl=null,this.networkEnabled=!1,this.isPrimary=!1,this.Nl=i,this.Nl.Ml((function(t){n.ks((function(){return tslib.__awaiter(s,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return this.Ll()?(debug(__PRIVATE_LOG_TAG$8,"Restarting streams for network reachability change."),[4,this.Gl()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}))})),this.Bl=new __PRIVATE_OnlineStateTracker(n,r),this.Ul=this.Tl.Nf({vf:this.kl.bind(this),Af:this.xl.bind(this),bf:this.Kl.bind(this)}),this.ql=this.Tl.Ff({vf:this.jl.bind(this),Af:this.Ql.bind(this),Cf:this.Wl.bind(this),Df:this.Df.bind(this)})}return t.prototype.start=function(){return this.enableNetwork()},t.prototype.enableNetwork=function(){return tslib.__awaiter(this,void 0,void 0,(function(){var t;return tslib.__generator(this,(function(e){switch(e.label){case 0:return this.networkEnabled=!0,this.Ll()?(t=this.ql,[4,this.N_.vu()]):[3,3];case 1:return t.lastStreamToken=e.sent(),this.$l()?this.Yl():this.Bl.set(__PRIVATE_OnlineState.h),[4,this.Hl()];case 2:e.sent(),e.label=3;case 3:return[2]}}))}))},t.prototype.disableNetwork=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.zl()];case 1:return t.sent(),this.Bl.set(__PRIVATE_OnlineState.T),[2]}}))}))},t.prototype.zl=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return[4,this.ql.stop()];case 1:return t.sent(),[4,this.Ul.stop()];case 2:return t.sent(),this.Cl.length>0&&(debug(__PRIVATE_LOG_TAG$8,"Stopping write stream with "+this.Cl.length+" pending writes"),this.Cl=[]),this.Xl(),[2]}}))}))},t.prototype.shutdown=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return debug(__PRIVATE_LOG_TAG$8,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.zl()];case 1:return t.sent(),this.Nl.shutdown(),this.Bl.set(__PRIVATE_OnlineState.h),[2]}}))}))},t.prototype.listen=function(t){contains(this.Ol,t.targetId)||(this.Ol[t.targetId]=t,this.$l()?this.Yl():this.Ul.cf()&&this.Jl(t))},t.prototype.Zl=function(t){assert(contains(this.Ol,t),"unlisten called on target no currently watched: "+t),delete this.Ol[t],this.Ul.cf()&&this.tT(t),__PRIVATE_isEmpty(this.Ol)&&(this.Ul.cf()?this.Ul.lf():this.Ll()&&this.Bl.set(__PRIVATE_OnlineState.h))},t.prototype.Xr=function(t){return this.Ol[t]||null},t.prototype.zr=function(t){return this.eT.zr(t)},t.prototype.Jl=function(t){this.Fl.yr(t.targetId),this.Ul.watch(t)},t.prototype.tT=function(t){this.Fl.yr(t),this.Ul.gf(t)},t.prototype.Yl=function(){assert(this.$l(),"startWatchStream() called when shouldStartWatchStream() is false."),this.Fl=new __PRIVATE_WatchChangeAggregator(this),this.Ul.start(),this.Bl.gl()},t.prototype.$l=function(){return this.Ll()&&!this.Ul._f()&&!__PRIVATE_isEmpty(this.Ol)},t.prototype.Ll=function(){return this.isPrimary&&this.networkEnabled},t.prototype.Xl=function(){this.Fl=null},t.prototype.kl=function(){return tslib.__awaiter(this,void 0,void 0,(function(){var t=this;return tslib.__generator(this,(function(e){return __PRIVATE_forEachNumber(this.Ol,(function(e,n){t.Jl(n)})),[2]}))}))},t.prototype.xl=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(e){return void 0===t&&assert(!this.$l(),"Watch stream was stopped gracefully while still needed."),this.Xl(),this.$l()?(this.Bl.Sl(t),this.Yl()):this.Bl.set(__PRIVATE_OnlineState.h),[2]}))}))},t.prototype.Kl=function(t,e){return tslib.__awaiter(this,void 0,void 0,(function(){var n;return tslib.__generator(this,(function(r){switch(r.label){case 0:return this.Bl.set(__PRIVATE_OnlineState.l),t instanceof __PRIVATE_WatchTargetChange&&t.state===__PRIVATE_WatchTargetChangeState.xn&&t.cause?[2,this.nT(t)]:(t instanceof __PRIVATE_DocumentWatchChange?this.Fl.Lr(t):t instanceof __PRIVATE_ExistenceFilterChange?this.Fl.jr(t):(assert(t instanceof __PRIVATE_WatchTargetChange,"Expected watchChange to be an instance of WatchTargetChange"),this.Fl.Ur(t)),e.isEqual(__PRIVATE_SnapshotVersion.MIN)?[3,3]:[4,this.N_.Ba()]);case 1:return n=r.sent(),e._(n)>=0?[4,this.rT(e)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}}))}))},t.prototype.rT=function(t){var e=this;assert(!t.isEqual(__PRIVATE_SnapshotVersion.MIN),"Can't raise event for unknown SnapshotVersion");var n=this.Fl.$r(t);return __PRIVATE_forEachNumber(n.Zn,(function(n,r){if(r.resumeToken.length>0){var i=e.Ol[n];i&&(e.Ol[n]=i.Mn(r.resumeToken,t))}})),n.tr.forEach((function(t){var n=e.Ol[t];if(n){e.Ol[t]=n.Mn(__PRIVATE_emptyByteString(),n.Fn),e.tT(t);var r=new __PRIVATE_TargetData(n.target,t,__PRIVATE_TargetPurpose.Dn,n.sequenceNumber);e.Jl(r)}})),this.eT.Ua(n)},t.prototype.nT=function(t){var e=this;assert(!!t.cause,"Handling target error without a cause");var n=t.cause,r=Promise.resolve();return t.targetIds.forEach((function(t){r=r.then((function(){return tslib.__awaiter(e,void 0,void 0,(function(){return tslib.__generator(this,(function(e){return contains(this.Ol,t)?(delete this.Ol[t],this.Fl.removeTarget(t),[2,this.eT.iT(t,n)]):[2]}))}))}))})),r},t.prototype.Hl=function(){return tslib.__awaiter(this,void 0,void 0,(function(){var t,e;return tslib.__generator(this,(function(n){switch(n.label){case 0:return this.sT()?(t=this.Cl.length>0?this.Cl[this.Cl.length-1].batchId:__PRIVATE_BATCHID_UNKNOWN,[4,this.N_.Ha(t)]):[3,4];case 1:return null!==(e=n.sent())?[3,2]:(0===this.Cl.length&&this.ql.lf(),[3,4]);case 2:return this.oT(e),[4,this.Hl()];case 3:n.sent(),n.label=4;case 4:return this.uT()&&this.aT(),[2]}}))}))},t.prototype.sT=function(){return this.Ll()&&this.Cl.length<__PRIVATE_MAX_PENDING_WRITES},t.prototype._T=function(){return this.Cl.length},t.prototype.oT=function(t){assert(this.sT(),"addToWritePipeline called when pipeline is full"),this.Cl.push(t),this.ql.cf()&&this.ql.yf&&this.ql.Sf(t.mutations)},t.prototype.uT=function(){return this.Ll()&&!this.ql._f()&&this.Cl.length>0},t.prototype.aT=function(){assert(this.uT(),"startWriteStream() called when shouldStartWriteStream() is false."),this.ql.start()},t.prototype.jl=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){return this.ql.Of(),[2]}))}))},t.prototype.Wl=function(){var t=this;return this.N_.pu(this.ql.lastStreamToken).then((function(){for(var e=0,n=t.Cl;e<n.length;e++){var r=n[e];t.ql.Sf(r.mutations)}})).catch(__PRIVATE_ignoreIfPrimaryLeaseLoss)},t.prototype.Df=function(t,e){var n=this;assert(this.Cl.length>0,"Got result for empty write pipeline");var r=this.Cl.shift(),i=__PRIVATE_MutationBatchResult.from(r,t,e,this.ql.lastStreamToken);return this.eT.cT(i).then((function(){return n.Hl()}))},t.prototype.Ql=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e=this;return tslib.__generator(this,(function(n){return void 0===t&&assert(!this.uT(),"Write stream was stopped gracefully while still needed."),t&&this.Cl.length>0?(void 0,[2,(this.ql.yf?this.hT(t):this.fT(t)).then((function(){e.uT()&&e.aT()}))]):[2]}))}))},t.prototype.fT=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(e){return __PRIVATE_isPermanentError(t.code)?(debug(__PRIVATE_LOG_TAG$8,"RemoteStore error before completed handshake; resetting stream token: ",this.ql.lastStreamToken),this.ql.lastStreamToken=__PRIVATE_emptyByteString(),[2,this.N_.pu(__PRIVATE_emptyByteString()).catch(__PRIVATE_ignoreIfPrimaryLeaseLoss)]):[2]}))}))},t.prototype.hT=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n=this;return tslib.__generator(this,(function(r){return __PRIVATE_isPermanentWriteError(t.code)?(e=this.Cl.shift(),this.ql.ff(),[2,this.eT.lT(e.batchId,t).then((function(){return n.Hl()}))]):[2]}))}))},t.prototype.TT=function(){return new Transaction(this.Tl)},t.prototype.Gl=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.zl()];case 1:return t.sent(),this.Bl.set(__PRIVATE_OnlineState.h),[4,this.enableNetwork()];case 2:return t.sent(),[2]}}))}))},t.prototype.dT=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return this.Ll()?(debug(__PRIVATE_LOG_TAG$8,"RemoteStore restarting streams for new credential"),[4,this.Gl()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.ET=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(e){switch(e.label){case 0:return this.isPrimary=t,t&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return e.sent(),[3,4];case 2:return t?[3,4]:[4,this.zl()];case 3:e.sent(),this.Bl.set(__PRIVATE_OnlineState.h),e.label=4;case 4:return[2]}}))}))},t}(),CLIENT_STATE_KEY_PREFIX="firestore_clients";function createWebStorageClientStateKey(t,e){return assert(-1===e.indexOf("_"),"Client key cannot contain '_', but was '"+e+"'"),CLIENT_STATE_KEY_PREFIX+"_"+t+"_"+e}var MUTATION_BATCH_KEY_PREFIX="firestore_mutations";function createWebStorageMutationBatchKey(t,e,n){var r=MUTATION_BATCH_KEY_PREFIX+"_"+t+"_"+n;return e.R()&&(r+="_"+e.uid),r}var QUERY_TARGET_KEY_PREFIX="firestore_targets";function createWebStorageQueryTargetMetadataKey(t,e){return QUERY_TARGET_KEY_PREFIX+"_"+t+"_"+e}var ONLINE_STATE_KEY_PREFIX="firestore_online_state";function createWebStorageOnlineStateKey(t){return ONLINE_STATE_KEY_PREFIX+"_"+t}var SEQUENCE_NUMBER_KEY_PREFIX="firestore_sequence_number";function createWebStorageSequenceNumberKey(t){return SEQUENCE_NUMBER_KEY_PREFIX+"_"+t}var __PRIVATE_LOG_TAG$9="SharedClientState",__PRIVATE_MutationMetadata=function(){function t(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r,assert(void 0!==r==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}return t.PT=function(e,n,r){var i=JSON.parse(r),s="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error),o=void 0;return s&&i.error&&(s="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(o=new FirestoreError(i.error.code,i.error.message)),s?new t(e,n,i.state,o):(error(__PRIVATE_LOG_TAG$9,"Failed to parse mutation state for ID '"+n+"': "+r),null)},t.prototype.AT=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),__PRIVATE_QueryTargetMetadata=function(){function t(t,e,n){this.targetId=t,this.state=e,this.error=n,assert(void 0!==n==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return t.PT=function(e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),s=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(s=new FirestoreError(r.error.code,r.error.message)),i?new t(e,r.state,s):(error(__PRIVATE_LOG_TAG$9,"Failed to parse target state for ID '"+e+"': "+n),null)},t.prototype.AT=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),__PRIVATE_RemoteClientState=function(){function t(t,e){this.clientId=t,this.activeTargetIds=e}return t.PT=function(e,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,s=__PRIVATE_targetIdSet(),o=0;i&&o<r.activeTargetIds.length;++o)i=isSafeInteger(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new t(e,s):(error(__PRIVATE_LOG_TAG$9,"Failed to parse client data for instance '"+e+"': "+n),null)},t}(),__PRIVATE_SharedOnlineState=function(){function t(t,e){this.clientId=t,this.onlineState=e}return t.PT=function(e){var n=JSON.parse(e);return"object"==typeof n&&n.onlineState in __PRIVATE_OnlineState&&"string"==typeof n.clientId?new t(n.clientId,__PRIVATE_OnlineState[n.onlineState]):(error(__PRIVATE_LOG_TAG$9,"Failed to parse online state: "+e),null)},t}(),__PRIVATE_LocalClientState=function(){function t(){this.activeTargetIds=__PRIVATE_targetIdSet()}return t.prototype.RT=function(t){this.activeTargetIds=this.activeTargetIds.add(t)},t.prototype.IT=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},t.prototype.AT=function(){var t={activeTargetIds:this.activeTargetIds.st(),updateTimeMs:Date.now()};return JSON.stringify(t)},t}(),__PRIVATE_WebStorageSharedClientState=function(){function t(e,n,r,i,s){if(this.yc=e,this.platform=n,this.persistenceKey=r,this.VT=i,this.eT=null,this.ml=null,this.Ps=null,this.mT={},this.vT=this.pT.bind(this),this.Pa=!1,this.bT=[],!t.Xo(this.platform))throw new FirestoreError(Code.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=s,this.gT=createWebStorageClientStateKey(this.persistenceKey,this.VT),this.wT=createWebStorageSequenceNumberKey(this.persistenceKey),this.mT[this.VT]=new __PRIVATE_LocalClientState,this.yT=new RegExp("^"+CLIENT_STATE_KEY_PREFIX+"_"+o+"_([^_]*)$"),this.ST=new RegExp("^"+MUTATION_BATCH_KEY_PREFIX+"_"+o+"_(\\d+)(?:_(.*))?$"),this.DT=new RegExp("^"+QUERY_TARGET_KEY_PREFIX+"_"+o+"_(\\d+)$"),this.CT=createWebStorageOnlineStateKey(this.persistenceKey),this.platform.window.addEventListener("storage",this.vT)}return t.Xo=function(t){return!(!t.window||null==t.window.localStorage)},t.prototype.start=function(){return tslib.__awaiter(this,void 0,void 0,(function(){var t,e,n,r,i,s,o,u,a,_,c,h=this;return tslib.__generator(this,(function(f){switch(f.label){case 0:return assert(!this.Pa,"WebStorageSharedClientState already started"),assert(null!==this.eT,"syncEngine property must be set before calling start()"),assert(null!==this.ml,"onlineStateHandler property must be set before calling start()"),[4,this.eT.o_()];case 1:for(t=f.sent(),e=0,n=t;e<n.length;e++)(r=n[e])!==this.VT&&(i=this.getItem(createWebStorageClientStateKey(this.persistenceKey,r)))&&(s=__PRIVATE_RemoteClientState.PT(r,i))&&(this.mT[s.clientId]=s);for(this.OT(),(o=this.storage.getItem(this.CT))&&(u=this.FT(o))&&this.NT(u),a=0,_=this.bT;a<_.length;a++)c=_[a],this.pT(c);return this.bT=[],this.platform.window.addEventListener("unload",(function(){return h.shutdown()})),this.Pa=!0,[2]}}))}))},t.prototype.Is=function(t){this.setItem(this.wT,JSON.stringify(t))},t.prototype.MT=function(){var t=__PRIVATE_targetIdSet();return forEach(this.mT,(function(e,n){t=t.$t(n.activeTargetIds)})),t},t.prototype.LT=function(t){for(var e in this.mT)if(this.mT.hasOwnProperty(e)&&this.mT[e].activeTargetIds.has(t))return!0;return!1},t.prototype.GT=function(t){this.BT(t,"pending")},t.prototype.UT=function(t,e,n){this.BT(t,e,n),this.kT(t)},t.prototype.xT=function(t){var e="not-current";if(this.LT(t)){var n=this.storage.getItem(createWebStorageQueryTargetMetadataKey(this.persistenceKey,t));if(n){var r=__PRIVATE_QueryTargetMetadata.PT(t,n);r&&(e=r.state)}}return this.KT.RT(t),this.OT(),e},t.prototype.qT=function(t){this.KT.IT(t),this.OT()},t.prototype.jT=function(t){return this.KT.activeTargetIds.has(t)},t.prototype.QT=function(t){this.removeItem(createWebStorageQueryTargetMetadataKey(this.persistenceKey,t))},t.prototype.WT=function(t,e,n){this.$T(t,e,n)},t.prototype.ya=function(t,e,n){var r=this;e.forEach((function(t){r.kT(t)})),this.currentUser=t,n.forEach((function(t){r.GT(t)}))},t.prototype.YT=function(t){this.HT(t)},t.prototype.shutdown=function(){this.Pa&&(this.platform.window.removeEventListener("storage",this.vT),this.removeItem(this.gT),this.Pa=!1)},t.prototype.getItem=function(t){var e=this.storage.getItem(t);return debug(__PRIVATE_LOG_TAG$9,"READ",t,e),e},t.prototype.setItem=function(t,e){debug(__PRIVATE_LOG_TAG$9,"SET",t,e),this.storage.setItem(t,e)},t.prototype.removeItem=function(t){debug(__PRIVATE_LOG_TAG$9,"REMOVE",t),this.storage.removeItem(t)},t.prototype.pT=function(t){var e=this;if(t.storageArea===this.storage){if(debug(__PRIVATE_LOG_TAG$9,"EVENT",t.key,t.newValue),t.key===this.gT)return void error("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.yc.ks((function(){return tslib.__awaiter(e,void 0,void 0,(function(){var e,n,r,i,s,o;return tslib.__generator(this,(function(u){if(!this.Pa)return this.bT.push(t),[2];if(null===t.key)return[2];if(this.yT.test(t.key)){if(null==t.newValue)return n=this.zT(t.key),[2,this.XT(n,null)];if(e=this.JT(t.key,t.newValue))return[2,this.XT(e.clientId,e)]}else if(this.ST.test(t.key)){if(null!==t.newValue&&(r=this.ZT(t.key,t.newValue)))return[2,this.td(r)]}else if(this.DT.test(t.key)){if(null!==t.newValue&&(i=this.ed(t.key,t.newValue)))return[2,this.nd(i)]}else if(t.key===this.CT){if(null!==t.newValue&&(s=this.FT(t.newValue)))return[2,this.NT(s)]}else t.key===this.wT&&(assert(!!this.Ps,"Missing sequenceNumberHandler"),(o=__PRIVATE_fromWebStorageSequenceNumber(t.newValue))!==__PRIVATE_ListenSequence.Vs&&this.Ps(o));return[2]}))}))}))}},Object.defineProperty(t.prototype,"KT",{get:function(){return this.mT[this.VT]},enumerable:!0,configurable:!0}),t.prototype.OT=function(){this.setItem(this.gT,this.KT.AT())},t.prototype.BT=function(t,e,n){var r=new __PRIVATE_MutationMetadata(this.currentUser,t,e,n),i=createWebStorageMutationBatchKey(this.persistenceKey,this.currentUser,t);this.setItem(i,r.AT())},t.prototype.kT=function(t){var e=createWebStorageMutationBatchKey(this.persistenceKey,this.currentUser,t);this.removeItem(e)},t.prototype.HT=function(t){var e={clientId:this.VT,onlineState:__PRIVATE_OnlineState[t]};this.storage.setItem(this.CT,JSON.stringify(e))},t.prototype.$T=function(t,e,n){var r=createWebStorageQueryTargetMetadataKey(this.persistenceKey,t),i=new __PRIVATE_QueryTargetMetadata(t,e,n);this.setItem(r,i.AT())},t.prototype.zT=function(t){var e=this.yT.exec(t);return e?e[1]:null},t.prototype.JT=function(t,e){var n=this.zT(t);return assert(null!==n,"Cannot parse client state key '"+t+"'"),__PRIVATE_RemoteClientState.PT(n,e)},t.prototype.ZT=function(t,e){var n=this.ST.exec(t);assert(null!==n,"Cannot parse mutation batch key '"+t+"'");var r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return __PRIVATE_MutationMetadata.PT(new User(i),r,e)},t.prototype.ed=function(t,e){var n=this.DT.exec(t);assert(null!==n,"Cannot parse query target key '"+t+"'");var r=Number(n[1]);return __PRIVATE_QueryTargetMetadata.PT(r,e)},t.prototype.FT=function(t){return __PRIVATE_SharedOnlineState.PT(t)},t.prototype.td=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(e){return t.user.uid!==this.currentUser.uid?(debug(__PRIVATE_LOG_TAG$9,"Ignoring mutation for non-active user "+t.user.uid),[2]):[2,this.eT.rd(t.batchId,t.state,t.error)]}))}))},t.prototype.nd=function(t){return this.eT.sd(t.targetId,t.state,t.error)},t.prototype.XT=function(t,e){var n=this,r=this.MT();e?this.mT[t]=e:delete this.mT[t];var i=this.MT(),s=[],o=[];return i.forEach((function(t){return tslib.__awaiter(n,void 0,void 0,(function(){return tslib.__generator(this,(function(e){return r.has(t)||s.push(t),[2]}))}))})),r.forEach((function(t){return tslib.__awaiter(n,void 0,void 0,(function(){return tslib.__generator(this,(function(e){return i.has(t)||o.push(t),[2]}))}))})),this.eT.od(s,o)},t.prototype.NT=function(t){this.mT[t.clientId]&&this.ml(t.onlineState)},t}();function __PRIVATE_fromWebStorageSequenceNumber(t){var e=__PRIVATE_ListenSequence.Vs;if(null!=t)try{var n=JSON.parse(t);assert("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){error(__PRIVATE_LOG_TAG$9,"Failed to read sequence number from WebStorage",t)}return e}var __PRIVATE_MemorySharedClientState=function(){function t(){this.ud=new __PRIVATE_LocalClientState,this.ad={},this.eT=null,this.ml=null,this.Ps=null}return t.prototype.GT=function(t){},t.prototype.UT=function(t,e,n){},t.prototype.xT=function(t){return this.ud.RT(t),this.ad[t]||"not-current"},t.prototype.WT=function(t,e,n){this.ad[t]=e},t.prototype.qT=function(t){this.ud.IT(t)},t.prototype.jT=function(t){return this.ud.activeTargetIds.has(t)},t.prototype.QT=function(t){delete this.ad[t]},t.prototype.MT=function(){return this.ud.activeTargetIds},t.prototype.LT=function(t){return this.ud.activeTargetIds.has(t)},t.prototype.start=function(){return this.ud=new __PRIVATE_LocalClientState,Promise.resolve()},t.prototype.ya=function(t,e,n){},t.prototype.YT=function(t){},t.prototype.shutdown=function(){},t.prototype.Is=function(t){},t}(),__PRIVATE_AddedLimboDocument=function(t){this.key=t},__PRIVATE_RemovedLimboDocument=function(t){this.key=t},__PRIVATE_View=function(){function t(t,e){this.query=t,this._d=e,this.hd=null,this.sr=!1,this.fd=__PRIVATE_documentKeySet(),this.Hn=__PRIVATE_documentKeySet(),this.ld=new __PRIVATE_DocumentSet(t.Pn.bind(t))}return Object.defineProperty(t.prototype,"Td",{get:function(){return this._d},enumerable:!0,configurable:!0}),t.prototype.dd=function(t,e){var n=this,r=e?e.Ed:new __PRIVATE_DocumentChangeSet,i=e?e.ld:this.ld,s=e?e.Hn:this.Hn,o=i,u=!1,a=this.query.mn()&&i.size===this.query.limit?i.last():null,_=this.query.vn()&&i.size===this.query.limit?i.first():null;if(t.Vt((function(t,e){var c=i.get(t),h=e instanceof Document?e:null;h&&(assert(t.isEqual(h.key),"Mismatching keys found in document changes: "+t+" != "+h.key),h=n.query.matches(h)?h:null);var f=!!c&&n.Hn.has(c.key),l=!!h&&(h.ce||n.Hn.has(h.key)&&h.hasCommittedMutations),T=!1;c&&h?c.data().isEqual(h.data())?f!==l&&(r.track({type:__PRIVATE_ChangeType.qn,doc:h}),T=!0):n.Pd(c,h)||(r.track({type:__PRIVATE_ChangeType.Kn,doc:h}),T=!0,(a&&n.query.Pn(h,a)>0||_&&n.query.Pn(h,_)<0)&&(u=!0)):!c&&h?(r.track({type:__PRIVATE_ChangeType.kn,doc:h}),T=!0):c&&!h&&(r.track({type:__PRIVATE_ChangeType.xn,doc:c}),T=!0,(a||_)&&(u=!0));T&&(h?(o=o.add(h),s=l?s.add(t):s.delete(t)):(o=o.delete(t),s=s.delete(t)))})),this.query.mn()||this.query.vn())for(;o.size>this.query.limit;){var c=this.query.mn()?o.last():o.first();o=o.delete(c.key),s=s.delete(c.key),r.track({type:__PRIVATE_ChangeType.xn,doc:c})}return assert(!u||!e,"View was refilled using docs that themselves needed refilling."),{ld:o,Ed:r,Ih:u,Hn:s}},t.prototype.Pd=function(t,e){return t.ce&&e.hasCommittedMutations&&!e.ce},t.prototype.Qo=function(t,e,n){var r=this;assert(!t.Ih,"Cannot apply changes that need a refill");var i=this.ld;this.ld=t.ld,this.Hn=t.Hn;var s=t.Ed.$n();s.sort((function(t,e){return __PRIVATE_compareChangeType(t.type,e.type)||r.query.Pn(t.doc,e.doc)})),this.Ad(n);var o=e?this.Rd():[],u=0===this.fd.size&&this.sr?__PRIVATE_SyncState.Qn:__PRIVATE_SyncState.jn,a=u!==this.hd;return this.hd=u,0!==s.length||a?{snapshot:new __PRIVATE_ViewSnapshot(this.query,t.ld,i,s,t.Hn,u===__PRIVATE_SyncState.jn,a,!1),Id:o}:{Id:o}},t.prototype.Vd=function(t){return this.sr&&t===__PRIVATE_OnlineState.T?(this.sr=!1,this.Qo({ld:this.ld,Ed:new __PRIVATE_DocumentChangeSet,Hn:this.Hn,Ih:!1},!1)):{Id:[]}},t.prototype.md=function(t){return!this._d.has(t)&&(!!this.ld.has(t)&&!this.ld.get(t).ce)},t.prototype.Ad=function(t){var e=this;t&&(t.or.forEach((function(t){return e._d=e._d.add(t)})),t.ur.forEach((function(t){return assert(e._d.has(t),"Modified document "+t+" not found in view.")})),t.ar.forEach((function(t){return e._d=e._d.delete(t)})),this.sr=t.sr)},t.prototype.Rd=function(){var t=this;if(!this.sr)return[];var e=this.fd;this.fd=__PRIVATE_documentKeySet(),this.ld.forEach((function(e){t.md(e.key)&&(t.fd=t.fd.add(e.key))}));var n=[];return e.forEach((function(e){t.fd.has(e)||n.push(new __PRIVATE_RemovedLimboDocument(e))})),this.fd.forEach((function(t){e.has(t)||n.push(new __PRIVATE_AddedLimboDocument(t))})),n},t.prototype.vd=function(t){this._d=t.i_,this.fd=__PRIVATE_documentKeySet();var e=this.dd(t.documents);return this.Qo(e,!0)},t.prototype.pd=function(){return __PRIVATE_ViewSnapshot.Jn(this.query,this.ld,this.Hn,this.hd===__PRIVATE_SyncState.jn)},t}();function __PRIVATE_compareChangeType(t,e){var n=function(t){switch(t){case __PRIVATE_ChangeType.kn:return 1;case __PRIVATE_ChangeType.Kn:case __PRIVATE_ChangeType.qn:return 2;case __PRIVATE_ChangeType.xn:return 0;default:return fail("Unknown ChangeType: "+t)}};return n(t)-n(e)}var __PRIVATE_RETRY_COUNT=5,__PRIVATE_TransactionRunner=function(){function t(t,e,n,r){this.Cs=t,this.bd=e,this.updateFunction=n,this.Ms=r,this.gd=__PRIVATE_RETRY_COUNT,this.af=new __PRIVATE_ExponentialBackoff(this.Cs,__PRIVATE_TimerId.Ds)}return t.prototype.run=function(){this.wd()},t.prototype.wd=function(){var t=this;this.af.Xh((function(){return tslib.__awaiter(t,void 0,void 0,(function(){var t,e,n=this;return tslib.__generator(this,(function(r){return t=this.bd.TT(),(e=this.yd(t))&&e.then((function(e){n.Cs.ks((function(){return t.commit().then((function(){n.Ms.resolve(e)})).catch((function(t){n.Sd(t)}))}))})).catch((function(t){n.Sd(t)})),[2]}))}))}))},t.prototype.yd=function(t){try{var e=this.updateFunction(t);return!isNullOrUndefined(e)&&e.catch&&e.then?e:(this.Ms.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.Ms.reject(t),null}},t.prototype.Sd=function(t){var e=this;this.gd>0&&this.Dd(t)?(this.gd-=1,this.Cs.ks((function(){return e.wd(),Promise.resolve()}))):this.Ms.reject(t)},t.prototype.Dd=function(t){if("FirebaseError"===t.name){var e=t.code;return"aborted"===e||"failed-precondition"===e||!__PRIVATE_isPermanentError(e)}return!1},t}(),__PRIVATE_LOG_TAG$a="SyncEngine",__PRIVATE_QueryView=function(t,e,n){this.query=t,this.targetId=e,this.view=n},__PRIVATE_LimboResolution=function(t){this.key=t,this.Cd=!1},__PRIVATE_SyncEngine=function(){function t(t,e,n,r){this.N_=t,this.bd=e,this.Od=n,this.currentUser=r,this.Fd=null,this.Nd=new __PRIVATE_ObjectMap((function(t){return t.canonicalId()})),this.Md={},this.Ld=new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H),this.Gd={},this.Bd=new __PRIVATE_ReferenceSet,this.Ud={},this.kd=new Map,this.xd=__PRIVATE_TargetIdGenerator.Hu(),this.isPrimary=void 0,this.onlineState=__PRIVATE_OnlineState.h}return Object.defineProperty(t.prototype,"Kd",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),t.prototype.subscribe=function(t){assert(null!==t,"SyncEngine listener cannot be null"),assert(null===this.Fd,"SyncEngine already has a subscriber."),this.Fd=t},t.prototype.listen=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n,r,i,s;return tslib.__generator(this,(function(o){switch(o.label){case 0:return this.qd("listen()"),(r=this.Nd.get(t))?(e=r.targetId,this.Od.xT(e),n=r.view.pd(),[3,4]):[3,1];case 1:return[4,this.N_.Xa(t.En())];case 2:return i=o.sent(),s=this.Od.xT(i.targetId),e=i.targetId,[4,this.jd(t,e,"current"===s)];case 3:n=o.sent(),this.isPrimary&&this.bd.listen(i),o.label=4;case 4:return this.Fd.bf([n]),[2,e]}}))}))},t.prototype.jd=function(t,e,n){return tslib.__awaiter(this,void 0,void 0,(function(){var r,i,s,o,u,a;return tslib.__generator(this,(function(_){switch(_.label){case 0:return[4,this.N_.n_(t,!0)];case 1:return r=_.sent(),i=new __PRIVATE_View(t,r.i_),s=i.dd(r.documents),o=TargetChange.ir(e,n&&this.onlineState!==__PRIVATE_OnlineState.T),assert(0===(u=i.Qo(s,!0===this.isPrimary,o)).Id.length,"View returned limbo docs before target ack from the server."),assert(!!u.snapshot,"applyChanges for new view should always return a snapshot"),a=new __PRIVATE_QueryView(t,e,i),this.Nd.set(t,a),this.Md[e]||(this.Md[e]=[]),this.Md[e].push(t),[2,u.snapshot]}}))}))},t.prototype.Qd=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n;return tslib.__generator(this,(function(r){switch(r.label){case 0:return[4,this.N_.n_(t.query,!0)];case 1:return e=r.sent(),n=t.view.vd(e),this.isPrimary&&this.Wd(t.targetId,n.Id),[2,n]}}))}))},t.prototype.Zl=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n,r=this;return tslib.__generator(this,(function(i){switch(i.label){case 0:return this.qd("unlisten()"),assert(!!(e=this.Nd.get(t)),"Trying to unlisten on query not found:"+t),(n=this.Md[e.targetId]).length>1?(this.Md[e.targetId]=n.filter((function(e){return!e.isEqual(t)})),this.Nd.delete(t),[2]):this.isPrimary?(this.Od.qT(e.targetId),this.Od.LT(e.targetId)?[3,2]:[4,this.N_.e_(e.targetId,!1).then((function(){r.Od.QT(e.targetId),r.bd.Zl(e.targetId),r.$d(e.targetId)})).catch(__PRIVATE_ignoreIfPrimaryLeaseLoss)]):[3,3];case 1:i.sent(),i.label=2;case 2:return[3,5];case 3:return this.$d(e.targetId),[4,this.N_.e_(e.targetId,!0)];case 4:i.sent(),i.label=5;case 5:return[2]}}))}))},t.prototype.write=function(t,e){return tslib.__awaiter(this,void 0,void 0,(function(){var n;return tslib.__generator(this,(function(r){switch(r.label){case 0:return this.qd("write()"),[4,this.N_.Oa(t)];case 1:return n=r.sent(),this.Od.GT(n.batchId),this.Yd(n.batchId,e),[4,this.Hd(n.Lo)];case 2:return r.sent(),[4,this.bd.Hl()];case 3:return r.sent(),[2]}}))}))},t.prototype.runTransaction=function(t,e,n){new __PRIVATE_TransactionRunner(t,this.bd,e,n).run()},t.prototype.Ua=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n=this;return tslib.__generator(this,(function(r){switch(r.label){case 0:this.qd("applyRemoteEvent()"),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.N_.Ua(t)];case 2:return e=r.sent(),forEach(t.Zn,(function(t,e){var r=n.Gd[Number(t)];r&&(assert(e.or.size+e.ur.size+e.ar.size<=1,"Limbo resolution for single document contains multiple changes."),e.or.size>0?r.Cd=!0:e.ur.size>0?assert(r.Cd,"Received change for limbo target document without add."):e.ar.size>0&&(assert(r.Cd,"Received remove for limbo target document without add."),r.Cd=!1))})),[4,this.Hd(e,t)];case 3:return r.sent(),[3,6];case 4:return[4,__PRIVATE_ignoreIfPrimaryLeaseLoss(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},t.prototype.Vd=function(t,e){if(this.isPrimary&&e===__PRIVATE_OnlineStateSource.P||!this.isPrimary&&e===__PRIVATE_OnlineStateSource.A){this.qd("applyOnlineStateChange()");var n=[];this.Nd.forEach((function(e,r){var i=r.view.Vd(t);assert(0===i.Id.length,"OnlineState should not affect limbo documents."),i.snapshot&&n.push(i.snapshot)})),this.Fd.zd(t),this.Fd.bf(n),this.onlineState=t,this.isPrimary&&this.Od.YT(t)}},t.prototype.iT=function(t,e){return tslib.__awaiter(this,void 0,void 0,(function(){var n,r,i,s,o,u=this;return tslib.__generator(this,(function(a){switch(a.label){case 0:return this.qd("rejectListens()"),this.Od.WT(t,"rejected",e),n=this.Gd[t],(r=n&&n.key)?(this.Ld=this.Ld.remove(r),delete this.Gd[t],i=(i=new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H)).Pt(r,new __PRIVATE_NoDocument(r,__PRIVATE_SnapshotVersion.W())),s=__PRIVATE_documentKeySet().add(r),o=new __PRIVATE_RemoteEvent(__PRIVATE_SnapshotVersion.MIN,{},new __PRIVATE_SortedSet(__PRIVATE_primitiveComparator),i,s),[2,this.Ua(o)]):[3,1];case 1:return[4,this.N_.e_(t,!1).then((function(){return u.$d(t,e)})).catch(__PRIVATE_ignoreIfPrimaryLeaseLoss)];case 2:a.sent(),a.label=3;case 3:return[2]}}))}))},t.prototype.rd=function(t,e,n){return tslib.__awaiter(this,void 0,void 0,(function(){var r;return tslib.__generator(this,(function(i){switch(i.label){case 0:return this.qd("applyBatchState()"),[4,this.N_.Fa(t)];case 1:return null===(r=i.sent())?(debug(__PRIVATE_LOG_TAG$a,"Cannot apply mutation batch with id: "+t),[2]):"pending"!==e?[3,3]:[4,this.bd.Hl()];case 2:return i.sent(),[3,4];case 3:"acknowledged"===e||"rejected"===e?(this.Xd(t,n||null),this.N_.u_(t)):fail("Unknown batchState: "+e),i.label=4;case 4:return[4,this.Hd(r)];case 5:return i.sent(),[2]}}))}))},t.prototype.cT=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n;return tslib.__generator(this,(function(r){switch(r.label){case 0:this.qd("applySuccessfulWrite()"),e=t.batch.batchId,this.Xd(e,null),this.Jd(e),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.N_.Vu(t)];case 2:return n=r.sent(),this.Od.UT(e,"acknowledged"),[4,this.Hd(n)];case 3:return r.sent(),[3,6];case 4:return[4,__PRIVATE_ignoreIfPrimaryLeaseLoss(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},t.prototype.lT=function(t,e){return tslib.__awaiter(this,void 0,void 0,(function(){var n;return tslib.__generator(this,(function(r){switch(r.label){case 0:this.qd("rejectFailedWrite()"),this.Xd(t,e),this.Jd(t),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.N_.Ga(t)];case 2:return n=r.sent(),this.Od.UT(t,"rejected",e),[4,this.Hd(n)];case 3:return r.sent(),[3,6];case 4:return[4,__PRIVATE_ignoreIfPrimaryLeaseLoss(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},t.prototype.Zd=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n;return tslib.__generator(this,(function(r){switch(r.label){case 0:return this.bd.Ll()||debug(__PRIVATE_LOG_TAG$a,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),[4,this.N_.Ou()];case 1:return(e=r.sent())===__PRIVATE_BATCHID_UNKNOWN?(t.resolve(),[2]):((n=this.kd.get(e)||[]).push(t),this.kd.set(e,n),[2])}}))}))},t.prototype.Jd=function(t){(this.kd.get(t)||[]).forEach((function(t){t.resolve()})),this.kd.delete(t)},t.prototype.tE=function(t){this.kd.forEach((function(e){e.forEach((function(e){e.reject(new FirestoreError(Code.CANCELLED,t))}))})),this.kd.clear()},t.prototype.Yd=function(t,e){var n=this.Ud[this.currentUser.I()];n||(n=new __PRIVATE_SortedMap(__PRIVATE_primitiveComparator)),n=n.Pt(t,e),this.Ud[this.currentUser.I()]=n},t.prototype.Xd=function(t,e){var n=this.Ud[this.currentUser.I()];if(n){var r=n.get(t);r&&(assert(t===n.Rt(),"Mutation callbacks processed out-of-order?"),e?r.reject(e):r.resolve(),n=n.remove(t)),this.Ud[this.currentUser.I()]=n}},t.prototype.$d=function(t,e){var n=this;void 0===e&&(e=null),this.Od.qT(t),assert(this.Md[t]&&0!==this.Md[t].length,"There are no queries mapped to target id "+t);for(var r=0,i=this.Md[t];r<i.length;r++){var s=i[r];this.Nd.delete(s),e&&this.Fd.eE(s,e)}if(delete this.Md[t],this.isPrimary){var o=this.Bd.Io(t);this.Bd.Ao(t),o.forEach((function(t){n.Bd.Vo(t)||n.nE(t)}))}},t.prototype.nE=function(t){var e=this.Ld.get(t);null!==e&&(this.bd.Zl(e),this.Ld=this.Ld.remove(t),delete this.Gd[e])},t.prototype.Wd=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];if(i instanceof __PRIVATE_AddedLimboDocument)this.Bd.lo(i.key,t),this.rE(i);else if(i instanceof __PRIVATE_RemovedLimboDocument){debug(__PRIVATE_LOG_TAG$a,"Document no longer in limbo: "+i.key),this.Bd.do(i.key,t),this.Bd.Vo(i.key)||this.nE(i.key)}else fail("Unknown limbo change: "+JSON.stringify(i))}},t.prototype.rE=function(t){var e=t.key;if(!this.Ld.get(e)){debug(__PRIVATE_LOG_TAG$a,"New document in limbo: "+e);var n=this.xd.next(),r=Query.rn(e.path);this.Gd[n]=new __PRIVATE_LimboResolution(e),this.bd.listen(new __PRIVATE_TargetData(r.En(),n,__PRIVATE_TargetPurpose.Cn,__PRIVATE_ListenSequence.Vs)),this.Ld=this.Ld.Pt(e,n)}},t.prototype.iE=function(){return this.Ld},t.prototype.Hd=function(t,e){return tslib.__awaiter(this,void 0,void 0,(function(){var n,r,i,s=this;return tslib.__generator(this,(function(o){switch(o.label){case 0:return n=[],r=[],i=[],this.Nd.forEach((function(o,u){i.push(Promise.resolve().then((function(){var e=u.view.dd(t);return e.Ih?s.N_.n_(u.query,!1).then((function(t){var n=t.documents;return u.view.dd(n,e)})):e})).then((function(t){var i=e&&e.Zn[u.targetId],o=u.view.Qo(t,!0===s.isPrimary,i);if(s.Wd(u.targetId,o.Id),o.snapshot){s.isPrimary&&s.Od.WT(u.targetId,o.snapshot.fromCache?"not-current":"current"),n.push(o.snapshot);var a=__PRIVATE_LocalViewChanges.ha(u.targetId,o.snapshot);r.push(a)}})))})),[4,Promise.all(i)];case 1:return o.sent(),this.Fd.bf(n),[4,this.N_.Ya(r)];case 2:return o.sent(),[2]}}))}))},t.prototype.qd=function(t){assert(null!==this.Fd,"Trying to call "+t+" before calling subscribe().")},t.prototype.dT=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n;return tslib.__generator(this,(function(r){switch(r.label){case 0:return e=!this.currentUser.isEqual(t),this.currentUser=t,e?(this.tE("'waitForPendingWrites' promise is rejected due to a user change."),[4,this.N_.ya(t)]):[3,3];case 1:return n=r.sent(),this.Od.ya(t,n.Da,n.Ca),[4,this.Hd(n.Sa)];case 2:r.sent(),r.label=3;case 3:return[4,this.bd.dT()];case 4:return r.sent(),[2]}}))}))},t.prototype.ET=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n,r,i,s,o,u=this;return tslib.__generator(this,(function(a){switch(a.label){case 0:return!0!==t||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.bd.ET(!0)]);case 1:return a.sent(),s=this.Od.MT(),[4,this.sE(s.st())];case 2:for(e=a.sent(),n=0,r=e;n<r.length;n++)i=r[n],this.bd.listen(i);return[3,7];case 3:return!1!==t||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,s=[],o=Promise.resolve(),__PRIVATE_forEachNumber(this.Md,(function(t,e){u.Od.jT(t)?s.push(t):o=o.then((function(){return u.$d(t),u.N_.e_(t,!0)})),u.bd.Zl(t)})),[4,o]);case 4:return a.sent(),[4,this.sE(s)];case 5:return a.sent(),this.oE(),[4,this.bd.ET(!1)];case 6:a.sent(),a.label=7;case 7:return[2]}}))}))},t.prototype.oE=function(){var t=this;__PRIVATE_forEachNumber(this.Gd,(function(e){t.bd.Zl(e)})),this.Bd.Ro(),this.Gd=[],this.Ld=new __PRIVATE_SortedMap(__PRIVATE_DocumentKey.H)},t.prototype.sE=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n,r,i,s,o,u,a,_,c,h,f,l;return tslib.__generator(this,(function(T){switch(T.label){case 0:e=[],n=[],r=0,i=t,T.label=1;case 1:return r<i.length?(s=i[r],o=void 0,(u=this.Md[s])&&0!==u.length?[4,this.N_.e_(s,!0)]:[3,8]):[3,14];case 2:return T.sent(),[4,this.N_.Xa(u[0].En())];case 3:o=T.sent(),a=0,_=u,T.label=4;case 4:return a<_.length?(c=_[a],assert(!!(h=this.Nd.get(c)),"No query view found for "+c),[4,this.Qd(h)]):[3,7];case 5:(f=T.sent()).snapshot&&n.push(f.snapshot),T.label=6;case 6:return a++,[3,4];case 7:return[3,12];case 8:return assert(!0===this.isPrimary,"A secondary tab should never have an active target without an active query."),[4,this.N_.h_(s)];case 9:return assert(!!(l=T.sent()),"Target for id "+s+" not found"),[4,this.N_.Xa(l)];case 10:return o=T.sent(),[4,this.jd(this.uE(l),s,!1)];case 11:T.sent(),T.label=12;case 12:e.push(o),T.label=13;case 13:return r++,[3,1];case 14:return this.Fd.bf(n),[2,e]}}))}))},t.prototype.uE=function(t){return new Query(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,__PRIVATE_LimitType.ze,t.startAt,t.endAt)},t.prototype.o_=function(){return this.N_.o_()},t.prototype.sd=function(t,e,n){return tslib.__awaiter(this,void 0,void 0,(function(){var r,i;return tslib.__generator(this,(function(s){switch(s.label){case 0:if(this.isPrimary)return debug(__PRIVATE_LOG_TAG$a,"Ignoring unexpected query state notification."),[2];if(!this.Md[t])return[3,7];switch(e){case"current":case"not-current":return[3,1];case"rejected":return[3,4]}return[3,6];case 1:return[4,this.N_.f_()];case 2:return r=s.sent(),i=__PRIVATE_RemoteEvent.rr(t,"current"===e),[4,this.Hd(r,i)];case 3:return s.sent(),[3,7];case 4:return[4,this.N_.e_(t,!0)];case 5:return s.sent(),this.$d(t,n),[3,7];case 6:fail("Unexpected target state: "+e),s.label=7;case 7:return[2]}}))}))},t.prototype.od=function(t,e){return tslib.__awaiter(this,void 0,void 0,(function(){var n,r,i,s,o,u,a,_,c,h=this;return tslib.__generator(this,(function(f){switch(f.label){case 0:if(!this.isPrimary)return[2];n=0,r=t,f.label=1;case 1:return n<r.length?(c=r[n],assert(!this.Md[c],"Trying to add an already active target"),[4,this.N_.h_(c)]):[3,6];case 2:return assert(!!(i=f.sent()),"Query data for active target "+c+" not found"),[4,this.N_.Xa(i)];case 3:return s=f.sent(),[4,this.jd(this.uE(i),s.targetId,!1)];case 4:f.sent(),this.bd.listen(s),f.label=5;case 5:return n++,[3,1];case 6:o=function(t){return tslib.__generator(this,(function(e){switch(e.label){case 0:return u.Md[t]?[4,u.N_.e_(t,!1).then((function(){h.bd.Zl(t),h.$d(t)})).catch(__PRIVATE_ignoreIfPrimaryLeaseLoss)]:[2,"continue"];case 1:return e.sent(),[2]}}))},u=this,a=0,_=e,f.label=7;case 7:return a<_.length?(c=_[a],[5,o(c)]):[3,10];case 8:f.sent(),f.label=9;case 9:return a++,[3,7];case 10:return[2]}}))}))},t.prototype.enableNetwork=function(){return this.N_.a_(!0),this.bd.enableNetwork()},t.prototype.disableNetwork=function(){return this.N_.a_(!1),this.bd.disableNetwork()},t.prototype.zr=function(t){var e=this.Gd[t];if(e&&e.Cd)return __PRIVATE_documentKeySet().add(e.key);var n=__PRIVATE_documentKeySet(),r=this.Md[t];if(!r)return n;for(var i=0,s=r;i<s.length;i++){var o=s[i],u=this.Nd.get(o);assert(!!u,"No query view found for "+o),n=n.$t(u.view.Td)}return n},t}(),__PRIVATE_QueryListenersInfo=function(){this.aE=null,this.targetId=0,this.listeners=[]},__PRIVATE_EventManager=function(){function t(t){this.eT=t,this._E=new __PRIVATE_ObjectMap((function(t){return t.canonicalId()})),this.onlineState=__PRIVATE_OnlineState.h,this.cE=new Set,this.eT.subscribe(this)}return t.prototype.listen=function(t){var e=t.query,n=!1,r=this._E.get(e);(r||(n=!0,r=new __PRIVATE_QueryListenersInfo,this._E.set(e,r)),r.listeners.push(t),assert(!t.Vd(this.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),r.aE)&&(t.hE(r.aE)&&this.fE());return n?this.eT.listen(e).then((function(t){return r.targetId=t,t})):Promise.resolve(r.targetId)},t.prototype.Zl=function(t){return tslib.__awaiter(this,void 0,void 0,(function(){var e,n,r,i;return tslib.__generator(this,(function(s){return e=t.query,n=!1,(r=this._E.get(e))&&(i=r.listeners.indexOf(t))>=0&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this._E.delete(e),[2,this.eT.Zl(e)]):[2]}))}))},t.prototype.bf=function(t){for(var e=!1,n=0,r=t;n<r.length;n++){var i=r[n],s=i.query,o=this._E.get(s);if(o){for(var u=0,a=o.listeners;u<a.length;u++){a[u].hE(i)&&(e=!0)}o.aE=i}}e&&this.fE()},t.prototype.eE=function(t,e){var n=this._E.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++){i[r].onError(e)}this._E.delete(t)},t.prototype.zd=function(t){this.onlineState=t;var e=!1;this._E.forEach((function(n,r){for(var i=0,s=r.listeners;i<s.length;i++){s[i].Vd(t)&&(e=!0)}})),e&&this.fE()},t.prototype.lE=function(t){this.cE.add(t),t.next()},t.prototype.TE=function(t){this.cE.delete(t)},t.prototype.fE=function(){this.cE.forEach((function(t){t.next()}))},t}(),__PRIVATE_QueryListener=function(){function t(t,e,n){this.query=t,this.dE=e,this.EE=!1,this.PE=null,this.onlineState=__PRIVATE_OnlineState.h,this.options=n||{}}return t.prototype.hE=function(t){if(assert(t.docChanges.length>0||t.zn,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==__PRIVATE_ChangeType.qn&&e.push(i)}t=new __PRIVATE_ViewSnapshot(t.query,t.docs,t.Yn,e,t.Hn,t.fromCache,t.zn,!0)}var s=!1;return this.EE?this.AE(t)&&(this.dE.next(t),s=!0):this.RE(t,this.onlineState)&&(this.IE(t),s=!0),this.PE=t,s},t.prototype.onError=function(t){this.dE.error(t)},t.prototype.Vd=function(t){this.onlineState=t;var e=!1;return this.PE&&!this.EE&&this.RE(this.PE,t)&&(this.IE(this.PE),e=!0),e},t.prototype.RE=function(t,e){if(assert(!this.EE,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;var n=e!==__PRIVATE_OnlineState.T;return this.options.VE&&n?(assert(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.tt()||e===__PRIVATE_OnlineState.T},t.prototype.AE=function(t){if(t.docChanges.length>0)return!0;var e=this.PE&&this.PE.hasPendingWrites!==t.hasPendingWrites;return!(!t.zn&&!e)&&!0===this.options.includeMetadataChanges},t.prototype.IE=function(t){assert(!this.EE,"Trying to raise initial events for second time"),t=__PRIVATE_ViewSnapshot.Jn(t.query,t.docs,t.Hn,t.fromCache),this.EE=!0,this.dE.next(t)},t}(),__PRIVATE_LOG_TAG$b="FirestoreClient",__PRIVATE_DOM_EXCEPTION_INVALID_STATE=11,__PRIVATE_DOM_EXCEPTION_ABORTED=20,__PRIVATE_DOM_EXCEPTION_QUOTA_EXCEEDED=22,__PRIVATE_IndexedDbPersistenceSettings=function(){function t(t,e){this.cacheSizeBytes=t,this.synchronizeTabs=e}return t.prototype.kc=function(){return __PRIVATE_LruParams.g_(this.cacheSizeBytes)},t}(),__PRIVATE_MemoryPersistenceSettings=function(){},__PRIVATE_FirestoreClient=function(){function t(t,e,n,r){this.platform=t,this.mE=e,this.credentials=n,this.Cs=r,this.clientId=__PRIVATE_AutoId.s()}return t.prototype.start=function(t){var e=this;this.vE();var n=new __PRIVATE_Deferred,r=new __PRIVATE_Deferred,i=!1;return this.credentials.S((function(s){i?e.Cs.ks((function(){return e.dT(s)})):(i=!0,e.pE(t,r,s).then((function(t){return e.bE(s,t)})).then(n.resolve,n.reject))})),this.Cs.ks((function(){return n.promise})),r.promise},t.prototype.enableNetwork=function(){var t=this;return this.vE(),this.Cs.enqueue((function(){return t.eT.enableNetwork()}))},t.prototype.pE=function(t,e,n){var r=this;return t instanceof __PRIVATE_IndexedDbPersistenceSettings?this.gE(n,t).then((function(t){return e.resolve(),t})).catch((function(t){if(e.reject(t),!r.wE(t))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.yE()})):(e.resolve(),this.yE())},t.prototype.wE=function(t){return t instanceof FirestoreError?t.code===Code.FAILED_PRECONDITION||t.code===Code.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(t.code===__PRIVATE_DOM_EXCEPTION_QUOTA_EXCEEDED||t.code===__PRIVATE_DOM_EXCEPTION_ABORTED||t.code===__PRIVATE_DOM_EXCEPTION_INVALID_STATE)},t.prototype.vE=function(){if(this.Cs.$s)throw new FirestoreError(Code.FAILED_PRECONDITION,"The client has already been terminated.")},t.prototype.gE=function(t,e){var n=this,r=__PRIVATE_IndexedDbPersistence.fh(this.mE),i=new __PRIVATE_JsonProtoSerializer(this.mE.o,{Zr:!0});return Promise.resolve().then((function(){return tslib.__awaiter(n,void 0,void 0,(function(){var n,s;return tslib.__generator(this,(function(o){switch(o.label){case 0:if(e.synchronizeTabs&&!__PRIVATE_WebStorageSharedClientState.Xo(this.platform))throw new FirestoreError(Code.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return n=e.kc(),this.Od=e.synchronizeTabs?new __PRIVATE_WebStorageSharedClientState(this.Cs,this.platform,r,this.clientId,t):new __PRIVATE_MemorySharedClientState,[4,__PRIVATE_IndexedDbPersistence.Uc({allowTabSynchronization:e.synchronizeTabs,persistenceKey:r,clientId:this.clientId,platform:this.platform,yc:this.Cs,serializer:i,kc:n,Sc:this.Od})];case 1:return s=o.sent(),this.persistence=s,[2,s.Pu.F_]}}))}))}))},t.prototype.yE=function(){return this.persistence=__PRIVATE_MemoryPersistence.Mh(this.clientId),this.Od=new __PRIVATE_MemorySharedClientState,Promise.resolve(null)},t.prototype.bE=function(t,e){var n=this;return debug(__PRIVATE_LOG_TAG$b,"Initializing. user=",t.uid),this.platform.SE(this.mE).then((function(r){return tslib.__awaiter(n,void 0,void 0,(function(){var n,i,s,o,u,a,_=this;return tslib.__generator(this,(function(c){switch(c.label){case 0:return n=new __PRIVATE_IndexFreeQueryEngine,this.N_=new __PRIVATE_LocalStore(this.persistence,n,t),[4,this.N_.start()];case 1:return c.sent(),e&&(this.DE=new __PRIVATE_LruScheduler(e,this.Cs,this.N_)),i=this.platform.CE(),s=this.platform.OE(this.mE.o),o=new __PRIVATE_Datastore(this.Cs,r,this.credentials,s),u=function(t){return _.eT.Vd(t,__PRIVATE_OnlineStateSource.P)},a=function(t){return _.eT.Vd(t,__PRIVATE_OnlineStateSource.A)},this.bd=new __PRIVATE_RemoteStore(this.N_,o,this.Cs,u,i),this.eT=new __PRIVATE_SyncEngine(this.N_,this.bd,this.Od,t),this.Od.ml=a,this.bd.eT=this.eT,this.Od.eT=this.eT,this.FE=new __PRIVATE_EventManager(this.eT),[4,this.Od.start()];case 2:return c.sent(),[4,this.bd.start()];case 3:return c.sent(),[4,this.persistence.$c((function(t){return tslib.__awaiter(_,void 0,void 0,(function(){return tslib.__generator(this,(function(e){switch(e.label){case 0:return[4,this.eT.ET(t)];case 1:return e.sent(),this.DE&&(t&&!this.DE.Pa?this.DE.start():t||this.DE.stop()),[2]}}))}))}))];case 4:return c.sent(),[4,this.persistence.Yc((function(){return tslib.__awaiter(_,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return[4,this.terminate()];case 1:return t.sent(),[2]}}))}))}))];case 5:return c.sent(),[2]}}))}))}))},t.prototype.dT=function(t){return this.Cs.eo(),debug(__PRIVATE_LOG_TAG$b,"Credential Changed. Current user: "+t.uid),this.eT.dT(t)},t.prototype.disableNetwork=function(){var t=this;return this.vE(),this.Cs.enqueue((function(){return t.eT.disableNetwork()}))},t.prototype.terminate=function(){var t=this;return this.Cs.Js((function(){return tslib.__awaiter(t,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return this.DE&&this.DE.stop(),[4,this.bd.shutdown()];case 1:return t.sent(),[4,this.Od.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.D(),[2]}}))}))}))},t.prototype.waitForPendingWrites=function(){var t=this;this.vE();var e=new __PRIVATE_Deferred;return this.Cs.ks((function(){return t.eT.Zd(e)})),e.promise},t.prototype.listen=function(t,e,n){var r=this;this.vE();var i=new __PRIVATE_QueryListener(t,e,n);return this.Cs.ks((function(){return r.FE.listen(i)})),i},t.prototype.Zl=function(t){var e=this;this.NE||this.Cs.ks((function(){return e.FE.Zl(t)}))},t.prototype.ME=function(t){var e=this;return this.vE(),this.Cs.enqueue((function(){return e.N_.za(t)})).then((function(t){if(t instanceof Document)return t;if(t instanceof __PRIVATE_NoDocument)return null;throw new FirestoreError(Code.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")}))},t.prototype.LE=function(t){var e=this;return this.vE(),this.Cs.enqueue((function(){return tslib.__awaiter(e,void 0,void 0,(function(){var e,n,r;return tslib.__generator(this,(function(i){switch(i.label){case 0:return[4,this.N_.n_(t,!0)];case 1:return e=i.sent(),n=new __PRIVATE_View(t,e.i_),r=n.dd(e.documents),[2,n.Qo(r,!1).snapshot]}}))}))}))},t.prototype.write=function(t){var e=this;this.vE();var n=new __PRIVATE_Deferred;return this.Cs.ks((function(){return e.eT.write(t,n)})),n.promise},t.prototype.o=function(){return this.mE.o},t.prototype.lE=function(t){var e=this;this.vE(),this.Cs.ks((function(){return e.FE.lE(t),Promise.resolve()}))},t.prototype.TE=function(t){this.NE||this.FE.TE(t)},Object.defineProperty(t.prototype,"NE",{get:function(){return this.Cs.$s},enumerable:!0,configurable:!0}),t.prototype.transaction=function(t){var e=this;this.vE();var n=new __PRIVATE_Deferred;return this.Cs.ks((function(){return e.eT.runTransaction(e.Cs,t,n),Promise.resolve()})),n.promise},t}(),__PRIVATE_AsyncObserver=function(){function t(t){this.observer=t,this.muted=!1}return t.prototype.next=function(t){this.GE(this.observer.next,t)},t.prototype.error=function(t){this.GE(this.observer.error,t)},t.prototype.BE=function(){this.muted=!0},t.prototype.GE=function(t,e){var n=this;this.muted||setTimeout((function(){n.muted||t(e)}),0)},t}();function __PRIVATE_isPartialObserver(t){return __PRIVATE_implementsAnyMethods(t,["next","error","complete"])}function __PRIVATE_implementsAnyMethods(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=e;r<i.length;r++){var s=i[r];if(s in n&&"function"==typeof n[s])return!0}return!1}var __PRIVATE_DEFAULT_HOST="firestore.googleapis.com",__PRIVATE_DEFAULT_SSL=!0,__PRIVATE_DEFAULT_TIMESTAMPS_IN_SNAPSHOTS=!0,__PRIVATE_DEFAULT_FORCE_LONG_POLLING=!1,CACHE_SIZE_UNLIMITED=__PRIVATE_LruParams.S_,__PRIVATE_DEFAULT_SYNCHRONIZE_TABS=!1,__PRIVATE_FirestoreSettings=function(){function t(t){if(void 0===t.host){if(void 0!==t.ssl)throw new FirestoreError(Code.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=__PRIVATE_DEFAULT_HOST,this.ssl=__PRIVATE_DEFAULT_SSL}else __PRIVATE_validateNamedType("settings","non-empty string","host",t.host),this.host=t.host,__PRIVATE_validateNamedOptionalType("settings","boolean","ssl",t.ssl),this.ssl=__PRIVATE_defaulted(t.ssl,__PRIVATE_DEFAULT_SSL);if(__PRIVATE_validateOptionNames("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),__PRIVATE_validateNamedOptionalType("settings","object","credentials",t.credentials),this.credentials=t.credentials,__PRIVATE_validateNamedOptionalType("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?error("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&error("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=__PRIVATE_defaulted(t.timestampsInSnapshots,__PRIVATE_DEFAULT_TIMESTAMPS_IN_SNAPSHOTS),__PRIVATE_validateNamedOptionalType("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=__PRIVATE_LruParams.C_;else{if(t.cacheSizeBytes!==CACHE_SIZE_UNLIMITED&&t.cacheSizeBytes<__PRIVATE_LruParams.D_)throw new FirestoreError(Code.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+__PRIVATE_LruParams.D_);this.cacheSizeBytes=t.cacheSizeBytes}__PRIVATE_validateNamedOptionalType("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0===t.experimentalForceLongPolling?__PRIVATE_DEFAULT_FORCE_LONG_POLLING:t.experimentalForceLongPolling}return t.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},t}(),Firestore=function(){function t(e,n){var r=this;if(this.UE=null,this.kE=new __PRIVATE_AsyncQueue,this.INTERNAL={delete:function(){return tslib.__awaiter(r,void 0,void 0,(function(){return tslib.__generator(this,(function(t){switch(t.label){case 0:return this.xE(),[4,this.KE.terminate()];case 1:return t.sent(),[2]}}))}))}},"object"==typeof e.options){var i=e;this.UE=i,this.qE=t.jE(i),this.QE=i.name,this.WE=new __PRIVATE_FirebaseCredentialsProvider(n)}else{var s=e;if(!s.projectId)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide projectId");this.qE=new __PRIVATE_DatabaseId(s.projectId,s.database),this.QE="[DEFAULT]",this.WE=new __PRIVATE_EmptyCredentialsProvider}this.$E=new __PRIVATE_FirestoreSettings({}),this.YE=this.HE(this.qE)}return t.prototype.settings=function(t){if(__PRIVATE_validateExactNumberOfArgs("Firestore.settings",arguments,1),__PRIVATE_validateArgType("Firestore.settings","object",1,t),contains(t,"persistence"))throw new FirestoreError(Code.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var e=new __PRIVATE_FirestoreSettings(t);if(this.KE&&!this.$E.isEqual(e))throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this.$E=e,void 0!==e.credentials&&(this.WE=__PRIVATE_makeCredentialsProvider(e.credentials))},t.prototype.enableNetwork=function(){return this.xE(),this.KE.enableNetwork()},t.prototype.disableNetwork=function(){return this.xE(),this.KE.disableNetwork()},t.prototype.enablePersistence=function(t){if(this.KE)throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var e=!1;return t&&(void 0!==t.experimentalTabSynchronization&&error("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),e=__PRIVATE_defaulted(void 0!==t.synchronizeTabs?t.synchronizeTabs:t.experimentalTabSynchronization,__PRIVATE_DEFAULT_SYNCHRONIZE_TABS)),this.zE(new __PRIVATE_IndexedDbPersistenceSettings(this.$E.cacheSizeBytes,e))},t.prototype.clearPersistence=function(){var t=this,e=__PRIVATE_IndexedDbPersistence.fh(this.XE()),n=new __PRIVATE_Deferred;return this.kE.Ys((function(){return tslib.__awaiter(t,void 0,void 0,(function(){var t;return tslib.__generator(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,2,,3]),void 0!==this.KE&&!this.KE.NE)throw new FirestoreError(Code.FAILED_PRECONDITION,"Persistence cannot be cleared after this Firestore instance is initialized.");return[4,__PRIVATE_IndexedDbPersistence.clearPersistence(e)];case 1:return r.sent(),n.resolve(),[3,3];case 2:return t=r.sent(),n.reject(t),[3,3];case 3:return[2]}}))}))})),n.promise},t.prototype.terminate=function(){return this.app._removeServiceInstance("firestore"),this.INTERNAL.delete()},Object.defineProperty(t.prototype,"JE",{get:function(){return this.xE(),this.KE.NE},enumerable:!0,configurable:!0}),t.prototype.waitForPendingWrites=function(){return this.xE(),this.KE.waitForPendingWrites()},t.prototype.onSnapshotsInSync=function(t){if(this.xE(),__PRIVATE_isPartialObserver(t))return this.ZE(t);__PRIVATE_validateArgType("Firestore.onSnapshotsInSync","function",1,t);var e={next:t};return this.ZE(e)},t.prototype.ZE=function(t){var e=this,n=new __PRIVATE_AsyncObserver({next:function(){t.next&&t.next()},error:function(t){throw fail("Uncaught Error in onSnapshotsInSync")}});return this.KE.lE(n),function(){n.BE(),e.KE.TE(n)}},t.prototype.xE=function(){return this.KE||this.zE(new __PRIVATE_MemoryPersistenceSettings),this.KE},t.prototype.XE=function(){return new __PRIVATE_DatabaseInfo(this.qE,this.QE,this.$E.host,this.$E.ssl,this.$E.forceLongPolling)},t.prototype.zE=function(t){assert(!!this.$E.host,"FirestoreSettings.host is not set"),assert(!this.KE,"configureClient() called multiple times");var e=this.XE();return this.KE=new __PRIVATE_FirestoreClient(__PRIVATE_PlatformSupport.t(),e,this.WE,this.kE),this.KE.start(t)},t.prototype.HE=function(t){return new __PRIVATE_UserDataConverter((function(e){if(e instanceof DocumentReference){var n=t,r=e.firestore.qE;if(!r.isEqual(n))throw new FirestoreError(Code.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new __PRIVATE_DocumentKeyReference(t,e.tP)}return e}))},t.jE=function(t){var e=t.options;if(!contains(e,"projectId"))throw new FirestoreError(Code.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=e.projectId;if(!n||"string"!=typeof n)throw new FirestoreError(Code.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new __PRIVATE_DatabaseId(n)},Object.defineProperty(t.prototype,"app",{get:function(){if(!this.UE)throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this.UE},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){return __PRIVATE_validateExactNumberOfArgs("Firestore.collection",arguments,1),__PRIVATE_validateArgType("Firestore.collection","non-empty string",1,t),this.xE(),new CollectionReference(ResourcePath.ut(t),this)},t.prototype.doc=function(t){return __PRIVATE_validateExactNumberOfArgs("Firestore.doc",arguments,1),__PRIVATE_validateArgType("Firestore.doc","non-empty string",1,t),this.xE(),DocumentReference.eP(ResourcePath.ut(t),this)},t.prototype.collectionGroup=function(t){if(__PRIVATE_validateExactNumberOfArgs("Firestore.collectionGroup",arguments,1),__PRIVATE_validateArgType("Firestore.collectionGroup","non-empty string",1,t),t.indexOf("/")>=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.xE(),new Query$1(new Query(ResourcePath.at,t),this)},t.prototype.runTransaction=function(t){var e=this;return __PRIVATE_validateExactNumberOfArgs("Firestore.runTransaction",arguments,1),__PRIVATE_validateArgType("Firestore.runTransaction","function",1,t),this.xE().transaction((function(n){return t(new Transaction$1(e,n))}))},t.prototype.batch=function(){return this.xE(),new WriteBatch(this)},Object.defineProperty(t,"logLevel",{get:function(){switch(__PRIVATE_getLogLevel()){case LogLevel.DEBUG:return"debug";case LogLevel.ERROR:return"error";case LogLevel.SILENT:return"silent";default:return fail("Unknown log level: "+__PRIVATE_getLogLevel())}},enumerable:!0,configurable:!0}),t.setLogLevel=function(t){switch(__PRIVATE_validateExactNumberOfArgs("Firestore.setLogLevel",arguments,1),__PRIVATE_validateArgType("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":setLogLevel(LogLevel.DEBUG);break;case"error":setLogLevel(LogLevel.ERROR);break;case"silent":setLogLevel(LogLevel.SILENT);break;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid log level: "+t)}},t.prototype.nP=function(){return this.$E.timestampsInSnapshots},t}(),Transaction$1=function(){function t(t,e){this.rP=t,this.iP=e}return t.prototype.get=function(t){var e=this;__PRIVATE_validateExactNumberOfArgs("Transaction.get",arguments,1);var n=__PRIVATE_validateReference("Transaction.get",t,this.rP);return this.iP.lookup([n.tP]).then((function(t){if(!t||1!==t.length)return fail("Mismatch in docs returned from document lookup.");var r=t[0];if(r instanceof __PRIVATE_NoDocument)return new DocumentSnapshot(e.rP,n.tP,null,!1,!1,n.sP);if(r instanceof Document)return new DocumentSnapshot(e.rP,n.tP,r,!1,!1,n.sP);throw fail("BatchGetDocumentsRequest returned unexpected document type: "+r.constructor.name)}))},t.prototype.set=function(t,e,n){__PRIVATE_validateBetweenNumberOfArgs("Transaction.set",arguments,2,3);var r=__PRIVATE_validateReference("Transaction.set",t,this.rP);n=__PRIVATE_validateSetOptions("Transaction.set",n);var i=__PRIVATE_applyFirestoreDataConverter(r.sP,e,"Transaction.set"),s=i[0],o=i[1],u=n.merge||n.mergeFields?this.rP.YE.il(o,s,n.mergeFields):this.rP.YE.nl(o,s);return this.iP.set(r.tP,u),this},t.prototype.update=function(t,e,n){for(var r,i,s=[],o=3;o<arguments.length;o++)s[o-3]=arguments[o];return"string"==typeof e||e instanceof FieldPath$1?(__PRIVATE_validateAtLeastNumberOfArgs("Transaction.update",arguments,3),r=__PRIVATE_validateReference("Transaction.update",t,this.rP),i=this.rP.YE.ul("Transaction.update",e,n,s)):(__PRIVATE_validateExactNumberOfArgs("Transaction.update",arguments,2),r=__PRIVATE_validateReference("Transaction.update",t,this.rP),i=this.rP.YE.sl("Transaction.update",e)),this.iP.update(r.tP,i),this},t.prototype.delete=function(t){__PRIVATE_validateExactNumberOfArgs("Transaction.delete",arguments,1);var e=__PRIVATE_validateReference("Transaction.delete",t,this.rP);return this.iP.delete(e.tP),this},t}(),WriteBatch=function(){function t(t){this.rP=t,this.oP=[],this.uP=!1}return t.prototype.set=function(t,e,n){__PRIVATE_validateBetweenNumberOfArgs("WriteBatch.set",arguments,2,3),this.aP();var r=__PRIVATE_validateReference("WriteBatch.set",t,this.rP);n=__PRIVATE_validateSetOptions("WriteBatch.set",n);var i=__PRIVATE_applyFirestoreDataConverter(r.sP,e,"WriteBatch.set"),s=i[0],o=i[1],u=n.merge||n.mergeFields?this.rP.YE.il(o,s,n.mergeFields):this.rP.YE.nl(o,s);return this.oP=this.oP.concat(u.Kf(r.tP,Precondition.NONE)),this},t.prototype.update=function(t,e,n){for(var r,i,s=[],o=3;o<arguments.length;o++)s[o-3]=arguments[o];return this.aP(),"string"==typeof e||e instanceof FieldPath$1?(__PRIVATE_validateAtLeastNumberOfArgs("WriteBatch.update",arguments,3),r=__PRIVATE_validateReference("WriteBatch.update",t,this.rP),i=this.rP.YE.ul("WriteBatch.update",e,n,s)):(__PRIVATE_validateExactNumberOfArgs("WriteBatch.update",arguments,2),r=__PRIVATE_validateReference("WriteBatch.update",t,this.rP),i=this.rP.YE.sl("WriteBatch.update",e)),this.oP=this.oP.concat(i.Kf(r.tP,Precondition.exists(!0))),this},t.prototype.delete=function(t){__PRIVATE_validateExactNumberOfArgs("WriteBatch.delete",arguments,1),this.aP();var e=__PRIVATE_validateReference("WriteBatch.delete",t,this.rP);return this.oP=this.oP.concat(new __PRIVATE_DeleteMutation(e.tP,Precondition.NONE)),this},t.prototype.commit=function(){return tslib.__awaiter(this,void 0,void 0,(function(){return tslib.__generator(this,(function(t){return this.aP(),this.uP=!0,this.oP.length>0?[2,this.rP.xE().write(this.oP)]:[2]}))}))},t.prototype.aP=function(){if(this.uP)throw new FirestoreError(Code.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},t}(),DocumentReference=function(){function t(t,e,n){this.tP=t,this.firestore=e,this.sP=n,this.KE=this.firestore.xE()}return t.eP=function(e,n,r){if(e.length%2!=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e.ot()+" has "+e.length);return new t(new __PRIVATE_DocumentKey(e),n,r)},Object.defineProperty(t.prototype,"id",{get:function(){return this.tP.path.nt()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new CollectionReference(this.tP.path.Z(),this.firestore,this.sP)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this.tP.path.ot()},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){if(__PRIVATE_validateExactNumberOfArgs("DocumentReference.collection",arguments,1),__PRIVATE_validateArgType("DocumentReference.collection","non-empty string",1,t),!t)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var e=ResourcePath.ut(t);return new CollectionReference(this.tP.path.child(e),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw __PRIVATE_invalidClassError("isEqual","DocumentReference",1,e);return this.firestore===e.firestore&&this.tP.isEqual(e.tP)&&this.sP===e.sP},t.prototype.set=function(t,e){__PRIVATE_validateBetweenNumberOfArgs("DocumentReference.set",arguments,1,2),e=__PRIVATE_validateSetOptions("DocumentReference.set",e);var n=__PRIVATE_applyFirestoreDataConverter(this.sP,t,"DocumentReference.set"),r=n[0],i=n[1],s=e.merge||e.mergeFields?this.firestore.YE.il(i,r,e.mergeFields):this.firestore.YE.nl(i,r);return this.KE.write(s.Kf(this.tP,Precondition.NONE))},t.prototype.update=function(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return"string"==typeof t||t instanceof FieldPath$1?(__PRIVATE_validateAtLeastNumberOfArgs("DocumentReference.update",arguments,2),n=this.firestore.YE.ul("DocumentReference.update",t,e,r)):(__PRIVATE_validateExactNumberOfArgs("DocumentReference.update",arguments,1),n=this.firestore.YE.sl("DocumentReference.update",t)),this.KE.write(n.Kf(this.tP,Precondition.exists(!0)))},t.prototype.delete=function(){return __PRIVATE_validateExactNumberOfArgs("DocumentReference.delete",arguments,0),this.KE.write([new __PRIVATE_DeleteMutation(this.tP,Precondition.NONE)])},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];__PRIVATE_validateBetweenNumberOfArgs("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||__PRIVATE_isPartialObserver(t[i])||(__PRIVATE_validateOptionNames("DocumentReference.onSnapshot",r=t[i],["includeMetadataChanges"]),__PRIVATE_validateNamedOptionalType("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var s={includeMetadataChanges:r.includeMetadataChanges};return __PRIVATE_isPartialObserver(t[i])?n=t[i]:(__PRIVATE_validateArgType("DocumentReference.onSnapshot","function",i,t[i]),__PRIVATE_validateOptionalArgType("DocumentReference.onSnapshot","function",i+1,t[i+1]),__PRIVATE_validateOptionalArgType("DocumentReference.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this._P(s,n)},t.prototype._P=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new __PRIVATE_AsyncObserver({next:function(t){if(e.next){assert(t.docs.size<=1,"Too many documents returned on a document query");var r=t.docs.get(n.tP);e.next(new DocumentSnapshot(n.firestore,n.tP,r,t.fromCache,t.hasPendingWrites,n.sP))}},error:r}),s=this.KE.listen(Query.rn(this.tP.path),i,t);return function(){i.BE(),n.KE.Zl(s)}},t.prototype.get=function(t){var e=this;return __PRIVATE_validateBetweenNumberOfArgs("DocumentReference.get",arguments,0,1),__PRIVATE_validateGetOptions("DocumentReference.get",t),new Promise((function(n,r){t&&"cache"===t.source?e.firestore.xE().ME(e.tP).then((function(t){n(new DocumentSnapshot(e.firestore,e.tP,t,!0,t instanceof Document&&t.ce,e.sP))}),r):e.cP(n,r,t)}))},t.prototype.cP=function(t,e,n){var r=this._P({includeMetadataChanges:!0,VE:!0},{next:function(i){r(),!i.exists&&i.metadata.fromCache?e(new FirestoreError(Code.UNAVAILABLE,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&n&&"server"===n.source?e(new FirestoreError(Code.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):t(i)},error:e})},t.prototype.withConverter=function(e){return new t(this.tP,this.firestore,e)},t}(),SnapshotMetadata=function(){function t(t,e){this.hasPendingWrites=t,this.fromCache=e}return t.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},t}(),DocumentSnapshot=function(){function t(t,e,n,r,i,s){this.rP=t,this.tP=e,this.hP=n,this.fP=r,this.lP=i,this.sP=s}return t.prototype.data=function(t){if(__PRIVATE_validateBetweenNumberOfArgs("DocumentSnapshot.data",arguments,0,1),t=__PRIVATE_validateSnapshotOptions("DocumentSnapshot.data",t),this.hP){if(this.sP){var e=new QueryDocumentSnapshot(this.rP,this.tP,this.hP,this.fP,this.lP);return this.sP.fromFirestore(e,t)}return this.TP(this.hP.data(),__PRIVATE_FieldValueOptions.Oe(t,this.rP.nP()))}},t.prototype.get=function(t,e){if(__PRIVATE_validateBetweenNumberOfArgs("DocumentSnapshot.get",arguments,1,2),e=__PRIVATE_validateSnapshotOptions("DocumentSnapshot.get",e),this.hP){var n=this.hP.data().field(__PRIVATE_fieldPathFromArgument("DocumentSnapshot.get",t));if(null!==n)return this.dP(n,__PRIVATE_FieldValueOptions.Oe(e,this.rP.nP()))}},Object.defineProperty(t.prototype,"id",{get:function(){return this.tP.path.nt()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ref",{get:function(){return new DocumentReference(this.tP,this.rP,this.sP)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"exists",{get:function(){return null!==this.hP},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"metadata",{get:function(){return new SnapshotMetadata(this.lP,this.fP)},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){if(!(e instanceof t))throw __PRIVATE_invalidClassError("isEqual","DocumentSnapshot",1,e);return this.rP===e.rP&&this.fP===e.fP&&this.tP.isEqual(e.tP)&&(null===this.hP?null===e.hP:this.hP.isEqual(e.hP))&&this.sP===e.sP},t.prototype.TP=function(t,e){var n=this,r={};return t.forEach((function(t,i){r[t]=n.dP(i,e)})),r},t.prototype.dP=function(t,e){if(t instanceof __PRIVATE_ObjectValue)return this.TP(t,e);if(t instanceof ArrayValue)return this.EP(t,e);if(t instanceof __PRIVATE_RefValue){var n=t.value(e),r=this.rP.xE().o();return t.o.isEqual(r)||error("Document "+this.tP.path+" contains a document reference within a different database ("+t.o.projectId+"/"+t.o.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new DocumentReference(n,this.rP,this.sP)}return t.value(e)},t.prototype.EP=function(t,e){var n=this;return t.Zt.map((function(t){return n.dP(t,e)}))},t}(),QueryDocumentSnapshot=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return tslib.__extends(e,t),e.prototype.data=function(e){var n=t.prototype.data.call(this,e);return assert(void 0!==n,"Document in a QueryDocumentSnapshot should exist"),n},e}(DocumentSnapshot),Query$1=function(){function t(t,e,n){this.PP=t,this.firestore=e,this.sP=n}return t.prototype.where=function(e,n,r){__PRIVATE_validateExactNumberOfArgs("Query.where",arguments,3),__PRIVATE_validateDefined("Query.where",3,r);var i,s=["<","<=","==",">=",">","array-contains","in","array-contains-any"];__PRIVATE_validateStringEnum("Query.where",s,2,n);var o=__PRIVATE_fieldPathFromArgument("Query.where",e),u=__PRIVATE_Operator.ut(n);if(o.ct()){if(u===__PRIVATE_Operator.ARRAY_CONTAINS||u===__PRIVATE_Operator.ARRAY_CONTAINS_ANY)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+u.toString()+"' queries on FieldPath.documentId().");if(u===__PRIVATE_Operator.IN){this.AP(r,u);for(var a=[],_=0,c=r;_<c.length;_++){var h=c[_];a.push(this.RP(h))}i=new ArrayValue(a)}else i=this.RP(r)}else u!==__PRIVATE_Operator.IN&&u!==__PRIVATE_Operator.ARRAY_CONTAINS_ANY||this.AP(r,u),i=this.firestore.YE.al("Query.where",r,u===__PRIVATE_Operator.IN);var f=FieldFilter.create(o,u,i);return this.IP(f),new t(this.PP.un(f),this.firestore,this.sP)},t.prototype.orderBy=function(e,n){var r;if(__PRIVATE_validateBetweenNumberOfArgs("Query.orderBy",arguments,1,2),__PRIVATE_validateOptionalArgType("Query.orderBy","non-empty string",2,n),void 0===n||"asc"===n)r=__PRIVATE_Direction.ASCENDING;else{if("desc"!==n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+n+"', expected 'asc' or 'desc'.");r=__PRIVATE_Direction.DESCENDING}if(null!==this.PP.startAt)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this.PP.endAt)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var i=__PRIVATE_fieldPathFromArgument("Query.orderBy",e),s=new __PRIVATE_OrderBy(i,r);return this.VP(s),new t(this.PP._n(s),this.firestore,this.sP)},t.prototype.limit=function(e){return __PRIVATE_validateExactNumberOfArgs("Query.limit",arguments,1),__PRIVATE_validateArgType("Query.limit","number",1,e),__PRIVATE_validatePositiveNumber("Query.limit",1,e),new t(this.PP.cn(e),this.firestore,this.sP)},t.prototype.limitToLast=function(e){return __PRIVATE_validateExactNumberOfArgs("Query.limitToLast",arguments,1),__PRIVATE_validateArgType("Query.limitToLast","number",1,e),__PRIVATE_validatePositiveNumber("Query.limitToLast",1,e),new t(this.PP.hn(e),this.firestore,this.sP)},t.prototype.startAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];__PRIVATE_validateAtLeastNumberOfArgs("Query.startAt",arguments,1);var i=this.mP("Query.startAt",e,n,!0);return new t(this.PP.fn(i),this.firestore,this.sP)},t.prototype.startAfter=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];__PRIVATE_validateAtLeastNumberOfArgs("Query.startAfter",arguments,1);var i=this.mP("Query.startAfter",e,n,!1);return new t(this.PP.fn(i),this.firestore,this.sP)},t.prototype.endBefore=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];__PRIVATE_validateAtLeastNumberOfArgs("Query.endBefore",arguments,1);var i=this.mP("Query.endBefore",e,n,!0);return new t(this.PP.ln(i),this.firestore,this.sP)},t.prototype.endAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];__PRIVATE_validateAtLeastNumberOfArgs("Query.endAt",arguments,1);var i=this.mP("Query.endAt",e,n,!1);return new t(this.PP.ln(i),this.firestore,this.sP)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw __PRIVATE_invalidClassError("isEqual","Query",1,e);return this.firestore===e.firestore&&this.PP.isEqual(e.PP)},t.prototype.withConverter=function(e){return new t(this.PP,this.firestore,e)},t.prototype.mP=function(t,e,n,r){if(__PRIVATE_validateDefined(t,1,e),e instanceof DocumentSnapshot){if(n.length>0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new FirestoreError(Code.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.vP(t,i.hP,r)}var s=[e].concat(n);return this.pP(t,s,r)},t.prototype.vP=function(t,e,n){for(var r=[],i=0,s=this.PP.orderBy;i<s.length;i++){var o=s[i];if(o.field.ct())r.push(new __PRIVATE_RefValue(this.firestore.qE,e.key));else{var u=e.field(o.field);if(u instanceof __PRIVATE_ServerTimestampValue)throw new FirestoreError(Code.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===u){var a=o.field.ot();throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+a+"' (used as the orderBy) does not exist.")}r.push(u)}}return new __PRIVATE_Bound(r,n)},t.prototype.pP=function(t,e,n){var r=this.PP.Je;if(e.length>r.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],s=0;s<e.length;s++){var o=e[s];if(r[s].field.ct()){if("string"!=typeof o)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof o);if(!this.PP.bn()&&-1!==o.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+o+"' contains a slash.");var u=this.PP.path.child(ResourcePath.ut(o));if(!__PRIVATE_DocumentKey.lt(u))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+u+"' is not because it contains an odd number of segments.");var a=new __PRIVATE_DocumentKey(u);i.push(new __PRIVATE_RefValue(this.firestore.qE,a))}else{var _=this.firestore.YE.al(t,o);i.push(_)}}return new __PRIVATE_Bound(i,n)},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];__PRIVATE_validateBetweenNumberOfArgs("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof t[i]||__PRIVATE_isPartialObserver(t[i])||(__PRIVATE_validateOptionNames("Query.onSnapshot",r=t[i],["includeMetadataChanges"]),__PRIVATE_validateNamedOptionalType("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),__PRIVATE_isPartialObserver(t[i])?n=t[i]:(__PRIVATE_validateArgType("Query.onSnapshot","function",i,t[i]),__PRIVATE_validateOptionalArgType("Query.onSnapshot","function",i+1,t[i+1]),__PRIVATE_validateOptionalArgType("Query.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.bP(this.PP),this._P(r,n)},t.prototype._P=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new __PRIVATE_AsyncObserver({next:function(t){e.next&&e.next(new QuerySnapshot(n.firestore,n.PP,t,n.sP))},error:r}),s=this.firestore.xE(),o=s.listen(this.PP,i,t);return function(){i.BE(),s.Zl(o)}},t.prototype.bP=function(t){if(t.vn()&&0===t.Je.length)throw new FirestoreError(Code.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")},t.prototype.get=function(t){var e=this;return __PRIVATE_validateBetweenNumberOfArgs("Query.get",arguments,0,1),__PRIVATE_validateGetOptions("Query.get",t),this.bP(this.PP),new Promise((function(n,r){t&&"cache"===t.source?e.firestore.xE().LE(e.PP).then((function(t){n(new QuerySnapshot(e.firestore,e.PP,t,e.sP))}),r):e.cP(n,r,t)}))},t.prototype.cP=function(t,e,n){var r=this._P({includeMetadataChanges:!0,VE:!0},{next:function(i){r(),i.metadata.fromCache&&n&&"server"===n.source?e(new FirestoreError(Code.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):t(i)},error:e})},t.prototype.RP=function(t){if("string"==typeof t){if(""===t)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this.PP.bn()&&-1!==t.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+t+"' contains a '/' character.");var e=this.PP.path.child(ResourcePath.ut(t));if(!__PRIVATE_DocumentKey.lt(e))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+e+"' is not because it has an odd number of segments ("+e.length+").");return new __PRIVATE_RefValue(this.firestore.qE,new __PRIVATE_DocumentKey(e))}if(t instanceof DocumentReference){var n=t;return new __PRIVATE_RefValue(this.firestore.qE,n.tP)}throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+__PRIVATE_valueDescription(t)+".")},t.prototype.AP=function(t,e){if(!Array.isArray(t)||0===t.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+e.toString()+"' filters.");if(t.length>10)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters support a maximum of 10 elements in the value array.");if(t.indexOf(null)>=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'null' in the value array.");if(t.filter((function(t){return Number.isNaN(t)})).length>0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'NaN' in the value array.")},t.prototype.IP=function(t){if(t instanceof FieldFilter){var e=[__PRIVATE_Operator.ARRAY_CONTAINS,__PRIVATE_Operator.ARRAY_CONTAINS_ANY],n=[__PRIVATE_Operator.IN,__PRIVATE_Operator.ARRAY_CONTAINS_ANY],r=e.indexOf(t.op)>=0,i=n.indexOf(t.op)>=0;if(t.an()){var s=this.PP.in();if(null!==s&&!s.isEqual(t.field))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+s.toString()+"' and '"+t.field.toString()+"'");var o=this.PP.sn();null!==o&&this.gP(t.field,o)}else if(i||r){var u=null;if(i&&(u=this.PP.pn(n)),null===u&&r&&(u=this.PP.pn(e)),null!=u)throw u===t.op?new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+t.op.toString()+"' filter."):new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You cannot use '"+t.op.toString()+"' filters with '"+u.toString()+"' filters.")}}},t.prototype.VP=function(t){if(null===this.PP.sn()){var e=this.PP.in();null!==e&&this.gP(e,t.field)}},t.prototype.gP=function(t,e){if(!e.isEqual(t))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},t}(),QuerySnapshot=function(){function t(t,e,n,r){this.rP=t,this.wP=e,this.yP=n,this.sP=r,this.SP=null,this.DP=null,this.metadata=new SnapshotMetadata(n.hasPendingWrites,n.fromCache)}return Object.defineProperty(t.prototype,"docs",{get:function(){var t=[];return this.forEach((function(e){return t.push(e)})),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return this.yP.docs.tt()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this.yP.docs.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t,e){var n=this;__PRIVATE_validateBetweenNumberOfArgs("QuerySnapshot.forEach",arguments,1,2),__PRIVATE_validateArgType("QuerySnapshot.forEach","function",1,t),this.yP.docs.forEach((function(r){t.call(e,n.CP(r))}))},Object.defineProperty(t.prototype,"query",{get:function(){return new Query$1(this.wP,this.rP,this.sP)},enumerable:!0,configurable:!0}),t.prototype.docChanges=function(t){t&&(__PRIVATE_validateOptionNames("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),__PRIVATE_validateNamedOptionalType("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var e=!(!t||!t.includeMetadataChanges);if(e&&this.yP.Xn)throw new FirestoreError(Code.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this.SP&&this.DP===e||(this.SP=__PRIVATE_changesFromSnapshot(this.rP,e,this.yP,this.sP),this.DP=e),this.SP},t.prototype.isEqual=function(e){if(!(e instanceof t))throw __PRIVATE_invalidClassError("isEqual","QuerySnapshot",1,e);return this.rP===e.rP&&this.wP.isEqual(e.wP)&&this.yP.isEqual(e.yP)&&this.sP===e.sP},t.prototype.CP=function(t){return new QueryDocumentSnapshot(this.rP,t.key,t,this.metadata.fromCache,this.yP.Hn.has(t.key),this.sP)},t}();function __PRIVATE_throwDocChangesMethodError(){throw new FirestoreError(Code.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}var __PRIVATE_docChangesPropertiesToOverride=tslib.__spreadArrays(["length","forEach","map"],"undefined"!=typeof Symbol?[Symbol.iterator]:[]);__PRIVATE_docChangesPropertiesToOverride.forEach((function(t){try{Object.defineProperty(QuerySnapshot.prototype.docChanges,t,{get:function(){return __PRIVATE_throwDocChangesMethodError()}})}catch(t){}}));var CollectionReference=function(t){function e(e,n,r){var i=t.call(this,Query.rn(e),n,r)||this;if(i.OP=e,e.length%2!=1)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+e.ot()+" has "+e.length);return i}return tslib.__extends(e,t),Object.defineProperty(e.prototype,"id",{get:function(){return this.PP.path.nt()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){var t=this.PP.path.Z();return t.tt()?null:new DocumentReference(new __PRIVATE_DocumentKey(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this.PP.path.ot()},enumerable:!0,configurable:!0}),e.prototype.doc=function(t){if(__PRIVATE_validateBetweenNumberOfArgs("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=__PRIVATE_AutoId.s()),__PRIVATE_validateArgType("CollectionReference.doc","non-empty string",1,t),""===t)throw new FirestoreError(Code.INVALID_ARGUMENT,"Document path must be a non-empty string");var e=ResourcePath.ut(t);return DocumentReference.eP(this.PP.path.child(e),this.firestore,this.sP)},e.prototype.add=function(t){__PRIVATE_validateExactNumberOfArgs("CollectionReference.add",arguments,1);var e=this.sP?this.sP.toFirestore(t):t;__PRIVATE_validateArgType("CollectionReference.add","object",1,e);var n=this.doc();return n.set(t).then((function(){return n}))},e.prototype.withConverter=function(t){return new e(this.OP,this.firestore,t)},e}(Query$1);function __PRIVATE_validateSetOptions(t,e){if(void 0===e)return{merge:!1};if(__PRIVATE_validateOptionNames(t,e,["merge","mergeFields"]),__PRIVATE_validateNamedOptionalType(t,"boolean","merge",e.merge),__PRIVATE_validateOptionalArrayElements(t,"mergeFields","a string or a FieldPath",e.mergeFields,(function(t){return"string"==typeof t||t instanceof FieldPath$1})),void 0!==e.mergeFields&&void 0!==e.merge)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function __PRIVATE_validateSnapshotOptions(t,e){return void 0===e?{}:(__PRIVATE_validateOptionNames(t,e,["serverTimestamps"]),__PRIVATE_validateNamedOptionalPropertyEquals(t,"options","serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function __PRIVATE_validateGetOptions(t,e){__PRIVATE_validateOptionalArgType(t,"object",1,e),e&&(__PRIVATE_validateOptionNames(t,e,["source"]),__PRIVATE_validateNamedOptionalPropertyEquals(t,"options","source",e.source,["default","server","cache"]))}function __PRIVATE_validateReference(t,e,n){if(e instanceof DocumentReference){if(e.firestore!==n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw __PRIVATE_invalidClassError(t,"DocumentReference",1,e)}function __PRIVATE_changesFromSnapshot(t,e,n,r){if(n.Yn.tt()){var i,s=0;return n.docChanges.map((function(e){var o=new QueryDocumentSnapshot(t,e.doc.key,e.doc,n.fromCache,n.Hn.has(e.doc.key),r);return assert(e.type===__PRIVATE_ChangeType.kn,"Invalid event type for first snapshot"),assert(!i||n.query.Pn(i,e.doc)<0,"Got added events in wrong order"),i=e.doc,{type:"added",doc:o,oldIndex:-1,newIndex:s++}}))}var o=n.Yn;return n.docChanges.filter((function(t){return e||t.type!==__PRIVATE_ChangeType.qn})).map((function(e){var i=new QueryDocumentSnapshot(t,e.doc.key,e.doc,n.fromCache,n.Hn.has(e.doc.key),r),s=-1,u=-1;return e.type!==__PRIVATE_ChangeType.kn&&(assert((s=o.indexOf(e.doc.key))>=0,"Index for document not found"),o=o.delete(e.doc.key)),e.type!==__PRIVATE_ChangeType.xn&&(u=(o=o.add(e.doc)).indexOf(e.doc.key)),{type:__PRIVATE_resultChangeType(e.type),doc:i,oldIndex:s,newIndex:u}}))}function __PRIVATE_resultChangeType(t){switch(t){case __PRIVATE_ChangeType.kn:return"added";case __PRIVATE_ChangeType.Kn:case __PRIVATE_ChangeType.qn:return"modified";case __PRIVATE_ChangeType.xn:return"removed";default:return fail("Unknown change type: "+t)}}function __PRIVATE_applyFirestoreDataConverter(t,e,n){var r;return t?(r=t.toFirestore(e),n="toFirestore() in "+n):r=e,[r,n]}var __PRIVATE_PublicFirestore=__PRIVATE_makeConstructorPrivate(Firestore,"Use firebase.firestore() instead."),__PRIVATE_PublicTransaction=__PRIVATE_makeConstructorPrivate(Transaction$1,"Use firebase.firestore().runTransaction() instead."),__PRIVATE_PublicWriteBatch=__PRIVATE_makeConstructorPrivate(WriteBatch,"Use firebase.firestore().batch() instead."),__PRIVATE_PublicDocumentReference=__PRIVATE_makeConstructorPrivate(DocumentReference,"Use firebase.firestore().doc() instead."),__PRIVATE_PublicDocumentSnapshot=__PRIVATE_makeConstructorPrivate(DocumentSnapshot),__PRIVATE_PublicQueryDocumentSnapshot=__PRIVATE_makeConstructorPrivate(QueryDocumentSnapshot),__PRIVATE_PublicQuery=__PRIVATE_makeConstructorPrivate(Query$1),__PRIVATE_PublicQuerySnapshot=__PRIVATE_makeConstructorPrivate(QuerySnapshot),__PRIVATE_PublicCollectionReference=__PRIVATE_makeConstructorPrivate(CollectionReference,"Use firebase.firestore().collection() instead."),__PRIVATE_firestoreNamespace={Firestore:__PRIVATE_PublicFirestore,GeoPoint:GeoPoint,Timestamp:Timestamp,Blob:__PRIVATE_PublicBlob,Transaction:__PRIVATE_PublicTransaction,WriteBatch:__PRIVATE_PublicWriteBatch,DocumentReference:__PRIVATE_PublicDocumentReference,DocumentSnapshot:__PRIVATE_PublicDocumentSnapshot,Query:__PRIVATE_PublicQuery,QueryDocumentSnapshot:__PRIVATE_PublicQueryDocumentSnapshot,QuerySnapshot:__PRIVATE_PublicQuerySnapshot,CollectionReference:__PRIVATE_PublicCollectionReference,FieldPath:FieldPath$1,FieldValue:__PRIVATE_PublicFieldValue,setLogLevel:Firestore.setLogLevel,CACHE_SIZE_UNLIMITED:CACHE_SIZE_UNLIMITED};function __PRIVATE_configureForFirebase(t){t.INTERNAL.registerComponent(new component.Component("firestore",(function(t){var e=t.getProvider("app").getImmediate();return new Firestore(e,t.getProvider("auth-internal"))}),"PUBLIC").setServiceProps(__PRIVATE_shallowCopy(__PRIVATE_firestoreNamespace)))}var __PRIVATE_NoopConnectivityMonitor=function(){function t(){}return t.prototype.Ml=function(t){},t.prototype.shutdown=function(){},t}(),__PRIVATE_StreamBridge=function(){function t(t){this.FP=t.FP,this.NP=t.NP}return t.prototype.vf=function(t){assert(!this.MP,"Called onOpen on stream twice!"),this.MP=t},t.prototype.Af=function(t){assert(!this.LP,"Called onClose on stream twice!"),this.LP=t},t.prototype.onMessage=function(t){assert(!this.GP,"Called onMessage on stream twice!"),this.GP=t},t.prototype.close=function(){this.NP()},t.prototype.send=function(t){this.FP(t)},t.prototype.BP=function(){assert(void 0!==this.MP,"Cannot call onOpen because no callback was set"),this.MP()},t.prototype.UP=function(t){assert(void 0!==this.LP,"Cannot call onClose because no callback was set"),this.LP(t)},t.prototype.kP=function(t){assert(void 0!==this.GP,"Cannot call onMessage because no callback was set"),this.GP(t)},t}();function __PRIVATE_nodePromise(t){return new Promise((function(e,n){t((function(t,r){t?n(t):e(r)}))}))}var SDK_VERSION$1=firebase.SDK_VERSION,__PRIVATE_grpcVersion=require("grpc/package.json").version,__PRIVATE_LOG_TAG$c="Connection",__PRIVATE_X_GOOG_API_CLIENT_VALUE="gl-node/"+process.versions.node+" fire/"+SDK_VERSION$1+" grpc/"+__PRIVATE_grpcVersion;function __PRIVATE_createMetadata(t,e){assert(null===e||"OAuth"===e.type,"If provided, token must be OAuth");var n=new __PRIVATE_grpc.qn;if(e)for(var r in e.v)e.v.hasOwnProperty(r)&&n.set(r,e.v[r]);return n.set("x-goog-api-client",__PRIVATE_X_GOOG_API_CLIENT_VALUE),n.set("google-cloud-resource-prefix","projects/"+t.o.projectId+"/databases/"+t.o.database),n}var __PRIVATE_GrpcConnection=function(){function t(t,e){this.mE=e,this.xP=null,this.firestore=t.google.firestore.v1}return t.prototype.KP=function(){if(!this.xP){debug(__PRIVATE_LOG_TAG$c,"Creating Firestore stub.");var t=this.mE.ssl?__PRIVATE_grpc.credentials.qP():__PRIVATE_grpc.credentials.jP();this.xP=new this.firestore.Firestore(this.mE.host,t)}return this.xP},t.prototype.Mf=function(t,e,n){var r=this.KP(),i=__PRIVATE_createMetadata(this.mE,n);return __PRIVATE_nodePromise((function(n){return debug(__PRIVATE_LOG_TAG$c,"RPC '"+t+"' invoked with request:",e),r[t](e,i,(function(e,r){e?(debug(__PRIVATE_LOG_TAG$c,"RPC '"+t+"' failed with error:",e),n(new FirestoreError(__PRIVATE_mapCodeFromRpcCode(e.code),e.message))):(debug(__PRIVATE_LOG_TAG$c,"RPC '"+t+"' completed with response:",r),n(void 0,r))}))}))},t.prototype.Lf=function(t,e,n){var r=[],i=new __PRIVATE_Deferred;debug(__PRIVATE_LOG_TAG$c,"RPC '"+t+"' invoked (streaming) with request:",e);var s=this.KP(),o=__PRIVATE_createMetadata(this.mE,n),u=s[t](e,o);return u.on("data",(function(e){debug(__PRIVATE_LOG_TAG$c,"RPC "+t+" received result:",e),r.push(e)})),u.on("end",(function(){debug(__PRIVATE_LOG_TAG$c,"RPC '"+t+"' completed."),i.resolve(r)})),u.on("error",(function(e){debug(__PRIVATE_LOG_TAG$c,"RPC '"+t+"' failed with error:",e);var n=__PRIVATE_mapCodeFromRpcCode(e.code);i.reject(new FirestoreError(n,e.message))})),i.promise},t.prototype.pf=function(t,e){var n=this.KP(),r=__PRIVATE_createMetadata(this.mE,e),i=n[t](r),s=!1,o=function(t){s||(s=!0,u.UP(t),i.end())},u=new __PRIVATE_StreamBridge({FP:function(t){if(s)debug(__PRIVATE_LOG_TAG$c,"Not sending because gRPC stream is closed:",t);else{debug(__PRIVATE_LOG_TAG$c,"GRPC stream sending:",t);try{i.write(t)}catch(e){throw error("Failure sending:",t),error("Error:",e),e}}},NP:function(){debug(__PRIVATE_LOG_TAG$c,"GRPC stream closed locally via close()."),o()}});return i.on("data",(function(t){s||(debug(__PRIVATE_LOG_TAG$c,"GRPC stream received:",t),u.kP(t))})),i.on("end",(function(){debug(__PRIVATE_LOG_TAG$c,"GRPC stream ended."),o()})),i.on("error",(function(t){debug(__PRIVATE_LOG_TAG$c,"GRPC stream error. Code:",t.code,"Message:",t.message);var e=__PRIVATE_mapCodeFromRpcCode(t.code);o(new FirestoreError(e,t.message))})),debug(__PRIVATE_LOG_TAG$c,"Opening GRPC stream"),setTimeout((function(){u.BP()}),0),u},t}(),__PRIVATE_protoLoaderOptions={QP:String,WP:String,$P:!0,YP:!1};function __PRIVATE_loadProtos(){var t=path.resolve(__dirname,process.env.__PRIVATE_FIRESTORE_PROTO_ROOT||"../protos"),e=path.join(t,"google/firestore/v1/firestore.proto"),n=__PRIVATE_protoLoader.HP(e,tslib.__assign(tslib.__assign({},__PRIVATE_protoLoaderOptions),{zP:[t]}));return __PRIVATE_grpc.XP(n)}var __PRIVATE_NodePlatform=function(){function t(){this.ds=!0,this.Jr=new Uint8Array(0),this.document=null}return Object.defineProperty(t.prototype,"window",{get:function(){return"YES"===process.env.tu?window:null},enumerable:!0,configurable:!0}),t.prototype.SE=function(t){var e=__PRIVATE_loadProtos();return Promise.resolve(new __PRIVATE_GrpcConnection(e,t))},t.prototype.CE=function(){return new __PRIVATE_NoopConnectivityMonitor},t.prototype.OE=function(t){return new __PRIVATE_JsonProtoSerializer(t,{Zr:!1})},t.prototype.i=function(t){return __PRIVATE_util.inspect(t,{depth:100})},t.prototype.atob=function(t){if(/[^-A-Za-z0-9+/=]/.test(t))throw new FirestoreError(Code.INVALID_ARGUMENT,"Not a valid Base64 string: "+t);return new Buffer(t,"base64").toString("binary")},t.prototype.btoa=function(t){return new Buffer(t,"binary").toString("base64")},t}();__PRIVATE_PlatformSupport.Ts(new __PRIVATE_NodePlatform);var name="@firebase/firestore",version="1.11.0";function __PRIVATE_registerFirestore(t){__PRIVATE_configureForFirebase(t),t.registerVersion(name,version,"node")}__PRIVATE_registerFirestore(firebase),exports.__PRIVATE_registerFirestore=__PRIVATE_registerFirestore;
//# sourceMappingURL=index.node.cjs.js.map
